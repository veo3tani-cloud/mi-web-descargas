<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descargar Ultima Version</title>
    
    <!-- ================================================================== -->
    <!-- ğŸ›¡ï¸ ESCUDO ANTI-FALLOS (ESTILOS DE EMERGENCIA) ğŸ›¡ï¸                  -->
    <!-- Esto evita que se vean estrellas gigantes si los anuncios bloquean Tailwind -->
    <!-- ================================================================== -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Forzar tamaÃ±o pequeÃ±o para iconos si falla la carga */
        svg { width: 24px; height: 24px; max-width: 100%; display: inline-block; }
        
        /* Forzar ocultamiento de elementos hidden */
        .hidden { display: none !important; }
        
        /* Prevenir desbordamiento de imÃ¡genes */
        img { max-width: 100%; height: auto; }

        /* Fuente base por seguridad */
        body { font-family: sans-serif; background-color: #f8fafc; margin: 0; }
        
        /* Asegurar tamaÃ±o del logo */
        .logo { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; }
    </style>
    <!-- ================================================================== -->

    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="description" content="Descarga las Ãºltimas versiones de tu software favorito. Adobe, 3ds Max, Blender, Office y mÃ¡s. Versiones full y actualizadas.">
    <meta name="keywords" content="descargar, software, ultima version, full, adobe, blender, office, photoshop, premiere">
    <meta name="author" content="Descargar Ultima Version">
    <meta property="og:title" content="Descargar Ãšltima VersiÃ³n">
    <meta property="og:description" content="Descarga las Ãºltimas versiones de tu software favorito. Adobe, 3ds Max, Blender, Office y mÃ¡s.">
    <meta property="og:image" content="https://descargarultimaversion.netlify.app/imagen-preview.jpg">
    <meta property="og:url" content="https://descargarultimaversion.netlify.app/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Descargar Ãšltima VersiÃ³n">
    <meta name="twitter:description" content="Descarga las Ãºltimas versiones de tu software favorito. Adobe, 3ds Max, Blender, Office y mÃ¡s.">
    <meta name="twitter:image" content="https://descargarultimaversion.netlify.app/imagen-preview.jpg">
    
    <!-- Bloque SEO MultilingÃ¼e (hreflang) -->
    <link rel="alternate" hreflang="es" href="https://descargarultimaversion.netlify.app/" />
    <link rel="alternate" hreflang="x-default" href="https://descargarultimaversion.netlify.app/" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .logo { width: 48px; height: 48px; background: linear-gradient(135deg, #38bdf8, #3b82f6); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 28px; transform: rotate(-15deg); }
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 1rem; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 90%; width: 600px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); position: relative; margin: auto; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-top: 1rem; border-radius: 8px; }
        .modal-video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        .nav-link.active { color: #2563eb; }
        
        /* --- ESTILOS DEL MENÃš --- */
        .dropdown { display: none; position: absolute; background-color: white; min-width: 220px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1); z-index: 100; border-radius: 0.5rem; border: 1px solid #e5e7eb; opacity: 0; transform: translateY(-10px); transition: opacity 150ms ease-in-out, transform 150ms ease-in-out; }
        .group:hover .dropdown { display: block; opacity: 1; transform: translateY(0); }
        .dropdown.open { display: block; opacity: 1; transform: translateY(0); }
        .dropdown-item { display: block; padding: 12px 16px; }
        .dropdown-item:hover { background-color: #f1f1f1; }
        .sub-dropdown { display: none; position: absolute; left: 100%; top: -1px; background-color: white; min-width: 220px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1); z-index: 101; border-radius: 0.5rem; border: 1px solid #e5e7eb; }
        .group-submenu:hover .sub-dropdown { display: block; }
        
        .yape-modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 90%; width: 350px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); position: relative; text-align: center; }
        .tab-button { padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 600; border-bottom-width: 3px; transition: all 0.2s ease-in-out; }
        @media (min-width: 640px) { .tab-button { padding: 1rem 1.5rem; font-size: 1rem; } }
        .comments-modal-content { background: white; padding: 1.5rem; border-radius: 12px; max-width: 90%; width: 700px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); position: relative; margin: auto; max-height: 90vh; display: flex; flex-direction: column; }
        #comments-list { max-height: 40vh; overflow-y: auto; padding-right: 1rem; margin-bottom: 1rem; }
        .comment { background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem; }
        .comment.admin-comment { background-color: #f0f9ff; border: 1px solid #bae6fd; }
        .like-btn { background-color: #f1f5f9; color: #64748b; }
        .like-btn.liked { background-color: #fecaca; color: #dc2626; }
        @keyframes highlight-card { 0% { background-color: #ffffff; transform: scale(1); } 50% { background-color: #dbeafe; transform: scale(1.03); } 100% { background-color: #ffffff; transform: scale(1); } }
        .card-highlight { animation: highlight-card 1.5s ease-in-out; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: .7; transform: scale(1.05); } }

        /* Banner fijo solo en mÃ³viles */
        @media (max-width: 768px) {
            #mobile-ad-top {
                position: fixed; top: 0; left: 0; width: 100%; height: 60px; display: flex; justify-content: center; align-items: center; background: #fff; z-index: 9999; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            body { padding-top: 60px; }
        }
        
        #google_translate_element_wrapper { position: fixed; bottom: 15px; right: 15px; z-index: 1001; }
        #google_translate_element { padding: 5px; background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        body { top: 0 !important; }
        .skiptranslate { display: none !important; }

        /* Chat IA */
        #ai-chat-modal { z-index: 2000; }
        #ai-chat-content { width: 90%; max-width: 500px; height: 70vh; max-height: 600px; margin: auto; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.open #ai-chat-content { transform: scale(1); }
        #ai-chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; }
        .ai-chat-bubble { max-width: 80%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.5rem; word-wrap: break-word; line-height: 1.5; }
        .ai-chat-bubble.user { background-color: #3b82f6; color: white; border-bottom-right-radius: 0.25rem; align-self: flex-end; margin-left: auto; }
        .ai-chat-bubble.ai { background-color: #e5e7eb; color: #1f2937; border-bottom-left-radius: 0.25rem; align-self: flex-start; margin-right: auto; }
        .typing-dot { height: 8px; width: 8px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: typing 1.4s infinite both; }
        .typing-dot:nth-child(1) { animation-delay: 0s; } .typing-dot:nth-child(2) { animation-delay: 0.2s; } .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0% { opacity: 0.2; transform: scale(0.8); } 20% { opacity: 1; transform: scale(1); } 100% { opacity: 0.2; transform: scale(0.8); } }

        /* Pedidos */
        .request-board-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 0.75rem; }
        .vote-btn { background-color: #f1f5f9; color: #64748b; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.25rem; }
        .vote-btn:hover { background-color: #e2e8f0; }
        .vote-btn.voted { background-color: #dbeafe; color: #2563eb; border: 1px solid #93c5fd; }
        .request-text { font-size: 0.875rem; color: #334155; word-wrap: break-word; flex-grow: 1; margin-right: 1rem; line-height: 1.5; }
        .request-text strong { font-weight: 600; color: #1e293b; }
        .request-text span { font-size: 0.75rem; color: #64748b; display: block; margin-top: 0.25rem; }
    </style>
</head>

<body class="text-slate-800 flex flex-col min-h-screen">
<!-- Banner flotante superior solo para mÃ³viles -->
    <div id="mobile-ad-top" class="hidden md:hidden">
      <div id="adsterra-mobile">
<script type="text/javascript">
	atOptions = {
		'key' : '8bc9527f0527b1ea5f2e3fc1efd1083d',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//honeywhyvowel.com/8bc9527f0527b1ea5f2e3fc1efd1083d/invoke.js"></script>
      </div>
    </div>
<!-- Fin del banner mÃ³vil -->
    
    <div id="app" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-6 pb-4 border-b border-slate-200">
                <div class="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
                    <div class="flex items-center gap-4">
                        <div class="logo">D</div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-slate-900">Descargar Ultima Version</h1>
                    </div>
                    <!-- ===== BOTÃ“N 'CÃ“MO DESCARGAR' ACTUALIZADO ===== -->
                    <button id="how-to-download-btn" class="flex items-center gap-2 text-yellow-800 hover:text-yellow-900 font-bold mt-2 sm:mt-0 px-4 py-2 bg-yellow-300 rounded-full transition-colors hover:bg-yellow-400 animate-pulse shadow-md">
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1  1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                        Â¿CÃ³mo descargar? (Video)
                    </button>
                    <!-- ===== FIN DEL BOTÃ“N ACTUALIZADO ===== -->
                </div>

                <!-- ===== NUEVO BOTÃ“N DE ASISTENTE DE IA ===== -->
                <div class="relative w-full sm:max-w-md">
                    <button id="open-ai-chat-btn" class="w-full flex items-center justify-center gap-3 px-4 py-2.5 border border-transparent rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold shadow-lg hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-blue-400 transition-all duration-300 ease-out transform hover:scale-105 text-sm">
                        <svg class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                        IA-Lahs dice: Cliquea aqui y dime que estas buscando
                    </button>
                </div>
                <!-- ===== FIN DEL NUEVO BOTÃ“N ===== -->

            </div>
        </header>
        
        <!-- Mensaje de bienvenida -->
        <div class="mt-4 mb-6 bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
          <p class="text-slate-800 dark:text-slate-100 text-base leading-relaxed text-center">
            ğŸ‘‹ <strong>Bienvenido a Descargar Ãšltima VersiÃ³n</strong><br>
            AquÃ­ reunimos las <strong>apps y juegos que realmente funcionan</strong>.  
            Cada archivo ha sido <strong>probado, verificado y elegido a mano</strong> para ahorrarte tiempo, frustraciones y enlaces rotos.  
            Solo publicamos lo que <strong>pasa nuestros filtros de seguridad y rendimiento</strong>,  
            asÃ­ puedes descargar con total confianza. ğŸš€
          </p>
        </div>
        <!-- Fin del mensaje de bienvenida -->

        <!-- (MODIFICADO) El nav se genera dinÃ¡micamente -->
        <nav id="nav-container" class="mb-8 p-4 bg-white rounded-xl shadow-sm border border-slate-200 sticky top-4 z-50">
            <p class="text-slate-500 text-sm text-center">Cargando categorÃ­as...</p>
        </nav>
        
        <!-- ===== SECCIÃ“N 'LO MÃS DESCARGADO' CON BANNER DE PC ===== -->
        <div id="top-downloads-container" class="mb-8 p-6 bg-white rounded-xl shadow-sm border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                <!-- TÃ­tulo -->
                <h2 class="text-2xl font-bold text-slate-900 flex-shrink-0 flex items-center gap-2">
                    <svg class="h-6 w-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.2 3.31a.75.75 0 00-1.4 0l-1.11 4.331a.75.75 0 01-.692.518l-4.502.39a.75.75 0 00-.434 1.336l3.41 2.812a.75.75 0 01.248.746l-1.03 4.41a.75.75 0 001.12.825l3.854-2.26a.75.75 0 01.762 0l3.854 2.26a.75.75 0 001.12-.825l-1.03-4.41a.75.75 0 01.248-.746l3.41-2.812a.75.75 0 00-.434-1.336l-4.502-.39a.75.75 0 01-.692-.518L11.2 3.31z" clip-rule="evenodd"></path></svg>
                    ğŸ”¥ Lo MÃ¡s Descargado
                </h2>
<!-- Banner Adsterra (Solo PC) - Dentro de secciÃ³n Lo MÃ¡s Descargado -->
<div class="hidden md:flex justify-center items-center w-full max-w-[728px] mx-auto">
 <script type="text/javascript">
	atOptions = {
		'key' : 'a09ade7f1de75ea02cb1d7597a7a2ae6',
		'format' : 'iframe',
		'height' : 90,
		'width' : 728,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//honeywhyvowel.com/a09ade7f1de75ea02cb1d7597a7a2ae6/invoke.js"></script>
</div>
</div>
            <!-- Lista de descargas -->
            <div id="top-downloads-list" class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-4 mt-5">
                <p class="text-slate-500 text-sm">Cargando ranking...</p>
            </div>
        </div>
        <!-- ===== FIN DE SECCIÃ“N 'LO MÃS DESCARGADO' ===== -->
        
        <div class="mb-6 sm:mb-8">
            <!-- ===== PESTAÃ‘AS MEJORADAS ===== -->
            <div class="flex flex-wrap border-b border-slate-300 bg-white rounded-t-xl overflow-hidden shadow-sm">
              <button id="tab-pc"
                class="tab-button flex-1 text-blue-700 bg-blue-100 border-b-4 border-blue-600 font-semibold py-3 hover:bg-blue-200 transition-all duration-200 active-tab">
                ğŸ–¥ï¸ Descargas para PC
              </button>
              <button id="tab-mobile"
                class="tab-button flex-1 text-slate-500 bg-slate-100 border-b-4 border-transparent font-semibold py-3 hover:bg-slate-200 transition-all duration-200">
                ğŸ“± Descargas para MÃ³vil
              </button>
            </div>
            <!-- ===== FIN PESTAÃ‘AS MEJORADAS ===== -->
        </div>

        <main class="w-full">
            <div id="content-pc" class="tab-content">
                <h2 class="text-2xl sm:text-3xl font-bold text-blue-700 mb-6">Descargas para PC</h2>
                <div id="content-grid-pc" class="card-container">
                    <!-- (MODIFICADO) Contenido dinÃ¡mico -->
                    <p class="text-slate-500 text-sm">Cargando software...</p>
                </div>
                <div id="no-results-pc" class="hidden text-center py-16">
                    <h2 class="text-2xl font-semibold text-slate-700">No se encontraron resultados</h2>
                    <p class="mt-2 text-slate-500">Intenta ajustar tu bÃºsqueda o filtro.</p>
                </div>
            </div>
            <div id="content-mobile" class="tab-content hidden">
                <h2 class="text-2xl sm:text-3xl font-bold text-green-700 mb-6">Descargas para MÃ³vil</h2>
                <div id="content-grid-mobile" class="card-container">
                    <!-- (MODIFICADO) Contenido dinÃ¡mico -->
                    <p class="text-slate-500 text-sm">Cargando software...</p>
                </div>
                <div id="no-results-mobile" class="hidden text-center py-16">
                    <h2 class="text-2xl font-semibold text-slate-700">No se encontraron resultados</h2>
                    <p class="mt-2 text-slate-500">Intenta ajustar tu bÃºsqueda o filtro.</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- ===== MODAL: 'CÃ“MO DESCARGAR' ===== -->
    <div id="how-to-download-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="absolute top-4 right-4 text-slate-500 hover:text-slate-800" onclick="document.getElementById('how-to-download-modal').classList.remove('open');">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-xl font-bold text-slate-900 mb-2">Â¡Importante antes de descargar!</h2>
            <p class="text-slate-700">Yo te brindo gratis la descarga, pero colabÃ³rame con unos clics. Â¡Al final de esos clics encontrarÃ¡s tu descarga!</p>
            <div class="modal-video-container">
                <!-- ===== ID DE VIDEO ACTUALIZADO (Zs-1k7F0_vE) ===== -->
                <iframe src="https://www.youtube.com/embed/Zs-1k7F0_vE?autoplay=0&controls=1&showinfo=0&rel=0" frameborder="0" allowfullscreen></iframe>
            </div>
            <p class="text-sm text-slate-500 mt-4">Este video te guiarÃ¡ a travÃ©s del proceso de colaboraciÃ³n para obtener tu descarga.</p>
        </div>
    </div>
    
    <!-- ===== MODAL: DONAR CON YAPE ===== -->
    <div id="yape-modal" class="modal-overlay">
        <div class="yape-modal-content">
            <button id="yape-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-xl font-bold text-slate-900 mb-4">Donar con Yape</h2>
            <p class="text-slate-600 text-sm mb-4">Â¡Gracias por tu apoyo! Escanea este cÃ³digo QR desde tu app Yape.</p>
            <img src="imagenes/yape.jpeg" alt="CÃ³digo QR de Yape" class="w-48 h-48 mx-auto rounded-lg border border-slate-200 mb-6" onerror="this.onerror=null;this.src='https://placehold.co/192x192/e2e8f0/94a3b8?text=Error+cargando+QR'; this.alt='Error al cargar QR de Yape';">
            <button id="open-yape-btn" class="w-full bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-purple-700 transition-colors">
                Abrir Yape (solo mÃ³vil)
            </button>
        </div>
    </div>
    
    <!-- ===== MODAL: COMENTARIOS (LEGACY) ===== -->
    <div id="comments-modal" class="modal-overlay">
        <div class="comments-modal-content">
            <button id="comments-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-xl font-bold text-slate-900 mb-4" id="comments-modal-title">Comentarios</h2>
            <div id="comments-list" class="flex-grow">
                <p class="text-slate-500 text-sm">Cargando comentarios...</p>
            </div>
            <div class="mt-4 pt-4 border-t border-slate-200">
                <textarea id="comment-input" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Escribe tu comentario, pide un software o ayuda a otros..."></textarea>
                <button id="submit-comment-btn" class="mt-3 w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                    Enviar Comentario
                </button>
            </div>
        </div>
    </div>
    
    <!-- ===== MODAL: GUÃA INTERMEDIA (MÃ“VIL) ===== -->
    <div id="download-guide-modal" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <button id="download-guide-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="flex items-center mb-4">
                <span class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                    <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </span>
                <h2 class="ml-4 text-xl sm:text-2xl font-bold text-slate-900">GUÃA RÃPIDA (MÃ“VIL)</h2>
            </div>
            <p class="text-slate-700 text-base sm:text-lg mb-5">Para mantener el sitio gratuito, nuestro socio (<code class="font-mono text-sm">exe.io</code>) te mostrarÃ¡ anuncios. Â¡Tu celular intentarÃ¡ protegerte! <strong class="text-slate-900">Sigue esta guÃ­a de 3 pasos al pie de la letra</strong>:</p>
            
            <ul class="space-y-5 text-slate-700">
                <li class="flex items-start">
                    <span class="font-bold text-red-500 text-2xl mr-3">1.</span>
                    <div>
                        <strong class="text-red-600 text-lg">SI VES EL MURO "ADBLOCK"</strong><br>
                        <span class="inline-block my-2 bg-orange-500 text-white font-mono px-2 py-1 rounded text-sm shadow-md">Por favor, desactive Adblock...</span>
                        <br>
                        <span class="text-base">Es tu navegador (Chrome/Brave) bloqueando.</span>
                        <br>
                        <strong class="text-blue-600 text-base">SoluciÃ³n:</strong> Ve a (â‹®) -> ConfiguraciÃ³n -> ConfiguraciÃ³n de sitios -> <strong class="text-blue-600">Anuncios intrusivos</strong> y <strong class="text-blue-600">Ventanas emergentes</strong> -> Ponlos en <strong class="text-blue-600">"Permitir"</strong>.
                    </div>
                </li>
                <li class="flex items-start">
                    <span class="font-bold text-blue-500 text-2xl mr-3">2.</span>
                    <div>
                        <strong class="text-blue-600 text-lg">LA GUÃA DE CLICS</strong><br>
                        <span class="text-base">Se abrirÃ¡n pestaÃ±as de anuncios. Solo usa el botÃ³n <strong class="text-blue-600">"AtrÃ¡s" (â†¶)</strong> de tu celular, vuelve a la pestaÃ±a anterior y sigue intentando.</span>
                        <div class="my-2 p-2 bg-blue-600 border border-blue-700 rounded-md text-white font-mono text-sm text-center shadow-md">
                            continue --> (Presiona, vuelve, presiona)
                        </div>
                        <span class="text-base">Hazlo hasta que cambie a:</span>
                        <div class="my-2 p-2 bg-blue-600 border border-blue-700 rounded-md text-white font-mono text-sm text-center shadow-md">
                            I am not a robot
                        </div>
                    </div>
                </li>
                <li class="flex items-start">
                    <span class="font-bold text-green-500 text-2xl mr-3">3.</span>
                    <div>
                        <strong class="text-green-600 text-lg">EL FINAL</strong><br>
                        <span class="text-base">Completa el captcha y espera el contador a cero (0). El botÃ³n final es <code class="bg-gray-200 p-1 rounded">Get Link</code>. Â¡AhÃ­ estÃ¡ tu descarga!</span>
                    </div>
                </li>
            </ul>

            <button id="download-guide-continue-btn" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors text-lg">
                Â¡Entendido, llÃ©vame allÃ­!
            </button>
        </div>
    </div>
    <!-- ===== FIN GUÃA INTERMEDIA ===== -->

    <!-- ===== MODAL: CHAT DE IA ===== -->
    <div id="ai-chat-modal" class="modal-overlay">
        <div id="ai-chat-content" class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <!-- Cabecera del Chat con Saludo -->
            <div class="flex items-center justify-between p-4 border-b border-slate-200 bg-slate-50">
                <div>
                    <!-- Saludo dinÃ¡mico -->
                    <h2 id="ai-chat-greeting" class="text-lg font-bold text-slate-900">Â¡Hola! ğŸ‘‹</h2>
                    <p id="ai-chat-subgreeting" class="text-sm text-slate-600">Inicia sesiÃ³n para una mejor experiencia.</p>
                </div>
                <!-- NUEVO BotÃ³n de Altavoz -->
                <button id="ai-speaker-toggle" class="p-2 rounded-full text-slate-600 hover:bg-slate-200 transition-colors">
                    <!-- Icono ON -->
                    <svg id="speaker-on" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M10 21v-7m0 0V3m0 0a2 2 0 100 4v0m0-4a2 2 0 010 4v0m7.536-1.464a9 9 0 010 12.728M10 3H7a2 2 0 00-2 2v14a2 2 0 002 2h3m0-18v18"></path></svg>
                    <!-- Icono OFF -->
                    <svg id="speaker-off" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15.1l-2.829 2.829a1 1 0 01-1.414-1.414L15.9 2.8A1 1 0 0117.3 4.2l-2.8 2.8m0 0a5 5 0 01-7.072 0M10 21v-7m0 0V3m0 0a2 2 0 100 4v0m0-4a2 2 0 010 4v0m7.536-1.464a9 9 0 010 12.728M10 3H7a2 2 0 00-2 2v14a2 2 0 002 2h3m0-18v18"></path></svg>
                </button>
                <button id="ai-chat-modal-close" class="text-slate-500 hover:text-slate-800">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Mensajes -->
            <div id="ai-chat-messages" class="flex-grow flex flex-col p-4 space-y-2 overflow-y-auto bg-white">
                <!-- Mensaje de bienvenida de la IA -->
                <div class="ai-chat-bubble ai">
                    Â¡Hola! ğŸ‘‹ Soy IA-Lahs, tu asistente. Â¿En quÃ© puedo ayudarte hoy? Puedes preguntarme por software, cÃ³mo descargar, o cualquier otra duda sobre el sitio.
                </div>
                <!-- Los mensajes dinÃ¡micos se aÃ±adirÃ¡n aquÃ­ -->
            </div>

            <!-- Input del Chat -->
            <div class="p-4 border-t border-slate-200 bg-slate-50">
                <div id="ai-chat-error" class="hidden text-sm text-red-600 bg-red-100 p-3 rounded-lg mb-3"></div>
                <form id="ai-chat-form" class="flex items-center gap-3">
                    <input type="text" id="ai-chat-input" placeholder="Escribe tu mensaje..." class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" autocomplete="off">
                    <!-- NUEVO BotÃ³n de MicrÃ³fono -->
                    <button type="button" id="ai-chat-mic" class="p-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors shadow-sm flex-shrink-0">
                        <!-- Icono normal -->
                        <svg id="mic-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                        <!-- Icono "escuchando" (punto rojo pulsante) -->
                        <svg id="mic-listening" class="h-6 w-6 text-red-500 hidden" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="10" class="animate-pulse"></circle>
                        </svg>
                    </button>
                    <button type="submit" id="ai-chat-submit" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm flex-shrink-0">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
    <!-- ===== FIN MODAL CHAT DE IA ===== -->


    <footer class="bg-slate-100 border-t border-slate-200 w-full">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 text-center">
            <h2 class="text-2xl font-bold text-slate-900">Un Proyecto Hecho para Ti</h2>
            <p class="mt-4 max-w-3xl mx-auto text-slate-700 leading-relaxed">
                Â¡Gracias por ser parte de esta comunidad!
                <br><br>
                Nuestra misiÃ³n es simple: darte acceso a lo que necesitas, actualizado y funcionando. Pero mantener esta web (los servidores, los enlaces y el tiempo que invertimos buscando) tiene un costo real.
                <br><br>
                Por eso, te ofrecemos <strong class="text-slate-900">dos caminos</strong> para descargar. Ambos nos ayudan a seguir adelante:
            </p>
            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-bold text-slate-800">1. La VÃ­a Gratuita</h3>
                    <p class="text-sm text-slate-600 mt-2">(Apoyo con tu Tiempo)</p>
                    <p class="mt-3 text-slate-700">Usa el botÃ³n de descarga normal. TendrÃ¡s que pasar por unos acortadores (`exe.io`). Esos clics, aunque parezcan poco, son los que pagan el servidor y nos permiten seguir aquÃ­.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-lg font-bold text-slate-800">2. La VÃ­a Directa</h3>
                    <p class="text-sm text-slate-600 mt-2">(Apoyo Premium â˜•)</p>
                    <p class="mt-3 text-slate-700">Â¿Valoras tu tiempo y prefieres evitar anuncios? Con una pequeÃ±a donaciÃ³n (tu voluntad), obtienes un <strong class="font-bold">enlace de descarga directo</strong>, limpio y sin esperas.</p>
                </div>
            </div>
            <p class="mt-8 max-w-3xl mx-auto text-slate-700 leading-relaxed">
                Tu apoyo, en cualquier forma, es lo que hace esto posible.
                <br>
                <strong class="text-slate-900">Â¡Elige el camino que prefieras para la VÃ­a Directa!</strong>
            </p>
            <div class="mt-8 flex flex-wrap justify-center items-center gap-4">
                <button id="yape-modal-open" class="bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-purple-700 transition-colors flex items-center gap-2">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 4.25A2.25 2.25 0 015.25 2h3.5A2.25 2.25 0 0111 4.25v3.5A2.25 2.25 0 018.75 10h-3.5A2.25 2.25 0 013 7.75v-3.5zM5.25 3.5a.75.75 0 00-.75.75v3.5c0 .414.336.75.75.75h3.5a.75.75 0 00.75-.75v-3.5a.75.75 0 00-.75-.75h-3.5zM3 12.25A2.25 2.25 0 015.25 10h3.5A2.25 2.25 0 0111 12.25v3.5A2.25 2.25 0 018.75 18h-3.5A2.25 2.25 0 013 15.75v-3.5zM5.25 11.5a.75.75 0 00-.75.75v3.5c0 .414.336.75.75.75h3.5a.75.75 0 00.75-.75v-3.5a.75.75 0 00-.75-.75h-3.5zM12.25 3A2.25 2.25 0 0114.5 5.25v3.5A2.25 2.25 0 0112.25 11h-3.5A2.25 2.25 0 016.5 8.75v-3.5A2.25 2.25 0 018.75 3h3.5zM14.5 6.5a.75.75 0 00.75-.75v-3.5a.75.75 0 00-.75-.75h-3.5a.75.75 0 00-.75.75v3.5c0 .414.336.75.75.75h3.5zM11.5 12.25c0-.414.336-.75.75-.75h3.5a.75.75 0 01.75.75v3.5a.75.75 0 01-.75.75h-3.5a.75.75 0 01-.75-.75v-3.5z" clip-rule="evenodd" /></svg>
                    Donar con Yape
                </button>
                <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=lahsvergon_23%40hotmail.com&item_name=Apoyo+para+el+sitio+web+de+descargas&currency_code=USD" target="_blank" class="bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M11.354 5.333H7.135L5.75 15.333h3.328l.583-3.958c.24-.958.834-1.166 1.5-1.166.458 0 .833.084 1.167.25l.25-1.542a4.845 4.845 0 00-2.333-.584zm5.562 0h-2.25l-1.375 9.167c0 .666.292 1 .875 1 .5 0 1-.25 1.417-.833l.416 1.333c-.416.334-.916.5-1.5.5-1.5 0-2.5-1-2.083-2.917l1.333-8.25zm5.084-2.333H4.167c-.417 0-.75.333-.75.75l-2.083 13.5c0 .416.333.75.75.75h14.833c.417 0 .75-.334.75-.75l2.083-13.5c0-.417-.333-.75-.75-.75z" /></svg>
                    Donar con PayPal
                </a>
            </div>
            <div class="mt-6">
                <a href="https://wa.me/51924814457?text=%C2%A1Hola!%20Acabo%20de%20hacer%20una%20donaci%C3%B3n.%20Me%20gustar%C3%ADa%20recibir%20el%20enlace%20de%20descarga%20directa%20para%20este%20software%3A%20" target="_blank" class="inline-flex items-center gap-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-green-600 transition-colors">
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 23.953l1.87-6.953A10.865 10.865 0 010 12C0 5.373 5.373 0 12 0s12 5.373 12 12-5.373 12-12 12a10.865 10.865 0 01-4.993-1.077l-6.953 1.87zm6.756-3.792l-.438-.255a8.91 8.91 0 005.151 1.694c4.956 0 8.985-4.029 8.985-8.985S16.956 2.015 12 2.015c-4.955 0-8.985 4.029-8.985 8.985 0 2.45.986 4.706 2.607 6.408l-.255.438-1.571 5.836 5.836-1.571z" /></svg>
                    Reclamar DonaciÃ³n por WhatsApp
                </a>
            </div>
            
            <div class="mt-10 pt-8 border-t border-slate-300 max-w-2xl mx-auto text-center">
                <button id="admin-login-btn" class="text-sm text-slate-500 hover:text-blue-600">
                    Login (Admin)
                </button>
                <p id="admin-status" class="text-sm text-green-600 mt-2 hidden"></p>
            </div>
        </div>
    </footer>

    <!-- =================================================================================== -->
    <!-- ===== INICIO DEL NUEVO MOTOR JAVASCRIPT DINÃMICO ===== -->
    <!-- =================================================================================== -->
    <script type="module">
        // --- IMPORTACIONES DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, runTransaction, increment, updateDoc, getDocs, limit, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // =================================================================
    // ===== Â¡LA CONFIGURACIÃ“N DE TU PROYECTO VIEJO (EL QUE SÃ FUNCIONA)! =====
    // =================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCPB82qY7h3YGvk_cClAw5so0DFgiePzNM",
      authDomain: "descargar-ultima-version.firebaseapp.com",
      projectId: "descargar-ultima-version",
      storageBucket: "descargar-ultima-version.firebasestorage.app",
      messagingSenderId: "1028999431387",
      appId: "1:1028999431387:web:3f6799e9adfca72d3078fe",
      measurementId: "G-BZRK62Y3S5"
    };
        
        // =================================================================
        // ===== Â¡PASO 2: TU NUEVO ADMIN ID VA AQUÃ! =====
        // (El que copiaste de la pestaÃ±a "Usuarios" en Firebase Authentication)
        // =================================================================
        const ADMIN_ID = "GL22tXZLqzcCRpfvNxAoO3sbFt03";

        // --- VARIABLES GLOBALES DEL ESTADO DE LA APP ---
        // (MODIFICADO) Detectamos si es mÃ³vil al inicio
        const isMobileStart = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let activeTab = isMobileStart ? 'mobile' : 'pc'; // Si es mÃ³vil, arranca en 'mobile'. Si no, en 'pc'.

        let currentCategory = 'home';
        let currentSearchTerm = '';
        let currentItem = null;
        let currentDownloadLink = null;
        let commentsUnsubscribe = null;
        let generalRequestsUnsubscribe = null;
        const userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');
        const userVotes = JSON.parse(localStorage.getItem('userVotes') || '{}');
        let downloadListeners = {};
        let likeListeners = {};
        let app, db, auth;
        let authReady = false;
        const appId = firebaseConfig.projectId; // Usa el nuevo projectId
        let aiChatHistory = [];
        let isAiThinking = false;
        let isSpeechEnabled = true;
        let recognition;

        // --- VARIABLES GLOBALES DINÃMICAS ---
        let allSoftware = []; // (MODIFICADO) Se carga desde Firebase
        let allCategories = []; // (MODIFICADO) Se carga desde Firebase
        let dynamicSystemPrompt = ""; // (MODIFICADO) El cerebro de la IA, se construye al cargar

        // --- Declarar variables del chat de IA ---
        let aiChatModal, aiChatForm, aiChatInput, aiChatSubmit, aiChatMessages, aiChatError;
        
        // --- CEREBRO ESTÃTICO DE LA IA (Plantilla) ---
        // (MODIFICADO) {INVENTORY_PLACEHOLDER} serÃ¡ reemplazado dinÃ¡micamente
        const systemPrompt = `
Eres "IA-Lahs", el asistente experto de la web "Descargar Ultima Version". Tu personalidad es amigable, jovial, inteligente y EXTREMADAMENTE servicial. Eres un defensor de este sitio web.

Tu misiÃ³n es triple:
1.Â  **AYUDAR AL USUARIO:** Responde a todas sus preguntas sobre el sitio, el software y cÃ³mo descargar.
2.Â  **BUSCAR EN EL INVENTARIO:** Si piden software, bÃºscalo en la lista que te di.
3.Â  **PROTEGER EL NEGOCIO:** NUNCA, BAJO NINGUNA CIRCUNSTANCIA, reveles los enlaces directos de "exe.io". Tu trabajo es guiar al usuario a travÃ©s del proceso de anuncios, explicÃ¡ndoles por quÃ© existe.

---
### INVENTARIO DE SOFTWARE
Este es el software que SÃ TENEMOS. Conoce sus IDs y tÃ­tulos:
{INVENTORY_PLACEHOLDER}
---

### REGLAS DE RESPUESTA:

**Regla 1: ConversaciÃ³n Normal (Saludos, Dudas)**
* Si el usuario saluda ("hola", "cÃ³mo estÃ¡s") o pregunta cosas generales ("quiÃ©n eres"), responde con tu personalidad amigable y jovial.
* Ej: "Â¡Hola! Soy IA-Lahs, tu asistente. Â¿QuÃ© software buscamos hoy?"

**Regla 2: BÃºsqueda de Software (Â¡LA MÃS IMPORTANTE!)**
* El usuario pedirÃ¡ software (ej: "tienes el photoshop", "busco spotify mod", "office 019").
* Usa tu conocimiento del INVENTARIO para encontrar la MEJOR coincidencia.
* **A. SI LO ENCUENTRAS (Match):**
Â  Â  * Responde amablemente y proporciona un enlace a la tarjeta en la pÃ¡gina.
Â  Â  * **FORMATO DE ETIQUETA (OBLIGATORIO):** \`Â¡Claro! EncontrÃ© "[TÃ­tulo del Software]". AquÃ­ tienes el acceso: [LINK:\${item.id}]\`
Â  Â  * Ej: "Â¡SÃ­! Tenemos "Adobe Photoshop 2025". Puedes ir a la ficha desde aquÃ­: [LINK:pc-photoshop]"
* **B. SI NO ES EXACTO (Match Parcial):**
Â  Â  * Si piden "Office 2019" y tÃº solo tienes "Office 2024".
Â  Â  * Responde: "Mmm, no tengo la versiÃ³n 2019 exacta, pero tengo la mÃ¡s nueva, "Microsoft Office 2024". Te la dejo aquÃ­ por si te sirve: [LINK:pc-office]"
* **C. SI NO LO ENCUENTRAS (Sin Match):**
Â  Â  * Si piden algo que NO estÃ¡ en la lista (ej: "Winamp").
Â  Â  * Responde amablemente que no lo tienes y que lo aÃ±adirÃ¡s a la pizarra de pedidos.
Â  Â  * **FORMATO DE ETIQUETA (OBLIGATORIO):** \`Â¡Uy! Parece que (Software) aÃºn no estÃ¡ en nuestro catÃ¡logo. Â¡Pero no te preocupes! Lo acabo de aÃ±adir a la "Pizarra de Pedidos" para que el admin lo vea y otros puedan votar. [ADD_TO_BOARD:\${softwareName}]\`
Â  Â  * Ej: "Â¡Vaya! Parece que 'Winamp' aÃºn no lo tenemos. Â¡Pero lo acabo de aÃ±adir a la "Pizarra de Pedidos" pÃºblica! El admin lo revisarÃ¡ pronto. [ADD_TO_BOARD:Winamp]"

**Regla 3: CÃ³mo Descargar (Â¡DEFENDER EL SITIO!)**
* El usuario se quejarÃ¡ de los anuncios o preguntarÃ¡ cÃ³mo descargar.
* **NUNCA des el link de \`exe.io\`.**
* **PASO 1 (Defender):** Explica que la "VÃ­a Gratuita" usa un socio (\`exe.io\`) que muestra anuncios, y que esos clics son los que pagan el servidor y mantienen el sitio vivo.
* **PASO 2 (Guiar):**
Â  Â  * PregÃºntale si estÃ¡ en PC o MÃ³vil, o detecta (te darÃ© la info).
Â  Â  * **Si es PC:** "Es sencillo. En la pÃ¡gina de \`exe.io\`, solo tienes que hacer clic en los botones, cerrar las pestaÃ±as nuevas que se abran, y volver a la pestaÃ±a original. Repite hasta que salga el captcha y el botÃ³n 'Get Link'."
Â  Â  * **Si es MÃ“VIL (MUY IMPORTANTE):** "Â¡AtenciÃ³n en mÃ³vil! Es igual que en PC (clic, cerrar pestaÃ±a, volver), PERO tu navegador (Chrome o Brave) intentarÃ¡ bloquear las ventanas emergentes. Si te sale un aviso de 'Adblock' o no te deja avanzar, es probable que tu navegador estÃ© bloqueando las ventanas emergentes. Cada navegador es diferente, asÃ­ que no puedo darte los pasos exactos, Â¡pero la soluciÃ³n estÃ¡ en permitir 'Ventanas emergentes' para el sitio! **La forma mÃ¡s fÃ¡cil de verlo es en nuestro video tutorial**, solo haz clic en el botÃ³n amarillo 'Â¿CÃ³mo descargar? (Video)'."
Â  Â  * **Referir al Video:** Siempre recuÃ©rdales que pueden ver el video tutorial haciendo clic en el botÃ³n "amarillo 'Â¿CÃ³mo descargar? (Video)'" que estÃ¡ arriba en la web.

**Regla 4: La VÃ­a Directa (Alternativa)**
* Si el usuario se queja mucho o pregunta por una alternativa.
* InfÃ³rmale sobre la "VÃ­a Directa (Premium)".
* Explica: "Si prefieres saltarte todos los anuncios, tenemos una 'VÃ­a Directa'. Con una pequeÃ±a donaciÃ³n (vÃ­a Yape o PayPal, los botones estÃ¡n en el footer de la web), nos ayudas directamente. Solo tienes que enviar tu captura de pago a nuestro WhatsApp (el link verde 'Reclamar DonaciÃ³n' tambiÃ©n estÃ¡ en el footer) y te daremos el link de descarga directo. Â¡TÃº eliges cÃ³mo apoyar!"
`;

Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  // ===== SECCIÃ“N 1: FUNCIONES AUXILIARES (Ayudantes) =====
Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Actualiza el enlace activo en la barra de navegaciÃ³n.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function updateActiveLink() {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.nav-link, .nav-link-parent').forEach(link => link.classList.remove('active'));
Â  Â  Â  Â  Â  Â  const activeLink = document.querySelector(`.nav-link[data-category="${currentCategory}"]`);
Â  Â  Â  Â  Â  Â  if (activeLink) {
Â  Â  Â  Â  Â  Â  Â  Â  activeLink.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  const parentGroup = activeLink.closest('.group');
Â  Â  Â  Â  Â  Â  Â  Â  if (parentGroup) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const parentBtn = parentGroup.querySelector('.nav-link-parent');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (parentBtn) parentBtn.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (currentCategory === 'home') {
Â  Â  Â  Â  Â  Â  Â  Â  const homeLink = document.querySelector(`.nav-link[data-category="home"]`);
Â  Â  Â  Â  Â  Â  Â  Â  if (homeLink) homeLink.classList.add('active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (MODIFICADO)
Â  Â  Â  Â  Â * Renderiza las tarjetas de software. Ahora es mÃ¡s seguro y previene XSS.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function renderCards(items, targetGridElement, noResultsElement) {
Â  Â  Â  Â  Â  Â  // VerificaciÃ³n de seguridad (causa del error anterior)
Â  Â  Â  Â  Â  Â  if (!targetGridElement || !noResultsElement) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error en renderCards: targetGridElement o noResultsElement es nulo.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  targetGridElement.innerHTML = ''; // Limpiar
Â  Â  Â  Â  Â  Â  if (items.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  noResultsElement.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  targetGridElement.classList.add('hidden');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  noResultsElement.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  targetGridElement.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Ordenar por fecha (mÃ¡s nuevo primero)
Â  Â  Â  Â  Â  Â  const sortedItems = items.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  const dateA = a.date ? new Date(a.date) : new Date(0);
Â  Â  Â  Â  Â  Â  Â  Â  const dateB = b.date ? new Date(b.date) : new Date(0);
Â  Â  Â  Â  Â  Â  Â  Â  return dateB - dateA;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  sortedItems.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  let placeholderColor = 'e2e8f0/94a3b8';
Â  Â  Â  Â  Â  Â  Â  Â  if (activeTab === 'mobile') placeholderColor = '16a34a/ffffff';
Â  Â  Â  Â  Â  Â  Â  Â  if (item.category && (item.category.includes('adobe') || item.category.includes('photoshop') || item.category.includes('premiere'))) placeholderColor = '1e40af/ffffff';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const passwordHtml = (item.platform === 'pc') ? `<span class="text-xs text-slate-500 text-center mt-2">ContraseÃ±a: taiwebs.com</span>` : '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const userHasLiked = userLikes[item.id] || false;
Â  Â  Â  Â  Â  Â  Â  Â  const likeButtonClass = userHasLiked ? 'like-btn liked' : 'like-btn';

Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  card.className = 'bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200 hover:shadow-lg hover:border-blue-300 transition-all duration-300 transform hover:-translate-y-1';
Â  Â  Â  Â  Â  Â  Â  Â  card.id = `card-${item.id}`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Usar innerHTML para la estructura, pero rellenar con textContent para seguridad
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img class="h-48 w-full object-cover" src="" alt=""> <!-- src y alt se asignan abajo -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-slate-500"></p> <!-- fecha -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="download-count-${item.id}" class="inline-flex items-center gap-1 text-xs text-blue-600 font-medium bg-blue-50 px-2 py-0.5 rounded-full" title="Descargas">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.23a.75.75 0 00-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.905 3.084V2.75z"></path><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5a1.25 1.25 0 01-1.25 1.25H4.75a1.25 1.25 0 01-1.25-1.25v-2.5z"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  0 <!-- contador de descargas -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold text-slate-900 mb-2 truncate" title=""></h3> <!-- tÃ­tulo -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-600 text-sm mb-4 h-20 overflow-hidden"></p> <!-- descripciÃ³n -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="download-btn w-full inline-block text-center bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors ${item.downloadLink === '#' ? 'opacity-50 cursor-not-allowed' : ''}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data-item-id="${item.id}" data-download-link="">Descargar</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${passwordHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-shrink-0 flex items-center justify-center gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button aria-label="Me gusta" class="${likeButtonClass} flex items-center flex-shrink-0 p-2.5 rounded-lg transition-colors" data-item-id="${item.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- contador de likes (se aÃ±ade dinÃ¡micamente) -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button aria-label="Comentarios" class="comment-btn flex items-center flex-shrink-0 bg-slate-100 text-slate-600 p-2.5 rounded-lg hover:bg-slate-200 transition-colors" data-item-id="${item.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2c-4.42 0-8 3.134-8 7 0 2.653 1.606 4.935 3.999 6.136.002.001.005.003.007.004l.004.002c.002.001.004.002.006.003l.003.001.002.001.002.001.001.001c.001 0 .002.001.003.001.001 0 .002.001.002.001l.001.001c.001 0 .002 0 .003.001.001 0 .002 0 .002.001l.002.001c.001 0 .001 0 .002.001.001 0 .001 0 .002.001h.001l.001.001h.001c.001 0 .001 0 .002 0h.001l.001 0h.001l.002 0 .001 0 .002 0 .001 0 .002 0 .001 0h.001c.001 0 .002 0 .003 0h.001l.002 0 .001 0 .002 0 .001 0c.001 0 .002 0 .003 0l.002 0 .002 0 .003 0A6.98 6.98 0 0010 18a.75.75 0 00.75-.75V15.12c0-.28.124-.54.33-.733l.002-.002.002-.002.003-.003.004-.003.003-.003.002-.002.002-.002.001-.001c.001 0 .002-.001.002-.001.001 0 .002-.001.002-.001l.001-.001c.001 0 .002-.001.003-.001.001 0 .002-.001.003-.001l.001-.001.002-.001.002-.001.002-.001.003-.001c.001 0 .002-.001.004-.001.001 0 .002-.001.003-.001.218-.088.428-.19.63-.309l.002-.001c.001 0 .003-.001.004-.002.001 0 .002-.001.004-.002.002-.001.003-.002.005-.003.001 0 .002-.001.003-.002l.003-.002.001-.001.001-.001c0 0 .001-.001.001-.001L13.05 14a6.96 6.96 0 003.95-6C17 5.134 13.42 2 10 2z" clip-rule="evenodd"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button aria-label="Compartir" class="share-btn flex-shrink-0 bg-slate-100 text-slate-600 p-2.5 rounded-lg hover:bg-slate-200 transition-colors" data-title="" data-url="">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6L15 7.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 0a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684zm-7.316 2.684l6.632 3.316"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // AsignaciÃ³n segura de atributos y textContent
Â  Â  Â  Â  Â  Â  Â  Â  const img = card.querySelector('img');
Â  Â  Â  Â  Â  Â  Â  Â  img.src = item.imageUrl || `https://placehold.co/600x400/${placeholderColor}?text=Imagen+no+disponible`;
Â  Â  Â  Â  Â  Â  Â  Â  img.alt = item.title || "Imagen de software";
Â  Â  Â  Â  Â  Â  Â  Â  img.onerror = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.onerror=null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.src=`https://placehold.co/600x400/${placeholderColor}?text=${encodeURIComponent(item.title || 'Error')}`;
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const titleEl = card.querySelector('h3');
Â  Â  Â  Â  Â  Â  Â  Â  titleEl.textContent = item.title || "Sin TÃ­tulo";
Â  Â  Â  Â  Â  Â  Â  Â  titleEl.title = item.title || "Sin TÃ­tulo";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  card.querySelector('p.text-slate-500').textContent = new Date(item.date || Date.now()).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
Â  Â  Â  Â  Â  Â  Â  Â  card.querySelector('p.text-slate-600').textContent = item.description || "Sin descripciÃ³n.";
Â  Â  Â  Â  Â  Â  Â  Â  card.querySelector('.download-btn').dataset.downloadLink = item.downloadLink || "#";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const shareBtn = card.querySelector('.share-btn');
Â  Â  Â  Â  Â  Â  Â  Â  shareBtn.dataset.title = item.title || "Descargar Ultima Version";
Â  Â  Â  Â  Â  Â  Â  Â  shareBtn.dataset.url = `${window.location.origin}${window.location.pathname}?item=${encodeURIComponent(item.id)}`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  targetGridElement.appendChild(card);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Re-vincular eventos (Â¡IMPORTANTE!)
Â  Â  Â  Â  Â  Â  targetGridElement.querySelectorAll('.share-btn').forEach(button => button.addEventListener('click', handleShare));
Â  Â  Â  Â  Â  Â  targetGridElement.querySelectorAll('.comment-btn').forEach(button => button.addEventListener('click', openCommentsModal));
Â  Â  Â  Â  Â  Â  targetGridElement.querySelectorAll('.like-btn').forEach(button => button.addEventListener('click', handleLike));
Â  Â  Â  Â  Â  Â  targetGridElement.querySelectorAll('.download-btn').forEach(button => button.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const { itemId, downloadLink } = e.currentTarget.dataset;
Â  Â  Â  Â  Â  Â  Â  Â  handleDownloadClick(e, itemId, downloadLink);
Â  Â  Â  Â  Â  Â  }));

Â  Â  Â  Â  Â  Â  // Actualizar contadores
Â  Â  Â  Â  Â  Â  items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  updateLikeCount(item.id, item.likes || 0);
Â  Â  Â  Â  Â  Â  Â  Â  updateDownloadCount(item.id, item.downloads || 0);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Maneja el clic en el botÃ³n de descarga, mostrando la guÃ­a si es mÃ³vil.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function handleDownloadClick(event, itemId, downloadLink) {
Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  const downloadGuideModal = document.getElementById('download-guide-modal');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (downloadLink && downloadLink !== "#") {
Â  Â  Â  Â  Â  Â  Â  Â  currentDownloadLink = downloadLink;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (isMobileDevice() && downloadGuideModal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  downloadGuideModal.classList.add('open');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si es PC o no hay modal, va directo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(currentDownloadLink, '_blank');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentDownloadLink = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (db) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await incrementDownloadCount(itemId);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Enlace de descarga aÃºn no disponible.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Verifica si el dispositivo es mÃ³vil.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function isMobileDevice() {
Â  Â  Â  Â  Â  Â  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (MODIFICADO)
Â  Â  Â  Â  Â * Incrementa el contador de descargas en Firebase.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function incrementDownloadCount(itemId) {
Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â  // (MODIFICADO) La ruta ahora es 'software-items'
Â  Â  Â  Â  Â  Â  const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, itemId);
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // (MODIFICADO) El campo se llama 'downloads'
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(itemRef, { downloads: increment(1) });
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al incrementar descargas: ", error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (MODIFICADO)
Â  Â  Â  Â  Â * Actualiza el contador de descargas en la UI en tiempo real.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function updateDownloadCount(itemId, staticCount) {
Â  Â  Â  Â  Â  Â  if (!db || downloadListeners[itemId]) return;
Â  Â  Â  Â  Â  Â  const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, itemId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  downloadListeners[itemId] = onSnapshot(itemRef, (doc) => {
Â  Â  Â  Â  Â  Â  Â  Â  const countEl = document.getElementById(`download-count-${itemId}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (!countEl) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let count = staticCount;
Â  Â  Â  Â  Â  Â  Â  Â  if (doc.exists() && doc.data().downloads !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count = doc.data().downloads;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Limpiar y rellenar de forma segura
Â  Â  Â  Â  Â  Â  Â  Â  countEl.innerHTML = ''; // Limpiar
Â  Â  Â  Â  Â  Â  Â  Â  countEl.appendChild(document.querySelector('.like-btn svg').cloneNode(true)); // Re-aÃ±adir icono
Â  Â  Â  Â  Â  Â  Â  Â  countEl.appendChild(document.createTextNode(` ${count.toLocaleString('es-ES')}`));
Â  Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Error en listener de descargas (${itemId}):`, error);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (MODIFICADO)
Â  Â  Â  Â  Â * Navega a una tarjeta especÃ­fica (usado por el ranking y la IA).
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function handleTopDownloadClick(e, cardId) {
Â  Â  Â  Â  Â  Â  if (e) e.preventDefault();
Â  Â  Â  Â  Â  Â  const itemId = cardId || (e ? e.currentTarget.dataset.itemId : null);
Â  Â  Â  Â  Â  Â  if (!itemId) return;

Â  Â  Â  Â  Â  Â  // (MODIFICADO) Busca en la lista global 'allSoftware'
Â  Â  Â  Â  Â  Â  let item = allSoftware.find(i => i.id === itemId);
Â  Â  Â  Â  Â  Â  if (!item) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`No se encontrÃ³ el item ${itemId} en allSoftware.`);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let itemTab = item.platform || 'pc'; // 'platform' viene de Firebase
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (activeTab !== itemTab) {
Â  Â  Â  Â  Â  Â  Â  Â  const tabToClick = (itemTab === 'pc') ? document.getElementById('tab-pc') : document.getElementById('tab-mobile');
Â  Â  Â  Â  Â  Â  Â  Â  if (tabToClick) tabToClick.click();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const cardElement = document.getElementById(`card-${item.id}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (cardElement) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardElement.classList.add('card-highlight');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardElement.classList.remove('card-highlight');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1500);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Maneja la funciÃ³n de compartir (Nativo o Copiar al portapapeles).
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function handleShare(e) {
Â  Â  Â  Â  Â  Â  const title = e.currentTarget.dataset.title;
Â  Â  Â  Â  Â  Â  const url = e.currentTarget.dataset.url;
Â  Â  Â  Â  Â  Â  if (navigator.share) {
Â  Â  Â  Â  Â  Â  Â  Â  navigator.share({ title, url }).catch(console.error);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fallback para copiar (requiere un input temporal)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const tempInput = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(tempInput);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempInput.value = url;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempInput.select();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.execCommand('copy');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(tempInput);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Enlace copiado: " + url);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // (AquÃ­ se podrÃ­a mostrar un toast de "Copiado")
Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("No se pudo copiar el enlace: ", err);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Asegura que haya un usuario (AnÃ³nimo o Logueado)
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function ensureUserIsLoggedIn() {
Â  Â  Â  Â  Â  Â  if (!auth) return null;
Â  Â  Â  Â  Â  Â  if (auth.currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  return auth.currentUser;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Si no hay usuario, intenta un login anÃ³nimo
Â  Â  Â  Â  Â  Â  Â  Â  const userCredential = await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  Â  Â  return userCredential.user;
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al iniciar sesiÃ³n anÃ³nima sobre la marcha:", error);
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (MODIFICADO)
Â  Â  Â  Â  Â * Abre el modal de comentarios.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function openCommentsModal(e) {
Â  Â  Â  Â  Â  Â  const button = e.currentTarget;
Â  Â  Â  Â  Â  Â  const itemId = button.dataset.itemId;
Â  Â  Â  Â  Â  Â  currentItem = allSoftware.find(i => i.id === itemId); // Busca en la lista global
Â  Â  Â  Â  Â  Â  if (!currentItem) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const commentsModal = document.getElementById('comments-modal');
Â  Â  Â  Â  Â  Â  const commentsModalTitle = document.getElementById('comments-modal-title');
Â  Â  Â  Â  Â  Â  const commentInput = document.getElementById('comment-input');
Â  Â  Â  Â  Â  Â  const commentsList = document.getElementById('comments-list');

Â  Â  Â  Â  Â  Â  commentsModalTitle.textContent = `Comentarios de "${currentItem.title}"`;
Â  Â  Â  Â  Â  Â  commentInput.value = '';
Â  Â  Â  Â  Â  Â  commentsList.innerHTML = '<p class="text-slate-500 text-sm">Cargando comentarios...</p>';
Â  Â  Â  Â  Â  Â  if (commentsModal) commentsModal.classList.add('open');
Â  Â  Â  Â  Â  Â  loadComments(currentItem);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Carga los comentarios de un item desde Firebase.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function loadComments(item) {
Â  Â  Â  Â  Â  Â  if (commentsUnsubscribe) commentsUnsubscribe();
Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â  const commentsList = document.getElementById('comments-list');
Â  Â  Â  Â  Â  Â  const commentsCollection = collection(db, `artifacts/${appId}/public/data/comments`, item.id, "messages");
Â  Â  Â  Â  Â  Â  const q = query(commentsCollection, orderBy("timestamp", "desc"));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  commentsUnsubscribe = onSnapshot(q, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  commentsList.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (item.staticComment) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const staticCommentEl = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  staticCommentEl.className = 'comment';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  staticCommentEl.innerHTML = `<p></p><span class="block text-right">hace tiempo</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  staticCommentEl.querySelector('p').textContent = item.staticComment; // AsignaciÃ³n segura
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  commentsList.appendChild(staticCommentEl);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.empty && !item.staticComment) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  commentsList.innerHTML = '<p class="text-slate-500 text-sm">No hay comentarios. Â¡SÃ© el primero!</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const comment = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const date = comment.timestamp ? comment.timestamp.toDate().toLocaleString('es-ES') : 'Justo ahora';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isAdmin = comment.uid === ADMIN_ID;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const commentEl = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  commentEl.className = isAdmin ? 'comment admin-comment' : 'comment';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const displayName = isAdmin ? `<strong>[ADMIN]</strong> ${comment.displayName || 'Admin'}` : (comment.displayName || 'AnÃ³nimo');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  commentEl.innerHTML = `<p></p><span class="block text-right">Por: ${displayName} - ${date}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  commentEl.querySelector('p').textContent = comment.text; // AsignaciÃ³n segura (previene XSS)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  commentsList.appendChild(commentEl);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al cargar comentarios: ", error);
Â  Â  Â  Â  Â  Â  Â  Â  commentsList.innerHTML = '<p class="text-red-500 text-sm">Error al cargar comentarios.</p>';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * EnvÃ­a un nuevo comentario a Firebase.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function submitComment(textArea, button, collectionRef) {
Â  Â  Â  Â  Â  Â  const commentText = textArea.value.trim();
Â  Â  Â  Â  Â  Â  if (!commentText) return;
Â  Â  Â  Â  Â  Â  const user = await ensureUserIsLoggedIn();
Â  Â  Â  Â  Â  Â  if (!user) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("No se pudo obtener usuario para comentar.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  button.disabled = true;
Â  Â  Â  Â  Â  Â  button.textContent = 'Enviando...';
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(collectionRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: commentText,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: user.uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayName: (user.uid === ADMIN_ID) ? (user.displayName || 'Admin') : (user.isAnonymous ? 'AnÃ³nimo' : (user.displayName || 'Usuario'))
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  textArea.value = '';
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al enviar comentario: ", error);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  button.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  button.textContent = 'Enviar Comentario';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FUNCIONES DE LA PIZARRA DE PEDIDOS ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * AÃ±ade un nuevo pedido de software a Firebase (si no existe).
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function addSoftwareRequest(softwareName) {
Â  Â  Â  Â  Â  Â  if (!db) return;
Â  Â  Â  Â  Â  Â  const user = await ensureUserIsLoggedIn();
Â  Â  Â  Â  Â  Â  if (!user) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const requestsCollection = collection(db, `artifacts/${appId}/public/data/general-requests`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Evitar duplicados (insensible a mayÃºsculas/minÃºsculas)
Â  Â  Â  Â  Â  Â  const lowerCaseName = softwareName.toLowerCase().trim();
Â  Â  Â  Â  Â  Â  const q = query(requestsCollection, where("lowerCaseName", "==", lowerCaseName));
Â  Â  Â  Â  Â  Â  const existing = await getDocs(q);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (existing.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newRequestRef = await addDoc(requestsCollection, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: softwareName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lowerCaseName: lowerCaseName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uid: user.uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayName: (user.uid === ADMIN_ID) ? 'Admin' : (user.isAnonymous ? 'AnÃ³nimo' : (user.displayName || 'Usuario')),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  votes: 1 // Empezar con 1 voto (el del solicitante)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Marcar como votado
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userVotes[newRequestRef.id] = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('userVotes', JSON.stringify(userVotes));
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al aÃ±adir pedido:", e);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("El pedido ya existe:", softwareName);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Carga la pizarra de pedidos desde Firebase.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function loadGeneralRequests() {
Â  Â  Â  Â  Â  Â  const generalRequestsList = document.getElementById('general-requests-list');
Â  Â  Â  Â  Â  Â  if (!generalRequestsList || !db) return;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  generalRequestsList.innerHTML = '<p class="text-slate-500 text-sm p-4 text-center">Cargando pedidos...</p>';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (generalRequestsUnsubscribe) generalRequestsUnsubscribe();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const requestsCollection = collection(db, `artifacts/${appId}/public/data/general-requests`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // (MODIFICADO) Quitar 'orderBy' de la consulta de Firebase
Â  Â  Â  Â  Â  Â  const q = query(requestsCollection);

Â  Â  Â  Â  Â  Â  generalRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  generalRequestsList.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  generalRequestsList.innerHTML = '<p class="text-slate-500 text-sm p-4 text-center">AÃºn no hay pedidos. Â¡PÃ­dele a la IA!</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Convertir a array para ordenar en JS
Â  Â  Â  Â  Â  Â  Â  Â  const requests = [];
Â  Â  Â  Â  Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requests.push({ id: doc.id, data: doc.data() });
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // Ordenar en JavaScript (Primero por votos, luego por fecha)
Â  Â  Â  Â  Â  Â  Â  Â  requests.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const votesDiff = (b.data.votes || 0) - (a.data.votes || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (votesDiff !== 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return votesDiff;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateA = (a.data.timestamp && a.data.timestamp.toMillis) ? a.data.timestamp.toMillis() : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dateB = (b.data.timestamp && b.data.timestamp.toMillis) ? b.data.timestamp.toMillis() : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return dateB - dateA;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  requests.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const request = doc.data;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const requestId = doc.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const date = request.timestamp ? request.timestamp.toDate().toLocaleDateString('es-ES') : 'reciente';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userHasVoted = userVotes[requestId] || false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const voteButtonClass = userHasVoted ? 'vote-btn voted' : 'vote-btn';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const requestEl = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requestEl.className = 'request-board-item';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requestEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="request-text">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong></strong>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Pedido por: ${request.displayName || 'AnÃ³nimo'} - ${date}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="${voteButtonClass}" data-request-id="${requestId}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â–² <span id="vote-count-${requestId}">${request.votes || 0}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requestEl.querySelector('strong').textContent = request.text; // AsignaciÃ³n segura
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  generalRequestsList.appendChild(requestEl);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  requestEl.querySelector('.vote-btn').addEventListener('click', handleVote);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al cargar pedidos: ", error);
Â  Â  Â  Â  Â  Â  Â  Â  generalRequestsList.innerHTML = `<p class="text-red-500 text-sm p-4 text-center">Error al cargar pedidos: ${error.message}</p>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Maneja un voto (arriba o abajo) en la pizarra de pedidos.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function handleVote(e) {
Â  Â  Â  Â  Â  Â  const button = e.currentTarget;
Â  Â  Â  Â  Â  Â  const requestId = button.dataset.requestId;
Â  Â  Â  Â  Â  Â  const user = await ensureUserIsLoggedIn();
Â  Â  Â  Â  Â  Â  if (!user) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const hasVoted = userVotes[requestId] || false;
Â  Â  Â  Â  Â  Â  const requestRef = doc(db, `artifacts/${appId}/public/data/general-requests`, requestId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await runTransaction(db, async (transaction) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const requestDoc = await transaction.get(requestRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!requestDoc.exists()) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentVotes = requestDoc.data().votes || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let newVoteCount = currentVotes;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (hasVoted) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newVoteCount = currentVotes > 0 ? currentVotes - 1 : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userVotes[requestId] = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newVoteCount = currentVotes + 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userVotes[requestId] = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transaction.update(requestRef, { votes: newVoteCount });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('userVotes', JSON.stringify(userVotes));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al votar:", error);
Â  Â  Â  Â  Â  Â  Â  Â  // Revertir el estado local si la transacciÃ³n falla
Â  Â  Â  Â  Â  Â  Â  Â  userVotes[requestId] = hasVoted;
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('userVotes', JSON.stringify(userVotes));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (MODIFICADO)
Â  Â  Â  Â  Â * Maneja un "Me Gusta" en una tarjeta de software.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function handleLike(e) {
Â  Â  Â  Â  Â  Â  const button = e.currentTarget;
Â  Â  Â  Â  Â  Â  const itemId = button.dataset.itemId;
Â  Â  Â  Â  Â  Â  const user = await ensureUserIsLoggedIn();
Â  Â  Â  Â  Â  Â  if (!user) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("No se pudo obtener usuario para dar like.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // (MODIFICADO) Ruta de la base de datos
Â  Â  Â  Â  Â  Â  const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, itemId);
Â  Â  Â  Â  Â  Â  const userHasLiked = userLikes[itemId] || false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await runTransaction(db, async (transaction) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemDoc = await transaction.get(itemRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!itemDoc.exists()) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // (MODIFICADO) Campo 'likes'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentLikes = itemDoc.data().likes || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!userHasLiked) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transaction.update(itemRef, { likes: currentLikes + 1 });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userLikes[itemId] = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.classList.add('liked');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transaction.update(itemRef, { likes: currentLikes > 0 ? currentLikes - 1 : 0 });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userLikes[itemId] = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.classList.remove('liked');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('userLikes', JSON.stringify(userLikes)); // Guardar en localStorage
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al dar like: ", error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (MODIFICADO)
Â  Â  Â  Â  Â * Actualiza el contador de "Me Gusta" en tiempo real.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function updateLikeCount(itemId, staticLikes) {
Â  Â  Â  Â  Â  Â  if (!db || likeListeners[itemId]) return;
Â  Â  Â  Â  Â  Â  const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, itemId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  likeListeners[itemId] = onSnapshot(itemRef, (doc) => {
Â  Â  Â  Â  Â  Â  Â  Â  // (MODIFICADO) Campo 'likes'
Â  Â  Â  Â  Â  Â  Â  Â  const likeCount = (doc.exists() && doc.data().likes !== undefined) ? doc.data().likes : staticLikes;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const button = document.querySelector(`.like-btn[data-item-id="${itemId}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  if (!button) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let countSpan = button.querySelector('span');
Â  Â  Â  Â  Â  Â  Â  Â  if (!countSpan) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countSpan = document.createElement('span');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countSpan.className = 'ml-1 text-sm font-medium';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.appendChild(countSpan);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  countSpan.textContent = likeCount;
Â  Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Error en listener de likes (${itemId}):`, error);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  // ===== SECCIÃ“N 2: LÃ“GICA DEL CHAT DE IA =====
Â  Â  Â  Â  // =================================================================

Â  Â  Â  Â  // --- INICIO FUNCIONES DE VOZ (TTS Y STT) ---
Â  Â  Â  Â  const synth = window.speechSynthesis;
Â  Â  Â  Â  let voices = [];
Â  Â  Â  Â Â 
Â  Â  Â  Â  function loadVoices() {
Â  Â  Â  Â  Â  Â  voices = synth.getVoices();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  loadVoices();
Â  Â  Â  Â  if (synth.onvoiceschanged !== undefined) {
Â  Â  Â  Â  Â  Â  synth.onvoiceschanged = loadVoices;
Â  Â  Â  Â  }

Â  Â  Â  Â  function speak(text) {
Â  Â  Â  Â  Â  Â  if (!isSpeechEnabled || !text || synth.speaking) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const cleanText = text.replace(/\[LINK:[^\]]+\]/g, '')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .replace(/\[ADD_TO_BOARD:[^\]]+\]/g, '')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .replace(/<[^>]+>/g, ''); // Quitar HTML

Â  Â  Â  Â  Â  Â  const utterThis = new SpeechSynthesisUtterance(cleanText);
Â  Â  Â  Â  Â  Â  utterThis.onerror = (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('SpeechSynthesisUtterance.onerror', event);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // (MODIFICADO) Prioriza EspaÃ±ol Latinoamericano
Â  Â  Â  Â  Â  Â  let spanishVoice = voices.find(voice => voice.lang === 'es-419') // EspecÃ­fico de Chrome
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  || voices.find(voice => voice.lang === 'es-MX') // MÃ©xico
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  || voices.find(voice => voice.lang === 'es-US') // US
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  || voices.find(voice => voice.lang.startsWith('es-')); // Cualquiera
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (spanishVoice) {
Â  Â  Â  Â  Â  Â  Â  Â  utterThis.voice = spanishVoice;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  utterThis.lang = 'es-419'; // Fallback
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  synth.speak(utterThis);
Â  Â  Â  Â  }

Â  Â  Â  Â  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  Â  Â  Â  let isListening = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (SpeechRecognition) {
Â  Â  Â  Â  Â  Â  recognition = new SpeechRecognition();
Â  Â  Â  Â  Â  Â  recognition.continuous = false;
Â  Â  Â  Â  Â  Â  recognition.lang = 'es-ES';
Â  Â  Â  Â  Â  Â  recognition.interimResults = false;
Â  Â  Â  Â  Â  Â  recognition.maxAlternatives = 1;

Â  Â  Â  Â  Â  Â  recognition.onresult = (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  const speechResult = event.results[0][0].transcript;
Â  Â  Â  Â  Â  Â  Â  Â  if(aiChatInput) aiChatInput.value = speechResult;
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  recognition.onspeechend = () => {
Â  Â  Â  Â  Â  Â  Â  Â  recognition.stop();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  recognition.onstart = () => {
Â  Â  Â  Â  Â  Â  Â  Â  isListening = true;
Â  Â  Â  Â  Â  Â  Â  Â  const micIcon = document.getElementById('mic-icon');
Â  Â  Â  Â  Â  Â  Â  Â  const micListening = document.getElementById('mic-listening');
Â  Â  Â  Â  Â  Â  Â  Â  if(micIcon) micIcon.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  if(micListening) micListening.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  recognition.onend = () => {
Â  Â  Â  Â  Â  Â  Â  Â  isListening = false;
Â  Â  Â  Â  Â  Â  Â  Â  const micIcon = document.getElementById('mic-icon');
Â  Â  Â  Â  Â  Â  Â  Â  const micListening = document.getElementById('mic-listening');
Â  Â  Â  Â  Â  Â  Â  Â  if(micIcon) micIcon.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  if(micListening) micListening.classList.add('hidden');
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  recognition.onerror = (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error de reconocimiento de voz:", event.error);
Â  Â  Â  Â  Â  Â  Â  Â  if(aiChatError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatError.textContent = `Error de micrÃ³fono: ${event.error}. AsegÃºrate de dar permiso.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatError.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.warn("Reconocimiento de voz no soportado en este navegador.");
Â  Â  Â  Â  }
Â  Â  Â  Â  // --- FIN FUNCIONES DE VOZ ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * AÃ±ade un mensaje (usuario o IA) al DOM del chat.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function addMessageToChat(role, text) {
Â  Â  Â  Â  Â  Â  if (!aiChatMessages) return;

Â  Â  Â  Â  Â  Â  const bubble = document.createElement('div');
Â  Â  Â  Â  Â  Â  bubble.classList.add('ai-chat-bubble', role);

Â  Â  Â  Â  Â  Â  if (role === 'user') {
Â  Â  Â  Â  Â  Â  Â  Â  bubble.textContent = text;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  bubble.innerHTML = text.replace(/\n/g, "<br>");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  aiChatMessages.appendChild(bubble);
Â  Â  Â  Â  Â  Â  aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
Â  Â  Â  Â  Â  Â  return bubble;
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Muestra la burbuja de "escribiendo..."
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function addLoadingBubble() {
Â  Â  Â  Â  Â  Â  if (!aiChatMessages) return;
Â  Â  Â  Â  Â  Â  const bubble = document.createElement('div');
Â  Â  Â  Â  Â  Â  bubble.id = 'ai-loading-bubble';
Â  Â  Â  Â  Â  Â  bubble.classList.add('ai-chat-bubble', 'ai', 'loading');
Â  Â  Â  Â  Â  Â  bubble.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <span class="typing-dot"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="typing-dot"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="typing-dot"></span>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  aiChatMessages.appendChild(bubble);
Â  Â  Â  Â  Â  Â  aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Quita la burbuja de "escribiendo..."
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function removeLoadingBubble() {
Â  Â  Â  Â  Â  Â  const loadingBubble = document.getElementById('ai-loading-bubble');
Â  Â  Â  Â  Â  Â  if (loadingBubble) {
Â  Â  Â  Â  Â  Â  Â  Â  loadingBubble.remove();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Llama a la API de Gemini (IA Chat).
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function getAiChatResponse(history) {
Â  Â  Â  Â  Â  Â  const device = isMobileDevice() ? 'MÃ³vil (Android o iPhone)' : 'PC (Windows o Mac)';
Â  Â  Â  Â  Â  Â  const contextualSystemPrompt = `CONTEXTO DEL DISPOSITIVO: El usuario estÃ¡ actualmente en un dispositivo: ${device}. Ten esto en cuenta para tus guÃ­as de descarga.\n\n${dynamicSystemPrompt}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const historyWithInventory = [...history]; // Copia
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!dynamicSystemPrompt) {
Â  Â  Â  Â  Â  Â  Â  Â  Â console.warn("Â¡El prompt dinÃ¡mico de la IA aÃºn no estÃ¡ listo!");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  Â  Â  // ===== Â¡PASO 3: TU CLAVE DE IA (GEMINI) VA AQUÃ! =====
Â  Â  Â  Â  Â  Â  // (Esta es la que creaste en AI Studio, la que termina en ...UMCw)
Â  Â  Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  Â  Â  const apiKey = "AIzaSyC2eih2fC7lR3VA9Uv1zOWbxy7egX9UMCw";
Â  Â  Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (apiKey.includes("AQUI_VA_TU")) {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("API Key de IA (Gemini) no configurada. Por favor, edita el script y aÃ±ade tu clave.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  contents: historyWithInventory,
Â  Â  Â  Â  Â  Â  Â  Â  systemInstruction: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parts: [{ text: contextualSystemPrompt }]
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  safetySettings: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
Â  Â  Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  Â  Â  generationConfig: {}
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(apiUrl, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorBody = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error en la API de IA (Respuesta no OK):", errorBody);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorMessage = errorBody.error?.message || `Error ${response.status}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(errorMessage);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return result.candidates[0].content.parts[0].text;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (result.candidates && result.candidates[0].finishReason === 'SAFETY') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Respuesta bloqueada por polÃ­ticas de seguridad.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Respuesta inesperada de la IA:", result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Respuesta invÃ¡lida de la IA.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al llamar a getAiChatResponse:", error);
Â  Â  Â  Â  Â  Â  Â  Â  throw error;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Orquesta la respuesta de la IA y procesa las etiquetas especiales.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function handleAiResponse() {
Â  Â  Â  Â  Â  Â  isAiThinking = true;
Â  Â  Â  Â  Â  Â  addLoadingBubble();
Â  Â  Â  Â  Â  Â  if(aiChatError) aiChatError.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if(aiChatSubmit) aiChatSubmit.disabled = true;

Â  Â  Â  Â  Â  Â  // (MODIFICADO) Asegurarse que el cerebro estÃ© listo antes de llamar
Â  Â  Â  Â  Â  Â  if (!dynamicSystemPrompt) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("El cerebro de la IA no estaba listo, construyÃ©ndolo ahora...");
Â  Â  Â  Â  Â  Â  Â  Â  await buildDynamicSystemPrompt(); // Esto fallarÃ¡ si allSoftware estÃ¡ vacÃ­o
Â  Â  Â  Â  Â  Â  Â  Â  if (!dynamicSystemPrompt) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Â¡FALLO CRÃTICO! No se pudo construir el cerebro de la IA.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // (AquÃ­ se podrÃ­a poner un prompt de fallback)
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const aiText = await getAiChatResponse([...aiChatHistory]);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  aiChatHistory.push({ role: 'model', parts: [{ text: aiText }] });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let processedText = aiText;

Â  Â  Â  Â  Â  Â  Â  Â  // Procesar etiquetas [LINK:...]
Â  Â  Â  Â  Â  Â  Â  Â  processedText = processedText.replace(/\[LINK:([^\]]+)\]/g, (match, cardId) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = allSoftware.find(i => i.id === cardId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const title = item ? item.title : 'ver detalles';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return ` <a href="#" class="chat-link font-bold text-blue-600 underline" data-card-id="${cardId}">${title}</a>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Procesar etiquetas [ADD_TO_BOARD:...]
Â  Â  Â  Â  Â  Â  Â  Â  const boardMatch = processedText.match(/\[ADD_TO_BOARD:([^\]]+)\]/);
Â  Â  Â  Â  Â  Â  Â  Â  if (boardMatch && boardMatch[1]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const softwareName = boardMatch[1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addSoftwareRequest(softwareName); // AÃ±adir a Firebase
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  processedText = processedText.replace(boardMatch[0], ''); // Quitar la etiqueta
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  removeLoadingBubble();
Â  Â  Â  Â  Â  Â  Â  Â  const aiBubble = addMessageToChat('ai', processedText);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  speak(processedText);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error en handleAiResponse:", error);
Â  Â  Â  Â  Â  Â  Â  Â  removeLoadingBubble();
Â  Â  Â  Â  Â  Â  Â  Â  const errorMsg = `Â¡Uy! Algo saliÃ³ mal. Error de API: ${error.message}. Por favor, intÃ©ntalo de nuevo.`;
Â  Â  Â  Â  Â  Â  Â  Â  addMessageToChat('ai', errorMsg);
Â  Â  Â  Â  Â  Â  Â  Â  speak("Â¡Uy! Algo saliÃ³ mal.");
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(aiChatError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatError.textContent = errorMsg;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatError.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (aiChatHistory.length > 0 && aiChatHistory[aiChatHistory.length - 1].role === 'user') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatHistory.pop();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  isAiThinking = false;
Â  Â  Â  Â  Â  Â  Â  Â  if(aiChatSubmit) aiChatSubmit.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // AÃ±adir listeners a los nuevos links del chat
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.chat-link').forEach(link => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  link.replaceWith(link.cloneNode(true));
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.chat-link').forEach(link => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  link.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cardId = e.currentTarget.dataset.cardId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(aiChatModal) aiChatModal.classList.remove('open');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleTopDownloadClick(null, cardId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  // ===== SECCIÃ“N 3: LÃ“GICA PRINCIPAL (Carga y Eventos) =====
Â  Â  Â  Â  // =================================================================

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (NUEVO)
Â  Â  Â  Â  Â * Carga todo el software y categorÃ­as desde Firebase al iniciar.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function loadSoftwareAndCategoriesFromFirebase() {
Â  Â  Â  Â  Â  Â  if (!db) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firestore (db) no estÃ¡ inicializado.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const contentGridPc = document.getElementById('content-grid-pc');
Â  Â  Â  Â  Â  Â  if (contentGridPc) contentGridPc.innerHTML = '<p class="text-slate-500 text-sm">Cargando software...</p>';
Â  Â  Â  Â  Â  Â  const contentGridMobile = document.getElementById('content-grid-mobile');
Â  Â  Â  Â  Â  Â  if (contentGridMobile) contentGridMobile.innerHTML = '<p class="text-slate-500 text-sm">Cargando software...</p>';
Â  Â  Â  Â  Â  Â  const topDownloadsList = document.getElementById('top-downloads-list');
Â  Â  Â  Â  Â  Â  if (topDownloadsList) topDownloadsList.innerHTML = '<p class="text-slate-500 text-sm">Cargando ranking...</p>';

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const itemsCollection = collection(db, `artifacts/${appId}/public/data/software-items`);
Â  Â  Â  Â  Â  Â  Â  Â  const snapshot = await getDocs(itemsCollection);

Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("No se encontrÃ³ software en la base de datos.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (contentGridPc) contentGridPc.innerHTML = '<p class="text-red-500 text-lg">No se encontrÃ³ software. Â¿El admin ya migrÃ³ los datos?</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const tempSoftware = [];
Â  Â  Â  Â  Â  Â  Â  Â  const tempCategories = new Map(); // Usar un Map para categorÃ­as Ãºnicas
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // AÃ±adir 'Home' por defecto
Â  Â  Â  Â  Â  Â  Â  Â  tempCategories.set('home', { id: 'home', name: 'Home', count: 0, submenus: [] });Â 

Â  Â  Â  Â  Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemId = doc.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempSoftware.push({ id: itemId, ...item });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // (MODIFICADO) Llenar categorÃ­as dinÃ¡micamente
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.category && item.platform === 'pc') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!tempCategories.has(item.category)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Crear categorÃ­a si no existe
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempCategories.set(item.category, {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: item.category,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: item.category.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()), // "premiere-pro" -> "Premiere Pro"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count: 1,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submenus: []Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Incrementar contador si ya existe
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempCategories.get(item.category).count++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // Asignar a variables globales
Â  Â  Â  Â  Â  Â  Â  Â  allSoftware = tempSoftware;
Â  Â  Â  Â  Â  Â  Â  Â  allCategories = Array.from(tempCategories.values());
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Cargados ${allSoftware.length} items de software.`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // (MODIFICADO) Ahora que tenemos datos, podemos ejecutar todo lo demÃ¡s
Â  Â  Â  Â  Â  Â  Â  Â  buildDynamicSystemPrompt(); // Construir cerebro de IA
Â  Â  Â  Â  Â  Â  Â  Â  generateNav(allCategories); // Construir menÃº
Â  Â  Â  Â  Â  Â  Â  Â  updateView(); // Renderizar tarjetas
Â  Â  Â  Â  Â  Â  Â  Â  loadTopDownloads(); // Cargar ranking
Â  Â  Â  Â  Â  Â  Â  Â  loadGeneralRequests(); // Cargar pizarra de pedidos

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error fatal al cargar software desde Firebase:", error);
Â  Â  Â  Â  Â  Â  Â  Â  if (contentGridPc) contentGridPc.innerHTML = `<p class="text-red-500 text-lg">Error al cargar datos: ${error.message}</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (NUEVO)
Â  Â  Â  Â  Â * Construye el systemPrompt de la IA usando la lista de software cargada.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function buildDynamicSystemPrompt() {
Â  Â  Â  Â  Â  Â  if (allSoftware.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("No hay software para construir el prompt de la IA.");
Â  Â  Â  Â  Â  Â  Â  Â  dynamicSystemPrompt = systemPrompt.replace("{INVENTORY_PLACEHOLDER}", "No hay software en el inventario en este momento.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const inventoryList = allSoftware
Â  Â  Â  Â  Â  Â  Â  Â  .map(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `- ID: "${item.id}", TÃ­tulo: "${item.title}", Keywords: "${item.keywords || ''}"`;
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .join('\n');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  dynamicSystemPrompt = systemPrompt.replace("{INVENTORY_PLACEHOLDER}", inventoryList);
Â  Â  Â  Â  Â  Â  console.log("Cerebro de la IA construido dinÃ¡micamente.");
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (MODIFICADO)
Â  Â  Â  Â  Â * Genera la navegaciÃ³n principal. Ahora es dinÃ¡mico.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function generateNav(categories) {
Â  Â  Â  Â  Â  Â  const navContainer = document.getElementById('nav-container');
Â  Â  Â  Â  Â  Â  if (!navContainer) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const navUl = document.createElement('ul');
Â  Â  Â  Â  Â  Â  navUl.className = 'flex flex-wrap items-center justify-center gap-4 sm:gap-6';

Â  Â  Â  Â  Â  Â  // (MODIFICADO) Ya no hay menÃº estÃ¡tico, se basa en las categorÃ­as de Firebase
Â  Â  Â  Â  Â  Â  categories.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (a.id === 'home') return -1; // 'Home' siempre primero
Â  Â  Â  Â  Â  Â  Â  Â  if (b.id === 'home') return 1;
Â  Â  Â  Â  Â  Â  Â  Â  return a.name.localeCompare(b.name); // Ordenar alfabÃ©ticamente
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  categories.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  Â  if (item.submenus && item.submenus.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // (LÃ³gica de submenÃºs, si la hubiera en el futuro)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.className = 'group relative pb-4 -mb-4';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let submenusHTML = item.submenus.map(sub =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<a href="#" class="nav-link dropdown-item" data-category="${sub.id}">${sub.name}</a>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ).join('');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="nav-link-parent flex items-center gap-1 font-medium text-slate-600 hover:text-blue-600 transition-colors" data-category-parent="${item.name}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.name}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dropdown">${submenusHTML}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Enlace simple
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.innerHTML = `<a href="#" class="nav-link font-medium text-slate-600 hover:text-blue-600 transition-colors" data-category="${item.id}">${item.name}</a>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  navUl.appendChild(li);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  navContainer.innerHTML = ''; // Limpiar "Cargando..."
Â  Â  Â  Â  Â  Â  navContainer.appendChild(navUl);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (MODIFICADO)
Â  Â  Â  Â  Â * Renderiza la vista principal. Ahora lee de `allSoftware`.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function updateView() {
Â  Â  Â  Â  Â  Â  const contentGridPc = document.getElementById('content-grid-pc');
Â  Â  Â  Â  Â  Â  const contentGridMobile = document.getElementById('content-grid-mobile');
Â  Â  Â  Â  Â  Â  const noResultsPc = document.getElementById('no-results-pc');
Â  Â  Â  Â  Â  Â  const noResultsMobile = document.getElementById('no-results-mobile');
Â  Â  Â  Â  Â  Â  const navContainer = document.getElementById('nav-container');

Â  Â  Â  Â  Â  Â  // Limpiar listeners antiguos
Â  Â  Â  Â  Â  Â  Object.values(downloadListeners).forEach(unsubscribe => unsubscribe());
Â  Â  Â  Â  Â  Â  Object.values(likeListeners).forEach(unsubscribe => unsubscribe());
Â  Â  Â  Â  Â  Â  downloadListeners = {};
Â  Â  Â  Â  Â  Â  likeListeners = {};

Â  Â  Â  Â  Â  Â  if (activeTab === 'pc') {
Â  Â  Â  Â  Â  Â  Â  Â  let filteredItems = allSoftware.filter(item => item.platform === 'pc');
Â  Â  Â  Â  Â  Â  Â  Â  if (currentCategory !== 'home') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  filteredItems = filteredItems.filter(item => item.category === currentCategory);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (currentSearchTerm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  filteredItems = filteredItems.filter(item =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (item.title && item.title.toLowerCase().includes(currentSearchTerm)) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (item.description && item.description.toLowerCase().includes(currentSearchTerm)) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (item.keywords && item.keywords.toLowerCase().includes(currentSearchTerm))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  renderCards(filteredItems, contentGridPc, noResultsPc);
Â  Â  Â  Â  Â  Â  Â  Â  if (navContainer) navContainer.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  let filteredItems = allSoftware.filter(item => item.platform === 'mobile');
Â  Â  Â  Â  Â  Â  Â  Â  if (currentSearchTerm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â filteredItems = filteredItems.filter(item =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (item.title && item.title.toLowerCase().includes(currentSearchTerm)) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (item.description && item.description.toLowerCase().includes(currentSearchTerm)) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (item.keywords && item.keywords.toLowerCase().includes(currentSearchTerm))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  renderCards(filteredItems, contentGridMobile, noResultsMobile);
Â  Â  Â  Â  Â  Â  Â  Â  if (navContainer) navContainer.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateActiveLink();
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * (MODIFICADO)
Â  Â  Â  Â  Â * Carga el Top 5. Ahora lee de `allSoftware`.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function loadTopDownloads() {
Â  Â  Â  Â  Â  Â  const topDownloadsList = document.getElementById('top-downloads-list');
Â  Â  Â  Â  Â  Â  if (!topDownloadsList) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (allSoftware.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â topDownloadsList.innerHTML = '<p class="text-slate-500 text-sm">AÃºn no hay datos para un ranking.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let mergedItems = allSoftware.map(item => ({ ...item, displayDownloads: item.downloads || 0 }));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  mergedItems.sort((a, b) => b.displayDownloads - a.displayDownloads);
Â  Â  Â  Â  Â  Â  const top5 = mergedItems.slice(0, 5);

Â  Â  Â  Â  Â  Â  if (top5.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  topDownloadsList.innerHTML = '<p class="text-slate-500 text-sm">AÃºn no hay suficientes datos para un ranking.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  topDownloadsList.innerHTML = '';
Â  Â  Â  Â  Â  Â  let rank = 1;
Â  Â  Â  Â  Â  Â  top5.forEach(itemDetails => {
Â  Â  Â  Â  Â  Â  Â  Â  const itemEl = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  itemEl.href = `#card-${itemDetails.id}`;
Â  Â  Â  Â  Â  Â  Â  Â  itemEl.className = 'flex items-center gap-3 bg-slate-50 p-3 rounded-lg border border-slate-200 hover:bg-slate-100 hover:shadow-sm transition-all';
Â  Â  Â  Â  Â  Â  Â  Â  itemEl.dataset.itemId = itemDetails.id;
Â  Â  Â  Â  Â  Â  Â  Â  itemEl.addEventListener('click', (e) => handleTopDownloadClick(e));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  itemEl.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-lg font-bold text-slate-400">#${rank}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${itemDetails.imageUrl || 'https://placehold.co/40x40/e2e8f0/94a3b8?text=?'}" alt="" class="w-10 h-10 rounded-md object-cover flex-shrink-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="overflow-hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-semibold text-slate-800 truncate" title=""></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-blue-600 font-medium">${itemDetails.displayDownloads.toLocaleString('es-ES')} descargas</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  // AsignaciÃ³n segura
Â  Â  Â  Â  Â  Â  Â  Â  itemEl.querySelector('img').alt = itemDetails.title;
Â  Â  Â  Â  Â  Â  Â  Â  itemEl.querySelector('p.text-sm').textContent = itemDetails.title;
Â  Â  Â  Â  Â  Â  Â  Â  itemEl.querySelector('p.text-sm').title = itemDetails.title;

Â  Â  Â  Â  Â  Â  Â  Â  topDownloadsList.appendChild(itemEl);
Â  Â  Â  Â  Â  Â  Â  Â  rank++;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }


Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â  // ===== PUNTO DE ENTRADA PRINCIPAL (NUEVO MOTOR) =====
Â  Â  Â  Â  // =================================================================
Â  Â  Â  Â Â 
Â  Â  Â  Â  // (MODIFICADO) Quitado el 'DOMContentLoaded' para evitar conflictos.
Â  Â  Â  Â  // El script se ejecuta al final del <body>, por lo que el DOM ya estÃ¡ listo.

Â  Â  Â  Â  // --- Asignar elementos del Chat de IA ---
Â  Â  Â  Â  aiChatModal = document.getElementById('ai-chat-modal');
Â  Â  Â  Â  aiChatForm = document.getElementById('ai-chat-form');
Â  Â  Â  Â  aiChatInput = document.getElementById('ai-chat-input');
Â  Â  Â  Â  aiChatSubmit = document.getElementById('ai-chat-submit');
Â  Â  Â  Â  aiChatMessages = document.getElementById('ai-chat-messages');
Â  Â  Â  Â  aiChatError = document.getElementById('ai-chat-error');

Â  Â  Â  Â  // Obtener referencias a elementos
Â  Â  Â  Â  const navContainer = document.getElementById('nav-container');
Â  Â  Â  Â  const howToDownloadBtn = document.getElementById('how-to-download-btn');
Â  Â  Â  Â  const howToDownloadModal = document.getElementById('how-to-download-modal');
Â  Â  Â  Â  const tabPc = document.getElementById('tab-pc');
Â  Â  Â  Â  const tabMobile = document.getElementById('tab-mobile');
Â  Â  Â  Â  const contentPc = document.getElementById('content-pc');
Â  Â  Â  Â  const contentMobile = document.getElementById('content-mobile');
Â  Â  Â  Â  const yapeModal = document.getElementById('yape-modal');
Â  Â  Â  Â  const yapeModalOpenBtn = document.getElementById('yape-modal-open');
Â  Â  Â  Â  const yapeModalCloseBtn = document.getElementById('yape-modal-close');
Â  Â  Â  Â  const openYapeBtn = document.getElementById('open-yape-btn');
Â  Â  Â  Â  const commentsModal = document.getElementById('comments-modal');
Â  Â  Â  Â  const commentsModalCloseBtn = document.getElementById('comments-modal-close');
Â  Â  Â  Â  const submitCommentBtn = document.getElementById('submit-comment-btn');
Â  Â  Â  Â  const downloadGuideModal = document.getElementById('download-guide-modal');
Â  Â  Â  Â  const downloadGuideModalCloseBtn = document.getElementById('download-guide-modal-close');
Â  Â  Â  Â  const downloadGuideContinueBtn = document.getElementById('download-guide-continue-btn');
Â  Â  Â  Â  const adminLoginBtn = document.getElementById('admin-login-btn');
Â  Â  Â  Â  const adminStatus = document.getElementById('admin-status');
Â  Â  Â  Â  const commentInput = document.getElementById('comment-input');

Â  Â  Â  Â  // (NUEVO) AJUSTE VISUAL INICIAL DE PESTAÃ‘AS
Â  Â  Â  Â  // Si detectamos mÃ³vil, cambiamos los colores de las pestaÃ±as y la visibilidad antes de cargar nada
Â  Â  Â  Â  if (activeTab === 'mobile') {
Â  Â  Â  Â  Â  Â  // Cambiar pestaÃ±a PC a inactiva
Â  Â  Â  Â  Â  Â  if(tabPc) {
Â  Â  Â  Â  Â  Â  Â  Â  tabPc.classList.replace('text-blue-700', 'text-slate-500');
Â  Â  Â  Â  Â  Â  Â  Â  tabPc.classList.replace('bg-blue-100', 'bg-slate-100');
Â  Â  Â  Â  Â  Â  Â  Â  tabPc.classList.replace('border-blue-600', 'border-transparent');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Cambiar pestaÃ±a MÃ³vil a activa
Â  Â  Â  Â  Â  Â  if(tabMobile) {
Â  Â  Â  Â  Â  Â  Â  Â  tabMobile.classList.replace('text-slate-500', 'text-green-700');
Â  Â  Â  Â  Â  Â  Â  Â  tabMobile.classList.replace('bg-slate-100', 'bg-green-100');
Â  Â  Â  Â  Â  Â  Â  Â  tabMobile.classList.replace('border-transparent', 'border-green-600');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Mostrar contenido mÃ³vil y ocultar PC
Â  Â  Â  Â  Â  Â  if(contentPc) contentPc.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if(contentMobile) contentMobile.classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- ASIGNACIÃ“N DE EVENTOS ---
Â  Â  Â  Â  const openAiChatBtn = document.getElementById('open-ai-chat-btn');
Â  Â  Â  Â  if (openAiChatBtn) {
Â  Â  Â  Â  Â  Â  openAiChatBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (aiChatModal) aiChatModal.classList.add('open');
Â  Â  Â  Â  Â  Â  Â  Â  if (aiChatInput) aiChatInput.focus();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const aiChatModalCloseBtn = document.getElementById('ai-chat-modal-close');
Â  Â  Â  Â  const aiSpeakerToggle = document.getElementById('ai-speaker-toggle');
Â  Â  Â  Â  const speakerOnIcon = document.getElementById('speaker-on');
Â  Â  Â  Â  const speakerOffIcon = document.getElementById('speaker-off');
Â  Â  Â  Â  const aiChatMicBtn = document.getElementById('ai-chat-mic');

Â  Â  Â  Â  if (aiChatModalCloseBtn) {
Â  Â  Â  Â  Â  Â  aiChatModalCloseBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (aiChatModal) aiChatModal.classList.remove('open');
Â  Â  Â  Â  Â  Â  Â  Â  synth.cancel();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (aiSpeakerToggle && speakerOnIcon && speakerOffIcon) {
Â  Â  Â  Â  Â  Â  aiSpeakerToggle.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  isSpeechEnabled = !isSpeechEnabled;
Â  Â  Â  Â  Â  Â  Â  Â  if (isSpeechEnabled) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speakerOnIcon.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speakerOffIcon.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speak("Altavoz activado.");
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speakerOnIcon.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speakerOffIcon.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  synth.cancel();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (aiChatMicBtn && recognition) {
Â  Â  Â  Â  Â  Â  aiChatMicBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (isListening) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recognition.stop();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(aiChatError) aiChatError.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recognition.start();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al iniciar reconocimiento:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(aiChatError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatError.textContent = `Error de micrÃ³fono. Â¿Ya diste permiso?`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatError.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else if (aiChatMicBtn) {
Â  Â  Â  Â  Â  Â  aiChatMicBtn.style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  if (aiChatModal) {
Â  Â  Â  Â  Â  Â  aiChatModal.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.target === aiChatModal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatModal.classList.remove('open');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (aiChatForm) {
Â  Â  Â  Â  Â  Â  aiChatForm.addEventListener('submit', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  if (!aiChatInput) return;
Â  Â  Â  Â  Â  Â  Â  Â  const userText = aiChatInput.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (!userText || isAiThinking) return;
Â  Â  Â  Â  Â  Â  Â  Â  aiChatInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  addMessageToChat('user', userText);
Â  Â  Â  Â  Â  Â  Â  Â  aiChatHistory.push({ role: 'user', parts: [{ text: userText }] });
Â  Â  Â  Â  Â  Â  Â  Â  handleAiResponse();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (tabPc) {
Â  Â  Â  Â  Â  Â  tabPc.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  activeTab = 'pc';
Â  Â  Â  Â  Â  Â  Â  Â  currentCategory = 'home';
Â  Â  Â  Â  Â  Â  Â  Â  if (contentMobile) contentMobile.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  if (contentPc) contentPc.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  tabPc.classList.replace('text-slate-500', 'text-blue-700');
Â  Â  Â  Â  Â  Â  Â  Â  tabPc.classList.replace('bg-slate-100', 'bg-blue-100');
Â  Â  Â  Â  Â  Â  Â  Â  tabPc.classList.replace('border-transparent', 'border-blue-600');
Â  Â  Â  Â  Â  Â  Â  Â  if (tabMobile) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabMobile.classList.replace('text-green-700', 'text-slate-500');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabMobile.classList.replace('bg-green-100', 'bg-slate-100');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabMobile.classList.replace('border-green-600', 'border-transparent');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  updateView();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (tabMobile) {
Â  Â  Â  Â  Â  Â  tabMobile.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  activeTab = 'mobile';
Â  Â  Â  Â  Â  Â  Â  Â  if (contentPc) contentPc.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  if (contentMobile) contentMobile.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  tabMobile.classList.replace('text-slate-500', 'text-green-700');
Â  Â  Â  Â  Â  Â  Â  Â  tabMobile.classList.replace('bg-slate-100', 'bg-green-100');
Â  Â  Â  Â  Â  Â  Â  Â  tabMobile.classList.replace('border-transparent', 'border-green-600');
Â  Â  Â  Â  Â  Â  Â  Â  if (tabPc) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabPc.classList.replace('text-blue-700', 'text-slate-500');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabPc.classList.replace('bg-blue-100', 'bg-slate-100');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabPc.classList.replace('border-blue-600', 'border-transparent');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  updateView();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (navContainer) {
Â  Â  Â  Â  Â  Â  navContainer.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const link = e.target.closest('.nav-link');
Â  Â  Â  Â  Â  Â  Â  Â  const parentLink = e.target.closest('.nav-link-parent');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (link && link.dataset.category) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentCategory = link.dataset.category;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (activeTab !== 'pc') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(tabPc) tabPc.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateView();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.dropdown.open').forEach(menu => menu.classList.remove('open'));
Â  Â  Â  Â  Â  Â  Â  Â  } else if (parentLink) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dropdown = parentLink.nextElementSibling;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.dropdown.open').forEach(menu => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (menu !== dropdown) menu.classList.remove('open');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (dropdown) dropdown.classList.toggle('open');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  document.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  const nav = document.getElementById('nav-container');
Â  Â  Â  Â  Â  Â  if (nav && !nav.contains(e.target)) {
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.dropdown.open').forEach(menu => menu.classList.remove('open'));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (howToDownloadBtn) {
Â  Â  Â  Â  Â  Â  howToDownloadBtn.addEventListener('click', () => { if (howToDownloadModal) howToDownloadModal.classList.add('open'); });
Â  Â  Â  Â  }
Â  Â  Â  Â  if (howToDownloadModal) {
Â  Â  Â  Â  Â  Â  howToDownloadModal.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.target === howToDownloadModal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  howToDownloadModal.classList.remove('open');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (yapeModalOpenBtn) yapeModalOpenBtn.addEventListener('click', () => { if (yapeModal) yapeModal.classList.add('open'); });
Â  Â  Â  Â  if (yapeModalCloseBtn) yapeModalCloseBtn.addEventListener('click', () => { if (yapeModal) yapeModal.classList.remove('open'); });
Â  Â  Â  Â  if (yapeModal) yapeModal.addEventListener('click', (e) => { if (e.target === yapeModal) yapeModal.classList.remove('open'); });

Â  Â  Â  Â  if (commentsModalCloseBtn) {
Â  Â  Â  Â  Â  Â  commentsModalCloseBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (commentsModal) commentsModal.classList.remove('open');
Â  Â  Â  Â  Â  Â  Â  Â  if (commentsUnsubscribe) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  commentsUnsubscribe();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  commentsUnsubscribe = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  currentItem = null;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  if (commentsModal) commentsModal.addEventListener('click', (e) => { if (e.target === commentsModal) commentsModal.classList.remove('open'); });

Â  Â  Â  Â  if (submitCommentBtn) {
Â  Â  Â  Â  Â  Â  submitCommentBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (currentItem && commentInput) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const commentsCollection = collection(db, `artifacts/${appId}/public/data/comments`, currentItem.id, "messages");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submitComment(commentInput, submitCommentBtn, commentsCollection);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (downloadGuideModalCloseBtn) {
Â  Â  Â  Â  Â  Â  downloadGuideModalCloseBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (downloadGuideModal) downloadGuideModal.classList.remove('open');
Â  Â  Â  Â  Â  Â  Â  Â  currentDownloadLink = null;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  if (downloadGuideModal) downloadGuideModal.addEventListener('click', (e) => { if (e.target === downloadGuideModal) downloadGuideModal.classList.remove('open'); });

Â  Â  Â  Â  if (downloadGuideContinueBtn) {
Â  Â  Â  Â  Â  Â  downloadGuideContinueBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (downloadGuideModal) downloadGuideModal.classList.remove('open');
Â  Â  Â  Â  Â  Â  Â  Â  if (currentDownloadLink) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(currentDownloadLink, '_blank');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentDownloadLink = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (adminLoginBtn) {
Â  Â  Â  Â  Â  Â  adminLoginBtn.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!auth) return;
Â  Â  Â  Â  Â  Â  Â  Â  const provider = new GoogleAuthProvider();
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await signInWithPopup(auth, provider);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error al iniciar sesiÃ³n con Google:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (adminStatus) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminStatus.textContent = "Error al iniciar sesiÃ³n.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminStatus.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- INICIALIZACIÃ“N DE FIREBASE (NUEVO FLUJO) ---
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  db = getFirestore(app);
Â  Â  Â  Â  Â  Â  auth = getAuth(app);

Â  Â  Â  Â  Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  const aiChatGreeting = document.getElementById('ai-chat-greeting');
Â  Â  Â  Â  Â  Â  Â  Â  const aiChatSubGreeting = document.getElementById('ai-chat-subgreeting');

Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Usuario detectado:", user.uid, "AnÃ³nimo:", user.isAnonymous);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (user.uid === ADMIN_ID && adminStatus) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminStatus.textContent = `Â¡Bienvenido, Admin! (${user.displayName || 'Admin'})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminStatus.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!user.isAnonymous && aiChatGreeting && aiChatSubGreeting) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatGreeting.textContent = `Â¡Hola, ${user.displayName || 'Usuario'}! ğŸ‘‹`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatSubGreeting.textContent = `Tu asistente IA-Lahs estÃ¡ lista.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (aiChatGreeting && aiChatSubGreeting) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatGreeting.textContent = `Â¡Hola! ğŸ‘‹`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatSubGreeting.textContent = `Inicia sesiÃ³n para una mejor experiencia.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Sin usuario. Iniciando sesiÃ³n anÃ³nima.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (aiChatGreeting && aiChatSubGreeting) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatGreeting.textContent = `Â¡Hola! ğŸ‘‹`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aiChatSubGreeting.textContent = `Inicia sesiÃ³n para una mejor experiencia.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // (MODIFICADO) Solo cargar datos DESPUÃ‰S de que la autenticaciÃ³n estÃ© lista
Â  Â  Â  Â  Â  Â  Â  Â  if (!authReady) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authReady = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Â¡Este es el inicio! Cargar todo desde Firebase.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadSoftwareAndCategoriesFromFirebase();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.dispatchEvent(new Event('firebaseAuthReady'));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Error fatal al inicializar Firebase:", e);
Â  Â  Â  Â  Â  Â  const contentGridPc = document.getElementById('content-grid-pc');
Â  Â  Â  Â  Â  Â  if (contentGridPc) contentGridPc.innerHTML = `<p class="text-red-500 text-lg">Error fatal al inicializar Firebase: ${e.message}</p>`;
Â  Â  Â  Â  Â  Â  if (!authReady) {
Â  Â  Â  Â  Â  Â  Â  Â  authReady = true;Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.dispatchEvent(new Event('firebaseAuthReady'));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (isMobileDevice()) {
Â  Â  Â  Â  Â  Â  const mobileAd = document.getElementById('mobile-ad-top');
Â  Â  Â  Â  Â  Â  if (mobileAd) mobileAd.classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  </script>
Â  Â  <!-- =================================================================================== -->
Â  Â  <!-- ===== FIN DEL NUEVO MOTOR JAVASCRIPT ===== -->
Â  Â  <!-- =================================================================================== -->

<!-- Banner en el footer (PC y mÃ³vil) -->
<div class="flex justify-center my-6">
Â  <div class="rounded-xl overflow-hidden shadow-sm border border-slate-200 bg-white/80 p-2">
<script type="text/javascript">
	atOptions = {
		'key' : '982a5d0f66cf17a976727779b97a1183',
		'format' : 'iframe',
		'height' : 250,
		'width' : 300,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//honeywhyvowel.com/982a5d0f66cf17a976727779b97a1183/invoke.js"></script>Â Â 
</div>
</div>
<!-- Fin del banner en el footer -->
Â  Â  <!-- Widget de TraducciÃ³n de Google (Contenedor) -->
Â  Â  <div id="google_translate_element_wrapper">
Â  Â  Â  Â  <div id="google_translate_element"></div>
Â  Â  </div>

Â  Â  <!-- Script de Google Translate -->
Â  Â  <script type="text/javascript">
Â  Â  function googleTranslateElementInit() {
Â  Â  Â  new google.translate.TranslateElement({
Â  Â  Â  Â  pageLanguage: 'es',
Â  Â  Â  Â  includedLanguages: 'es,en,pt,de,fr,ru,id,hi,ar,tr,vi,pl,it,th',
Â  Â  Â  Â  layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
Â  Â  Â  Â  autoDisplay: true // Muestra banner de traducciÃ³n automÃ¡tico
Â  Â  Â  }, 'google_translate_element');
Â  Â  }
Â  Â  </script>
Â  Â  <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</body>
</html>Â´Â´Â´ quiero que carge normalmente y no ver aqui en este esas estrellas y figuras horribles