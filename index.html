<!DOCTYPE html>
<!-- üß† CEREBRO ACTIVO: Idioma din√°mico detectado por JS, predeterminado a ES -->
<html lang="es" itemscope itemtype="http://schema.org/WebPage">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- üöÄ SEO SUPREMO: TITULO Y METADATOS (BILING√úE READY) -->
    <title>Descargar Ultima Version - Software, Juegos y APKs Full (2025)</title>
    <meta name="description" content="Sitio Oficial. Descarga las √∫ltimas versiones de Adobe, Office, Juegos PC y Android (APKs Mods). Software verificado, libre de virus, enlaces directos y actualizados diariamente.">
    
    <!-- C√ìDIGO DE VERIFICACI√ìN ACTUALIZADO -->
    <meta name="google-site-verification" content="DYRIkO39TeXEB003bY7eWOqeAGyh4_-E_ukzoIy2a98" />
    
    <!-- PALABRAS CLAVE H√çBRIDAS (INGL√âS/ESPA√ëOL) PARA ATRAER CPM ALTO -->
    <meta name="keywords" content="descargar software gratis, free software download, descargar juegos pc full, full pc games, apk mod 2025, adobe activado, ultima version, download latest version, software seguro, safe downloads, cracked software, premium apk">
    
    <meta name="author" content="Descargar Ultima Version Team">
    <meta name="robots" content="index, follow, max-image-preview:large">
    
    <!-- ‚ö° COMUNICACI√ìN CONSTANTE CON GOOGLE -->
    <meta name="revisit-after" content="1 days">
    <meta name="theme-color" content="#3b82f6">
    
    <!-- üåé ALCANCE GLOBAL (GRINGO MODE) -->
    <meta name="distribution" content="Global">
    <meta name="geo.region" content="US, ES, MX, AR, CO, PE">
    
    <!-- CANONICAL: LA IDENTIDAD √öNICA -->
    <link rel="canonical" href="https://www.downloadlatestversion.com/" />
    
    <!-- SE√ëALES DE IDIOMA PARA GOOGLE (HREFLANG) -->
    <link rel="alternate" hreflang="es" href="https://www.downloadlatestversion.com/" />
    <link rel="alternate" hreflang="en" href="https://www.downloadlatestversion.com/?lang=en" />
    <link rel="alternate" hreflang="x-default" href="https://www.downloadlatestversion.com/" />

    <!-- üí∞ GOOGLE ADSENSE (CONFIGURACI√ìN DE PAGO - CONFIRMADO QUE EST√Å AQU√ç) -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5974539248411809" crossorigin="anonymous"></script>
    
    <!-- OPEN GRAPH (Redes Sociales) -->
    <meta property="og:locale" content="es_ES">
    <meta property="og:locale:alternate" content="en_US">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Descargar √öltima Versi√≥n - El Repositorio #1 de Software">
    <meta property="og:description" content="Olv√≠date de los virus. Aqu√≠ verificamos cada archivo manualmente. Descarga directa y segura.">
    <meta property="og:url" content="https://www.downloadlatestversion.com/">
    <meta property="og:site_name" content="Descargar Ultima Version">
    <meta property="og:image" content="https://www.downloadlatestversion.com/imagen-preview.jpg?v=2">
    <meta property="og:image:alt" content="Preview de Descargas">
    
    <!-- TWITTER CARDS -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Descargar √öltima Versi√≥n - Software Full">
    <meta name="twitter:description" content="Descargas verificadas y seguras para PC y Android.">
    <meta name="twitter:image" content="https://www.downloadlatestversion.com/imagen-preview.jpg?v=2">

    <!-- PRECONEXIONES (Velocidad Extrema) -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://firestore.googleapis.com">
    <link rel="preconnect" href="https://www.google-analytics.com">

    <!-- ESTRUCTURA DE DATOS BASE (SCHEMA.ORG) - INICIAL -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Descargar Ultima Version",
      "alternateName": "Download Latest Version",
      "url": "https://www.downloadlatestversion.com/",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://www.downloadlatestversion.com/?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    
    <!-- ESTILOS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; margin: 0; } 
        .hidden { display: none !important; }
        svg { width: 24px; height: 24px; display: inline-block; vertical-align: middle; }
        img { max-width: 100%; height: auto; display: block; }
        
        /* LOGO */
        .logo { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #38bdf8, #3b82f6); border-radius: 12px; color: white; font-weight: 800; font-size: 28px; transform: rotate(-10deg); box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }
        
        /* GRID OPTIMIZADO */
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; content-visibility: auto; contain-intrinsic-size: 1000px; }
        
        /* Modales */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; backdrop-filter: blur(5px); }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 0; border-radius: 16px; max-width: 900px; width: 95%; position: relative; margin: 1rem; transform: scale(0.95); transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; overflow-x: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-overlay.open .modal-content { transform: scale(1); }
        
        /* Video Containers */
        .modal-video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background: #000; }
        .modal-video-container-vertical { position: relative; width: 100%; padding-bottom: 177.77%; height: 0; overflow: hidden; border-radius: 12px; background: #000; }
        .modal-video-container iframe, .modal-video-container-vertical iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        
        /* UI Elements */
        .nav-link { cursor: pointer; }
        .nav-link.active { color: #2563eb; font-weight: 700; }
        .tab-button { cursor: pointer; transition: all 0.2s; }
        .active-tab { border-bottom-color: #2563eb !important; color: #2563eb !important; background-color: #eff6ff !important; }
        
        /* FB Style Main Tabs */
        .fb-main-tab { cursor: pointer; position: relative; transition: all 0.2s; color: #65676b; border-bottom: 3px solid transparent; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .fb-main-tab:hover { background-color: #f2f2f2; border-radius: 8px; }
        .fb-main-tab.active { color: #1b74e4; border-bottom-color: #1b74e4; border-radius: 0; }
        .fb-main-tab.active:hover { background-color: transparent; }

        /* Chat IA */
        #ai-chat-content { width: 95%; max-width: 450px; height: 80vh; max-height: 600px; display: flex; flex-direction: column; }
        #ai-chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; background: #fff; }
        .ai-chat-bubble { max-width: 85%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.5rem; word-wrap: break-word; line-height: 1.4; font-size: 0.95rem; }
        .ai-chat-bubble.user { background-color: #3b82f6; color: white; border-bottom-right-radius: 0.25rem; align-self: flex-end; margin-left: auto; }
        .ai-chat-bubble.ai { background-color: #f3f4f6; color: #1f2937; border-bottom-left-radius: 0.25rem; align-self: flex-start; margin-right: auto; border: 1px solid #e5e7eb; }
        
        /* SEARCH SUGGESTIONS (GOOGLE STYLE) */
        #search-suggestions { position: absolute; bottom: 100%; left: 0; right: 0; background: white; border: 1px solid #cbd5e1; border-radius: 0.5rem; box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1); max-height: 150px; overflow-y: auto; z-index: 50; display: none; margin-bottom: 4px; }
        .suggestion-item { padding: 0.5rem 1rem; cursor: pointer; font-size: 0.9rem; color: #475569; border-bottom: 1px solid #f1f5f9; transition: background 0.2s; text-align: left; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #eff6ff; color: #2563eb; }
        .suggestion-match { font-weight: bold; color: #2563eb; }

        /* üî• NUEVO ESTILO PARA SMART TAGS (Filtros C√°psula) */
        .smart-tag-btn { 
            display: inline-flex; align-items: center; gap: 6px; 
            padding: 8px 16px; border-radius: 99px; 
            font-weight: 700; font-size: 0.85rem; 
            transition: all 0.2s; white-space: nowrap;
            border: 1px solid #e2e8f0; background: white; color: #64748b;
            cursor: pointer;
        }
        .smart-tag-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-color: #cbd5e1; color: #334155; }
        .smart-tag-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        
        /* üî• ESTILOS PARA EL GATE DE DESCARGA (Waiting Room) */
        .gate-disabled { background-color: #94a3b8 !important; cursor: not-allowed; transform: none !important; animation: none !important; }
        .gate-ready { background: linear-gradient(to right, #16a34a, #15803d) !important; animation: pulse 2s infinite; }
        .progress-track { width: 100%; height: 6px; background: #e2e8f0; border-radius: 99px; overflow: hidden; margin-bottom: 1rem; }
        .progress-bar-gate { height: 100%; background: #3b82f6; width: 0%; transition: width 0.1s linear; }

        /* Animations */
        @keyframes highlight-card { 0% { transform: scale(1); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .card-highlight { animation: highlight-card 2s ease-in-out; border-color: #2563eb; z-index: 10; position: relative; }
        
        @keyframes flicker { 0% { transform: rotate(-5deg) scale(1); } 50% { transform: rotate(5deg) scale(1.1); } 100% { transform: rotate(-5deg) scale(1); } }
        .anim-fire { display: inline-block; animation: flicker 1s infinite alternate ease-in-out; }

        @keyframes pulse-telegram { 0% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7); transform: scale(1); } 70% { box-shadow: 0 0 0 10px rgba(56, 189, 248, 0); transform: scale(1.1); } 100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); transform: scale(1); } }
        .telegram-pulse { animation: pulse-telegram 2s infinite; }

        /* Banners Mobile/PC */
        @media (max-width: 768px) { #mobile-ad-top { position: fixed; top: 0; left: 0; width: 100%; height: 60px; display: flex !important; justify-content: center; align-items: center; background: #fff; z-index: 50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); } body { padding-top: 60px; } #pc-ad-top-downloads { display: none !important; } }
        @media (min-width: 769px) { #mobile-ad-top { display: none !important; } #pc-ad-top-downloads { display: flex !important; justify-content: center; align-items: center; width: 100%; max-width: 728px; margin: 0 auto; } }

        /* Comentarios & Pizarra */
        .comment { background-color: #f8fafc !important; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .comment.admin-comment { background-color: #f0f9ff !important; border-color: #bae6fd; }
        .request-board-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 0.75rem 1rem; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 0.75rem; gap: 10px; }
        .request-text { flex: 1; min-width: 0; word-break: break-word; overflow-wrap: anywhere; } 
        .vote-btn { background-color: #f1f5f9; color: #64748b; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; cursor: pointer; flex-shrink: 0; }
        .vote-btn.voted { background-color: #dbeafe; color: #2563eb; border: 1px solid #93c5fd; }
        
        /* Scroll Horizontal & Stories */
        .scroll-container { -ms-overflow-style: none; scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
        .scroll-container::-webkit-scrollbar { height: 6px; }
        .scroll-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }

        /* --- STORIES ESTILO FACEBOOK MEJORADO --- */
        .story-card { width: 110px !important; height: 195px !important; flex: 0 0 auto; border-radius: 12px; position: relative; overflow: hidden; border: 2px solid #3b82f6; padding: 2px; background: white; transition: transform 0.2s; user-select: none; cursor: pointer; }
        .story-card:hover { transform: scale(1.03); }
        .story-inner { width: 100%; height: 100%; position: relative; border-radius: 10px; overflow: hidden; }
        .story-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; display: block; }
        .story-card:hover .story-img { transform: scale(1.1); }
        .story-overlay-top { position: absolute; top: 0; left: 0; width: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%); padding: 8px 4px; pointer-events: none; }
        .story-overlay-bottom { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%); padding: 8px 4px; display: flex; flex-direction: column; justify-content: flex-end; height: 50%; pointer-events: none; }
        .story-title { font-size: 0.75rem; font-weight: 700; line-height: 1.1; text-align: left; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.9); display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .story-version-badge { background-color: #fbbf24; color: #78350f; font-size: 0.65rem; font-weight: 800; padding: 2px 6px; border-radius: 999px; align-self: flex-start; margin-top: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        @media (min-width: 640px) { .story-card { width: 125px !important; height: 210px !important; } }
        
        /* Story Viewer Modal Styles */
        #story-viewer-modal .modal-content { background: #000; width: 100%; height: 100%; max-width: 100%; max-height: 100vh; display: flex; flex-direction: column; border-radius: 0; overflow: hidden; }
        @media (min-width: 640px) { #story-viewer-modal .modal-content { max-width: 480px; height: 90vh; border-radius: 16px; } }
        .story-viewer-header { position: absolute; top: 0; left: 0; right: 0; z-index: 30; padding: 16px; padding-top: 24px; background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); display: flex; justify-content: space-between; items-center; }
        .story-progress-bar-container { position: absolute; top: 8px; left: 8px; right: 8px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; z-index: 40; display: flex; gap: 4px; }
        .story-progress-segment { height: 100%; flex: 1; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; }
        .story-progress-fill { height: 100%; width: 0%; background: white; }
        .story-viewer-body { flex-grow: 1; position: relative; display: flex; align-items: center; justify-content: center; background: #111; }
        .story-nav-area { position: absolute; top: 0; bottom: 0; width: 35%; z-index: 25; }
        .story-nav-left { left: 0; }
        .story-nav-right { right: 0; }
        .story-viewer-footer { background: linear-gradient(to top, #000 20%, transparent); padding: 20px; z-index: 30; position: absolute; bottom: 0; left: 0; right: 0; color: white; }
        
        .robot-link-btn { display: inline-flex; align-items: center; gap: 4px; background-color: #eff6ff; color: #2563eb; font-size: 0.75rem; padding: 4px 10px; border-radius: 6px; border: 1px solid #bfdbfe; text-decoration: none; margin-top: 6px; font-weight: 700; transition: all 0.2s; }
        .robot-link-btn:hover { background-color: #dbeafe; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1); }
    </style>
    <link rel="icon" type="image/png" href="favicon.png">
</head>

<body class="text-slate-800 flex flex-col min-h-screen">
    <div id="mobile-ad-top">
      <div id="adsterra-mobile">
        <script type="text/javascript">
            atOptions = { 'key' : '8bc9527f0527b1ea5f2e3fc1efd1083d', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <!-- Note: Ad scripts may not run in all preview environments -->
        <script type="text/javascript" src="//honeywhyvowel.com/8bc9527f0527b1ea5f2e3fc1efd1083d/invoke.js"></script>
      </div>
    </div>
    
    <!-- CONTENEDOR PRINCIPAL -->
    <div id="app" class="w-full flex-grow bg-[#f0f2f5] min-h-screen relative">
        
        <!-- TELEGRAM FLOATING BUTTON (TOP RIGHT) -->
        <a href="https://t.me/descargas_ultima_version_vip" target="_blank" rel="noopener noreferrer" class="fixed top-20 right-4 z-50 telegram-pulse bg-white rounded-full p-1 shadow-xl cursor-pointer hover:scale-110 transition-transform" title="√önete a Telegram">
            <div class="bg-[#229ED9] text-white w-12 h-12 rounded-full flex items-center justify-center">
                <svg class="w-7 h-7 -ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
            </div>
        </a>

        <!-- 1. HEADER (Estilo Facebook Mobile Clean) -->
        <header class="bg-white sticky top-0 z-40 border-b border-slate-200 shadow-sm">
            <div class="container mx-auto px-4 lg:px-6">
                <!-- Top Row: Logo & Title -->
                <div class="flex items-center justify-between py-3">
                    <div class="flex items-center gap-3">
                        <div class="logo">D</div>
                        <h1 id="site-title" class="text-xl sm:text-2xl font-extrabold text-slate-900 tracking-tight">Descargar Ultima Version</h1>
                    </div>
                </div>
            
                <!-- 2. SEARCH / THINKING BOX -->
                <div class="pb-3">
                    <div id="ai-trigger-btn" class="flex items-center gap-3 bg-slate-100 hover:bg-slate-200 transition-colors cursor-pointer rounded-full px-4 py-2.5 border border-slate-200/50 shadow-inner" role="button" aria-label="Buscar software con IA">
                         <div class="flex-shrink-0 text-slate-400">
                             <!-- Lupa Grande -->
                             <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                         </div>
                         <div class="flex-grow">
                             <span id="search-placeholder" class="text-slate-500 font-medium text-base select-none block leading-tight">¬øQu√© software est√°s buscando...?</span>
                         </div>
                    </div>
                </div>
            
                <!-- 3. MAIN TABS (Estilo Muro vs Reels) - MODIFICADO: ELIMINADA PESTA√ëA GUIA -->
                <nav class="flex mt-1" role="navigation">
                    <button class="flex-1 py-3 text-center font-bold text-[13px] sm:text-[15px] fb-main-tab active" id="tab-updates" data-target="view-updates">
                        <span class="relative z-10 flex items-center justify-center gap-1">
                            <span class="text-lg anim-fire">üî•</span>
                            <span id="tab-updates-text">√öltimas Actualizaciones</span>
                            <span class="text-lg">üéâ</span>
                        </span>
                    </button>
                    <!-- Gu√≠a Eliminada como se solicit√≥ -->
                </nav>
            </div>
        </header>

        <!-- CONTENIDO PRINCIPAL -->
        <div class="container mx-auto px-0 sm:px-4 lg:px-8 py-4">
            
            <!-- VISTA 1: √öLTIMAS ACTUALIZACIONES -->
            <div id="view-updates" class="fade-in-view">
                
                <!-- STORIES CONTAINER (Renovado) -->
                <section class="mb-4 bg-white sm:rounded-xl p-4 shadow-sm border border-slate-200">
                    <h3 id="stories-title" class="text-sm font-bold text-slate-500 mb-3 px-1 flex items-center gap-1">
                        <span class="text-blue-500 text-lg">‚ú®</span> Reci√©n Agregados
                    </h3>
                    <div id="stories-container" class="flex overflow-x-auto gap-3 py-2 px-1 snap-x scroll-container no-scrollbar cursor-grab">
                        <!-- Skeletons -->
                        <div class="story-card animate-pulse bg-slate-100 border-slate-200"></div>
                        <div class="story-card animate-pulse bg-slate-100 border-slate-200"></div>
                        <div class="story-card animate-pulse bg-slate-100 border-slate-200"></div>
                    </div>
                </section>
                
                <!-- BIENVENIDA (Restaurada Original) -->
                <div class="mt-2 mb-6 relative rounded-2xl shadow-xl overflow-hidden border border-slate-600/50 group mx-2 sm:mx-0">
                    <div class="absolute inset-0">
                        <img src="imagen-preview.jpg?v=1" class="w-full h-full object-cover opacity-80" alt="Software Premium Background">
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-br from-slate-900/90 via-slate-900/70 to-blue-900/60 backdrop-blur-[2px]"></div>
                    <div class="relative z-10 p-6 sm:p-10 text-center">
                        <h2 class="text-2xl sm:text-3xl font-bold text-white mb-4 flex flex-col sm:flex-row items-center justify-center gap-3">
                            <span class="text-4xl">üõ°Ô∏è</span> <span id="hero-title">Tu Zona Segura de Descargas</span>
                        </h2>
                        <p id="hero-desc" class="text-slate-100 text-base sm:text-lg font-medium leading-relaxed max-w-4xl mx-auto">
                            Internet es una jungla llena de virus y enlaces rotos. 
                            <span class="text-cyan-300 font-bold bg-blue-900/40 px-2 rounded border border-blue-500/30">Nosotros somos tu filtro.</span>
                            Nuestro equipo rastrea y verifica manualmente los mejores archivos de la red para tra√©rtelos limpios y seguros.
                        </p>
                        <div class="mt-8 bg-white/10 backdrop-blur-md p-5 rounded-xl border border-white/20 shadow-2xl text-left max-w-3xl mx-auto">
                            <div class="flex flex-col sm:flex-row gap-4 items-start">
                                <span class="text-4xl sm:text-3xl self-center sm:self-start bg-yellow-500/20 rounded-full p-2">üí°</span>
                                <div class="text-slate-100 text-sm sm:text-base leading-relaxed w-full">
                                    <strong class="text-yellow-300 tracking-wide text-lg block sm:inline mb-1 sm:mb-0">‚ö†Ô∏è NOTA HONESTA:</strong> 
                                    <span id="hero-note-1">Para mantener este proyecto vivo y libre de virus, usamos una publicidad modesta.</span> <strong class="text-red-300" id="hero-note-strong">Al dar clic en Descargar, se abrir√° una ventana publicitaria.</strong>
                                    <br class="hidden sm:block mb-2">
                                    <span id="hero-note-2">Solo ci√©rrala y vuelve. Es el √∫nico precio por todo nuestro trabajo.</span>
                                    <span id="hero-footer" class="block mt-3 font-bold text-cyan-200 text-base border-l-4 border-cyan-400 pl-3 bg-cyan-900/20 p-2 rounded-r">
                                        ¬°Gracias por tu comprensi√≥n y apoyo!
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SUB-MENU CATEGORIAS (SMART TAGS REEMPLAZO) -->
                <nav id="nav-container" class="mx-2 sm:mx-0 mb-6 p-3 bg-white rounded-xl shadow-sm border border-slate-200 overflow-x-auto no-scrollbar" role="navigation">
                    <p class="text-slate-500 text-sm text-center">Cargando filtros...</p>
                </nav>
                
                <!-- TOP DOWNLOADS -->
                <section id="top-downloads-container" class="mx-2 sm:mx-0 mb-6 p-4 bg-white rounded-xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                            <span class="text-red-500">üî•</span> <span id="top-title">Lo M√°s Popular</span>
                        </h2>
                        <div id="pc-ad-top-downloads" class="hidden sm:block">
                           <script type="text/javascript">atOptions = { 'key' : 'a09ade7f1de75ea02cb1d7597a7a2ae6', 'format' : 'iframe', 'height' : 90, 'width' : 728, 'params' : {} };</script>
                           <script type="text/javascript" src="//honeywhyvowel.com/a09ade7f1de75ea02cb1d7597a7a2ae6/invoke.js"></script>
                        </div>
                    </div>
                    <div id="top-downloads-list" class="flex overflow-x-auto pb-2 gap-3 snap-x snap-mandatory scroll-container">
                        <p class="text-slate-500 text-sm w-full text-center py-4">Cargando...</p>
                    </div>
                </section>
                
                <!-- SUB-TABS (PC vs Mobile Filter) -->
                <div class="mx-2 sm:mx-0 mb-4 bg-white rounded-lg shadow-sm border border-slate-200 p-1 flex">
                      <button id="tab-pc" class="tab-button flex-1 text-blue-700 bg-blue-50 font-bold py-2 rounded-md text-sm transition-all shadow-sm">üñ•Ô∏è PC</button>
                      <button id="tab-mobile" class="tab-button flex-1 text-slate-500 bg-transparent font-bold py-2 rounded-md text-sm transition-all">üì± M√≥vil</button>
                </div>

                <!-- MAIN CONTENT GRID -->
                <main class="w-full px-2 sm:px-0">
                    <div id="content-pc" class="tab-content">
                        <h2 class="text-lg font-bold text-slate-700 mb-4 border-l-4 border-blue-600 pl-3">Feed de PC</h2>
                        <div id="content-grid-pc" class="card-container"><p class="text-slate-500 text-sm">Cargando...</p></div>
                        <div id="no-results-pc" class="hidden text-center py-16"><h2 class="text-xl font-semibold text-slate-700">No hay resultados</h2></div>
                    </div>
                    <div id="content-mobile" class="tab-content hidden">
                        <h2 class="text-lg font-bold text-slate-700 mb-4 border-l-4 border-green-600 pl-3">Feed de M√≥vil</h2>
                        <div id="content-grid-mobile" class="card-container"><p class="text-slate-500 text-sm">Cargando...</p></div>
                        <div id="no-results-mobile" class="hidden text-center py-16"><h2 class="text-xl font-semibold text-slate-700">No hay resultados</h2></div>
                    </div>
                </main>
            </div>
            
            <!-- VISTA 2: GU√çA DE DESCARGA -->
            <div id="view-guide" class="hidden fade-in-view px-2 sm:px-0">
                <article class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                    <div class="p-6 text-center border-b border-slate-100">
                         <div class="inline-block p-3 bg-blue-50 rounded-full mb-3 text-4xl">üéì</div>
                         <h2 class="text-2xl font-bold text-slate-900 mb-2">Aprende a Descargar</h2>
                         <p class="text-slate-600 max-w-md mx-auto">Sigue estos sencillos pasos para saltar la publicidad y obtener tus archivos de forma segura.</p>
                    </div>
                    <div class="bg-black p-0 md:p-8 flex justify-center items-center">
                        <div id="guide-video-wrapper" class="w-full max-w-3xl aspect-video relative rounded-lg overflow-hidden shadow-2xl border border-slate-800">
                             <div class="absolute inset-0 flex items-center justify-center text-white/50"><p>Cargando video...</p></div>
                        </div>
                    </div>
                    <div class="p-6 bg-slate-50">
                         <div class="flex flex-col gap-4 max-w-lg mx-auto">
                             <div class="flex items-start gap-3"><span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0 mt-0.5">1</span><p class="text-sm text-slate-700">Haz clic en "Descargar" en la ficha del software.</p></div>
                             <div class="flex items-start gap-3"><span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0 mt-0.5">2</span><p class="text-sm text-slate-700">En el acortador, espera la cuenta regresiva o resuelve el captcha.</p></div>
                             <div class="flex items-start gap-3"><span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0 mt-0.5">3</span><p class="text-sm text-slate-700">Cierra las pesta√±as de publicidad que se abran.</p></div>
                         </div>
                    </div>
                </article>
            </div>

        </div>
    </div>
    
    <!-- STORY VIEWER MODAL (NUEVO CON TIMER) -->
    <div id="story-viewer-modal" class="modal-overlay">
        <div class="modal-content relative w-full h-full sm:h-auto sm:max-w-md sm:rounded-2xl overflow-hidden bg-black flex flex-col">
            <!-- Progress Bar Container -->
            <div id="story-progress-container" class="story-progress-bar-container">
                <!-- Bars injected via JS -->
            </div>

            <!-- Tap Areas -->
            <div class="story-nav-area story-nav-left" id="story-prev-area"></div>
            <div class="story-nav-area story-nav-right" id="story-next-area"></div>

            <!-- Header -->
            <div class="story-viewer-header">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-sm shadow-sm border border-white/20">D</div>
                    <div>
                        <p class="text-white text-sm font-bold leading-tight drop-shadow-md" id="story-viewer-title">App Name</p>
                        <p class="text-gray-300 text-xs drop-shadow-md" id="story-viewer-date">Reciente</p>
                    </div>
                </div>
                <button id="story-viewer-modal-close" class="text-white hover:text-gray-300 p-2 z-50 rounded-full hover:bg-white/10 transition-colors">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Body Image -->
            <div class="story-viewer-body">
                <img id="story-viewer-img" src="" class="max-h-full max-w-full object-contain" alt="Story Image">
            </div>
            
            <!-- Footer Content -->
            <div class="story-viewer-footer">
                <div class="mb-4">
                    <span class="inline-block bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-0.5 rounded-full mb-2 shadow-sm" id="story-viewer-version">v1.0</span>
                    <h3 class="text-lg font-bold text-white mb-1 drop-shadow-md">¬øQu√© hay de nuevo?</h3>
                    <p class="text-gray-100 text-sm leading-snug line-clamp-3 drop-shadow-md" id="story-viewer-desc">...</p>
                </div>
                <button id="story-viewer-download-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition-transform transform active:scale-95 flex items-center justify-center gap-2 border border-blue-400/30">
                    <span id="story-download-text">DESCARGAR AHORA</span>
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- üî• MODAL: GATE DE DESCARGA PRO (SISTEMA DE ESPERA CON VIDEO) üî• -->
    <div id="download-gate-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="download-gate-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 z-50 bg-white rounded-full p-1 shadow-sm"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <div class="flex flex-col md:flex-row h-full">
                <!-- ZONA DE VIDEO -->
                <div class="w-full md:w-2/3 bg-black relative">
                      <div id="video-container-wrapper" class="modal-video-container h-full rounded-none md:rounded-l-xl">
                        <!-- Puedes reemplazar este src con tu propio video de YouTube monetizado o un video de Adsterra si te dan VAST -->
                        <iframe id="gate-video-iframe" src="" frameborder="0" allow="autoplay; fullscreen" allowfullscreen class="w-full h-full absolute inset-0"></iframe>
                    </div>
                </div>
                <!-- ZONA DE ESPERA Y ADS -->
                <div class="w-full md:w-1/3 p-4 md:p-6 flex flex-col justify-center items-center bg-gradient-to-br from-white to-slate-50 relative">
                    <h2 class="text-xl md:text-2xl font-extrabold text-slate-900 mb-2 text-center" id="gate-title">Descarga Segura</h2>
                    
                    <!-- üí∞ ESPACIO PARA BANNER ADSTERRA (300x250) - ACTIVADO -->
                    <div id="adsterra-modal-banner" class="w-full h-[250px] bg-gray-100 flex items-center justify-center rounded-lg mb-4 overflow-hidden relative z-10">
                        <script type="text/javascript">
                            atOptions = {
                                'key' : '94c60ba5da04780ec04f3f012ffe8071',
                                'format' : 'iframe',
                                'height' : 250,
                                'width' : 300,
                                'params' : {}
                            };
                        </script>
                        <script type="text/javascript" src="//honeywhyvowel.com/94c60ba5da04780ec04f3f012ffe8071/invoke.js"></script>
                    </div>

                    <div class="w-full mb-4">
                        <div class="progress-track">
                            <div id="gate-progress" class="progress-bar-gate"></div>
                        </div>
                        <p class="text-slate-600 text-sm text-center font-mono" id="gate-status">Iniciando...</p>
                    </div>

                    <button id="proceed-download-btn" disabled class="gate-disabled w-full bg-slate-400 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition text-lg flex items-center justify-center gap-2">
                        <span id="gate-btn-text">Espere por favor...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="yape-modal" class="modal-overlay">
        <div class="yape-modal-content bg-white p-6 rounded-xl max-w-sm w-full relative text-center">
            <button id="yape-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-xl font-bold text-slate-900 mb-4">Donar con Yape</h2>
            <img src="imagenes/yape.jpeg" alt="QR Yape" class="w-48 h-48 mx-auto rounded-lg border border-slate-200 mb-6" onerror="this.style.display='none'">
            <button id="open-yape-btn" class="w-full bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-purple-700 transition-colors">Abrir Yape</button>
        </div>
    </div>
    
    <div id="comments-modal" class="modal-overlay">
        <div class="comments-modal-content">
            <button id="comments-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-xl font-bold text-slate-900 mb-4" id="comments-modal-title">Comentarios</h2>
            <div id="comments-list" class="flex-grow"><p class="text-slate-500 text-sm">Cargando...</p></div>
            <div class="mt-4 pt-4 border-t border-slate-200">
                <textarea id="comment-input" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Escribe tu comentario..."></textarea>
                <div class="flex justify-between items-center mt-3">
                      <button id="report-link-btn" class="text-xs text-red-500 font-bold hover:text-red-700 flex items-center gap-1 border border-red-200 bg-red-50 px-3 py-1.5 rounded-full transition-colors">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        <span id="report-text">Reportar Link Roto</span>
                      </button>
                    <button id="submit-comment-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Enviar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="download-guide-modal" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <button id="download-guide-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="ml-4 text-xl sm:text-2xl font-bold text-slate-900" id="guide-modal-title">GU√çA R√ÅPIDA</h2>
            <p class="text-slate-700 text-base mb-5" id="guide-modal-desc">Sigue los pasos en el video para saltar publicidad.</p>
            <button id="download-guide-continue-btn" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 text-lg">¬°Entendido!</button>
        </div>
    </div>

    <div id="admin-dashboard-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="admin-dashboard-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-xl font-bold text-slate-900 mb-4 p-4 border-b">Panel de Actividad & Herramientas</h2>
            <div class="p-4">
                <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-bold text-yellow-800 mb-2">Herramienta de Recuperaci√≥n</h3>
                    <p class="text-sm text-yellow-700 mb-3">Si te faltan fichas de la web anterior, pulsa este bot√≥n. El sistema buscar√° en la base de datos vieja y las copiar√° aqu√≠.</p>
                    <button id="migrate-db-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded shadow-md transition-colors flex justify-center items-center gap-2">
                        <span>üîÑ IMPORTAR DATOS DE LA WEB ANTIGUA</span>
                    </button>
                    <p id="migration-status" class="text-xs text-center mt-2 font-mono text-slate-500"></p>
                </div>
                <h3 class="font-bold text-slate-700 mb-2">Actividad Reciente</h3>
                <div id="admin-logs-container" class="overflow-y-auto" style="max-height: 40vh;">
                    <p class="text-slate-500 text-center">Cargando actividad...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="ai-chat-modal" class="modal-overlay">
        <div id="ai-chat-content" class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-slate-200 bg-slate-50">
                <div><h2 id="ai-chat-greeting" class="text-lg font-bold text-slate-900">¬°Hola! üëã</h2></div>
                <button id="ai-speaker-toggle" class="p-2 rounded-full text-slate-600 hover:bg-slate-200 transition-colors"> 
                     <svg id="speaker-on" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M10 21v-7m0 0V3m0 0a2 2 0 100 4v0m0-4a2 2 0 010 4v0m7.536-1.464a9 9 0 010 12.728M10 3H7a2 2 0 00-2 2v14a2 2 0 002 2h3m0-18v18"></path></svg>
                     <svg id="speaker-off" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15.1l-2.829 2.829a1 1 0 01-1.414-1.414L15.9 2.8A1 1 0 0117.3 4.2l-2.8 2.8m0 0a5 5 0 01-7.072 0M10 21v-7m0 0V3m0 0a2 2 0 100 4v0m0-4a2 2 0 010 4v0m7.536-1.464a9 9 0 010 12.728M10 3H7a2 2 0 00-2 2v14a2 2 0 002 2h3m0-18v18"></path></svg>
                </button>
                <button id="ai-chat-modal-close" class="text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div id="ai-chat-ad-container" class="bg-pink-50 border-b border-pink-200 p-3 flex items-center gap-3 cake-ad-anim shadow-sm">
                 <div class="flex-shrink-0 bg-white p-1 rounded-full shadow border border-pink-100"><img src="./imagenes/thaliacakes.png" class="w-12 h-12 rounded-full object-cover shadow-sm border border-pink-200" alt="Thalia Cakes" onerror="this.src='https://placehold.co/100x100/pink/white?text=TC'"></div>
                 <div class="flex-grow text-left"><h3 class="font-bold text-pink-600 text-sm leading-tight">Thalia Cakes üéÇ</h3><p class="text-xs text-slate-600">¬°Dulzura!</p></div>
                 <a href="https://www.facebook.com/share/1GY4SEQJTx/" target="_blank" rel="noopener noreferrer" class="bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white text-xs font-bold py-1.5 px-3 rounded-full transition shadow-sm transform hover:scale-105">Ver m√°s</a>
            </div>
            <div id="ai-chat-messages" class="flex-grow flex flex-col p-4 space-y-2 overflow-y-auto bg-white">
                <div class="ai-chat-bubble ai">Hola, soy DUV. ¬øQu√© buscas hoy?</div>
            </div>
            <div class="p-4 border-t border-slate-200 bg-slate-50 relative">
                <div id="ai-chat-error" class="hidden text-sm text-red-600 bg-red-100 p-3 rounded-lg mb-3"></div>
                <form id="ai-chat-form" class="flex items-center gap-3" onsubmit="event.preventDefault();">
                    <div class="relative flex-grow">
                        <input type="text" id="ai-chat-input" placeholder="Escribe..." class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" autocomplete="off">
                        <!-- SUGGESTIONS BOX (AUTOCOMPLETE) -->
                        <div id="search-suggestions" class="hidden"></div>
                    </div>
                    <button type="button" id="ai-chat-mic" class="p-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors flex items-center justify-center min-w-[44px] min-h-[44px]">
                         <svg id="mic-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                         <svg id="mic-listening" class="h-6 w-6 text-red-500 hidden animate-pulse" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"></circle></svg>
                    </button>
                    <button type="submit" id="ai-chat-submit" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center min-w-[44px] min-h-[44px]">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <footer class="bg-white border-t border-slate-200 w-full mt-4">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 text-center">
            <h2 class="text-2xl font-bold text-slate-900" id="footer-title">Un Proyecto Hecho para Ti</h2>
            <div class="mt-8 flex flex-wrap justify-center items-center gap-4">
                <button id="yape-modal-open" class="bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-purple-700 flex items-center gap-2">Yape</button>
                <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=lahsvergon_23%40hotmail.com&item_name=Apoyo" target="_blank" rel="noopener noreferrer" class="bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-blue-700 flex items-center gap-2">PayPal</a>
                <a href="https://t.me/descargas_ultima_version_vip" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 bg-sky-500 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-sky-600 transition-colors">Telegram</a>
            </div>
            <div class="mt-6">
                <a href="https://wa.me/51924814457" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-full">WhatsApp</a>
            </div>
            <div class="mt-10 pt-8 border-t border-slate-300 max-w-2xl mx-auto text-left">
               <h3 class="text-xl font-bold text-slate-900 text-center mb-2" id="board-title">Pizarra de Pedidos</h3>
                
                <!-- üî• BOT√ìN TRAMPA PARA TELEGRAM üî• -->
                <div class="text-center mb-6">
                    <p class="text-sm text-slate-500 mb-3">¬øNo encuentras tu programa? ¬°P√≠delo directamente!</p>
                    <a href="https://t.me/PedidosDUV" target="_blank" class="inline-flex items-center gap-2 bg-[#229ED9] hover:bg-[#1c84b6] text-white font-bold py-3 px-8 rounded-xl shadow-lg transition-transform transform hover:scale-105 animate-bounce">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                        UNIRME AL GRUPO DE PEDIDOS
                    </a>
                </div>

                <div id="general-requests-list" class="mb-4 max-h-96 overflow-y-auto p-2 bg-white rounded-lg shadow-inner border border-slate-200">
                    <p class="text-slate-500 text-sm p-4 text-center">Cargando pedidos...</p>
                </div>
            </div>
            <div class="mt-10 pt-8 border-t border-slate-300 max-w-2xl mx-auto text-center flex flex-col items-center gap-2">
                <button id="admin-login-btn" class="text-sm text-slate-500 hover:text-blue-600">Login (Admin)</button>
                <p id="admin-status" class="text-sm text-green-600 mt-2 hidden"></p>
                <button id="ver-actividad-btn" style="display: none;" class="text-sm bg-slate-800 text-white px-3 py-1 rounded-full hover:bg-slate-700 transition-colors flex items-center gap-2 mx-auto">
                    <span>üëÅÔ∏è</span> Abrir Panel & Herramientas
                </button>
            </div>
        </div>
    </footer>
    
    <div class="flex flex-col items-center justify-center my-8 px-4">
        <div class="rounded-xl overflow-hidden shadow-md border-2 border-green-500/30 bg-white p-1 hover:scale-105 transition-transform duration-300"> 
             <a href="https://exe.io/ref/lahsvergon" target="_blank" rel="noopener noreferrer"><img src="https://exe.io/img/ref/r1.gif" title="¬°Gana dinero acortando enlaces!" alt="Exe.io Banner" class="max-w-full h-auto rounded-lg" loading="lazy" /></a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, limit, addDoc, serverTimestamp, runTransaction, increment, updateDoc, getDocs, where, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN DE VIDEOS GU√çA ---
        const PC_GUIDE_URL = "https://www.youtube.com/embed/Zs-1k7F0_vE"; 
        const MOBILE_GUIDE_URL = "https://drive.google.com/file/d/1lLN0IgFZlGfYoYybOfiPhr-VybZZgzoU/preview";
        
        let gateTimer = null; // Timer global para el gate

        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : null;

        const userConfig = {
          apiKey: "AIzaSyDeNCckeg9KYlsk__1UQF1yA64WK_nb3Vw", 
          authDomain: "web-descargarultimaversion.firebaseapp.com",
          projectId: "web-descargarultimaversion",
          storageBucket: "web-descargarultimaversion.firebasestorage.app",
          messagingSenderId: "1028999431387",
          appId: "1:1028999431387:web:3f6799e9adfca72d3078fe",
          measurementId: "G-BZRK62Y3S5"
        };
        
        const oldFirebaseConfig = {
          apiKey: "AIzaSyCPB82qY7h3YGvk_cClAw5so0DFgiePzNM",
          authDomain: "descargar-ultima-version.firebaseapp.com",
          projectId: "descargar-ultima-version",
          storageBucket: "descargar-ultima-version.firebasestorage.app",
          messagingSenderId: "1028999431387",
          appId: "1:1028999431387:web:3f6799e9adfca72d3078fe",
          measurementId: "G-BZRK62Y3S5"
        };

        const firebaseConfig = envConfig || userConfig;
        const appId = envAppId || "descargar-ultima-version"; 
        const ADMIN_ID = "vDq0ZPy7f0UYpTzP44H0nvRDPYD2";

        // üí∞üí∞üí∞ TU C√ìDIGO DIRECT LINK DE ADSTERRA VA AQU√ç üí∞üí∞üí∞
        const ADSTERRA_DIRECT_LINK = "https://honeywhyvowel.com/dqk32uhrai?key=e144383761d76e0d58c40c45c1d00ad6"; 

        let app, db, auth;
        let allSoftware = [];
        let activeTab = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'mobile' : 'pc';
        let currentCategory = 'home';
        let currentSearchTerm = '';
        let userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');
        let userVotes = JSON.parse(localStorage.getItem('userVotes') || '{}');
        let radarInterval = null;
        let configUnsubscribe = null;
        let softwareUnsubscribe = null;
        let requestsUnsubscribe = null;
        let unsubscribeActivity = null; 
        let currentItemId = null;
        let currentDownloadLink = null;
        let currentStoryDownloadLink = null;
        let currentStoryItemId = null;
        window.commentsUnsubscribe = null;
        window.generalRequestsUnsubscribe = null;
        let isFirstLoad = true;
        let storyInterval = null;
        let currentStoryIndex = 0;
        let currentStoryList = [];
        let isEnglish = false; 
        
        const tabPc = document.getElementById('tab-pc');
        const tabMobile = document.getElementById('tab-mobile');
        const contentPc = document.getElementById('content-pc');
        const contentMobile = document.getElementById('content-mobile');
        const navContainer = document.getElementById('nav-container');
        
        let isSpeechEnabled = true;

        const tabUpdates = document.getElementById('tab-updates');
        // const tabGuide = document.getElementById('tab-guide'); // Removed
        const viewUpdates = document.getElementById('view-updates');
        // const viewGuide = document.getElementById('view-guide'); // Removed
        const guideVideoWrapper = document.getElementById('guide-video-wrapper');

        // --- CEREBRO INTELIGENTE DE IDIOMA (GRINGO MODE) ---
        function detectAndApplyLanguage() {
            const lang = navigator.language || navigator.userLanguage;
            if (lang.startsWith('en')) {
                isEnglish = true;
                console.log("üá∫üá∏ Gringo Mode Activated!");
                
                document.documentElement.lang = "en";
                document.getElementById('site-title').textContent = "Download Latest Version";
                document.getElementById('search-placeholder').textContent = "What software are you looking for...?";
                document.getElementById('tab-updates-text').textContent = "Latest Updates";
                // document.getElementById('tab-guide-text').textContent = "How to Download"; // Removed
                document.getElementById('hero-title').textContent = "Your Safe Download Zone";
                document.getElementById('hero-desc').innerHTML = `The internet is a jungle full of viruses and broken links. <span class="text-cyan-300 font-bold bg-blue-900/40 px-2 rounded border border-blue-500/30">We are your filter.</span> Our team manually tracks and verifies the best files to bring them to you clean and safe.`;
                
                // ‚ö†Ô∏è MENSAJE HONESTO TRADUCIDO (PSICOLOG√çA INVERSA)
                document.getElementById('hero-note-1').textContent = "To keep this project alive and virus-free, we use modest advertising.";
                document.getElementById('hero-note-strong').textContent = "When you click Download, an ad window will open.";
                document.getElementById('hero-note-2').textContent = "Just close it and come back. It's the only price for all our hard work.";
                document.getElementById('hero-footer').textContent = "Thank you for your understanding and support!";

                document.getElementById('stories-title').innerHTML = `<span class="text-blue-500 text-lg">‚ú®</span> Recently Added`;
                document.getElementById('top-title').textContent = "Most Popular";
                document.getElementById('footer-title').textContent = "A Project Made for You";
                document.getElementById('board-title').textContent = "Request Board";
                document.getElementById('gate-title').textContent = "Secure Download"; 
                document.getElementById('gate-desc').textContent = "Waiting for secure connection..."; 
                document.getElementById('gate-btn-text').textContent = "Please wait...";
                document.getElementById('guide-modal-title').textContent = "QUICK GUIDE";
                document.getElementById('guide-modal-desc').textContent = "Follow the steps in the video to skip ads.";
                document.getElementById('download-guide-continue-btn').textContent = "Got it!";
                document.getElementById('story-download-text').textContent = "VIEW DETAILS"; 
                document.getElementById('comments-modal-title').textContent = "Comments";
                document.getElementById('comment-input').placeholder = "Write your comment...";
                document.getElementById('submit-comment-btn').textContent = "Send";
                document.getElementById('report-text').textContent = "Report Broken Link";
            }
        }

        function switchMainTab(targetId) {
            document.querySelectorAll('.fb-main-tab').forEach(b => b.classList.remove('active'));
            viewUpdates.classList.add('hidden');
            // viewGuide.classList.add('hidden'); // Removed
            
            if (targetId === 'view-updates') {
                tabUpdates.classList.add('active');
                viewUpdates.classList.remove('hidden');
            } 
            /* Removed Guide logic
            else if (targetId === 'view-guide') {
                tabGuide.classList.add('active');
                viewGuide.classList.remove('hidden');
                loadGuideVideo(); 
            } */
        }

        tabUpdates.addEventListener('click', () => switchMainTab('view-updates'));
        // tabGuide.addEventListener('click', () => switchMainTab('view-guide')); // Removed

        function loadGuideVideo() {
            // ... (Function kept in case needed for modals, but tab usage removed)
            guideVideoWrapper.innerHTML = '';
            // ... (logic)
        }

        const aiTriggerBtn = document.getElementById('ai-trigger-btn');
        if(aiTriggerBtn) {
            aiTriggerBtn.addEventListener('click', () => {
                openModal('ai-chat-modal');
                const aiInput = document.getElementById('ai-chat-input');
                if(aiInput) setTimeout(() => aiInput.focus(), 300);
            });
        }

        if (activeTab === 'mobile') {
            setTabActive(tabMobile, tabPc);
            contentPc.classList.add('hidden');
            contentMobile.classList.remove('hidden');
        } else {
            setTabActive(tabPc, tabMobile);
            contentMobile.classList.add('hidden');
            contentPc.classList.remove('hidden');
        }
        
        function setTabActive(activeBtn, inactiveBtn) {
            if (activeBtn) {
                activeBtn.classList.add('text-blue-700', 'bg-blue-50', 'shadow-sm');
                activeBtn.classList.remove('text-slate-500', 'bg-transparent');
            }
            if (inactiveBtn) {
                inactiveBtn.classList.remove('text-blue-700', 'bg-blue-50', 'shadow-sm');
                inactiveBtn.classList.add('text-slate-500', 'bg-transparent');
            }
        }

        if(tabPc) tabPc.addEventListener('click', () => {
            activeTab = 'pc';
            currentCategory = 'home';
            setTabActive(tabPc, tabMobile);
            contentMobile.classList.add('hidden');
            contentPc.classList.remove('hidden');
            guideVideoWrapper.innerHTML = ''; 
            updateView();
        });
        if(tabMobile) tabMobile.addEventListener('click', () => {
            activeTab = 'mobile';
            setTabActive(tabMobile, tabPc);
            contentPc.classList.add('hidden');
            contentMobile.classList.remove('hidden');
            guideVideoWrapper.innerHTML = '';
            updateView();
        });

        const modalMap = { 'yape-modal-open': 'yape-modal', 'open-ai-chat-btn': 'ai-chat-modal' };
        Object.keys(modalMap).forEach(id => {
              const btn = document.getElementById(id);
              if(btn) btn.addEventListener('click', () => { openModal(modalMap[id]); });
          });

        // üî• FUNCION GATE CON INTELIGENCIA DE YOUTUBE üî•
        // üî• FUNCION GATE CON INTELIGENCIA DE YOUTUBE Y PESO üî•
        function openGateModal(downloadLink, customVideoUrl, fileSize) {
            currentDownloadLink = downloadLink; 
            const modal = document.getElementById('download-gate-modal');
            const iframe = document.getElementById('gate-video-iframe');
            const videoContainerWrapper = document.getElementById('video-container-wrapper');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // 1. VIDEO POR DEFECTO (SONIDO ACTIVADO)
            // Cambiamos mute=1 a mute=0 y controls=0 a controls=1
            let videoSrc = "https://www.youtube.com/embed/5qap5aO4i9A?autoplay=1&controls=1&mute=0"; 
            
            // 2. DETECTOR DE LINK PERSONALIZADO (SONIDO ACTIVADO)
            if (customVideoUrl && customVideoUrl.trim() !== "") {
                try {
                    let videoId = "";
                    // üî• Aqu√≠ activamos el sonido para los videos que subes desde el Admin
                    let params = "?autoplay=1&controls=1&mute=0"; 

                    // Extraer ID del video
                    if (customVideoUrl.includes("v=")) {
                        videoId = customVideoUrl.split("v=")[1].split("&")[0];
                    } else if (customVideoUrl.includes("youtu.be/")) {
                        videoId = customVideoUrl.split("youtu.be/")[1].split("?")[0];
                    } else if (customVideoUrl.includes("embed/")) {
                        videoId = customVideoUrl.split("embed/")[1].split("?")[0];
                    }

                    // Extraer Minuto/Segundo (?t=17 o ?start=17)
                    if (customVideoUrl.includes("t=") || customVideoUrl.includes("start=")) {
                        const timeMatch = customVideoUrl.match(/[?&](t|start)=([^&]+)/);
                        if (timeMatch) {
                            let timeVal = timeMatch[2].replace('s',''); // Quitar la 's' si existe
                            params += `&start=${parseInt(timeVal)}`;
                        }
                    }

                    if (videoId) {
                        videoSrc = `https://www.youtube.com/embed/${videoId}${params}`;
                    }
                } catch (e) { console.error("Error procesando video:", e); }
            }
            
            // Ajuste visual para m√≥viles
            if (videoContainerWrapper) {
                if (isMobile) {
                    videoContainerWrapper.classList.remove('modal-video-container-vertical'); 
                    videoContainerWrapper.classList.add('modal-video-container'); 
                } else {
                    videoContainerWrapper.classList.remove('modal-video-container-vertical');
                    videoContainerWrapper.classList.add('modal-video-container');
                }
            }
            
            if(iframe) iframe.src = videoSrc;
            if(modal) modal.classList.add('open');

            // --- CUENTA REGRESIVA ---
            const btn = document.getElementById('proceed-download-btn');
            const btnText = document.getElementById('gate-btn-text');
            const statusText = document.getElementById('gate-status');
            const progress = document.getElementById('gate-progress');
            
            if(gateTimer) clearInterval(gateTimer);
            btn.disabled = true;
            btn.classList.add('gate-disabled');
            btn.classList.remove('gate-ready', 'bg-green-600', 'hover:bg-green-700');
            btn.classList.add('bg-slate-400');
            progress.style.width = "0%";
            
            let timeLeft = 15;
            
            gateTimer = setInterval(() => {
                timeLeft--;
                const percentage = ((15 - timeLeft) / 15) * 100;
                progress.style.width = `${percentage}%`;
                
                if (isEnglish) {
                     btnText.textContent = `Please wait ${timeLeft} seconds...`; 
                     statusText.textContent = `Generating secure link...`;
                } else {
                     btnText.textContent = `Espera ${timeLeft} segundos...`; 
                     statusText.textContent = `Generando enlace seguro...`;
                }

                if (timeLeft <= 0) {
                    clearInterval(gateTimer);
                    btn.disabled = false;
                    btn.classList.remove('gate-disabled', 'bg-slate-400');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700', 'gate-ready');
                    
                    // Mostrar peso del archivo si existe (TU C√ìDIGO DEL PESO)
                    const sizeText = fileSize ? ` (${fileSize})` : '';
                    const downloadIcon = `<svg class="w-6 h-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>`;

                    if (isEnglish) {
                        btnText.innerHTML = `${downloadIcon} DOWNLOAD ‚¨áÔ∏è${sizeText}`;
                        statusText.textContent = "Download authorized.";
                    } else {
                        btnText.innerHTML = `${downloadIcon} DESCARGAR ‚¨áÔ∏è${sizeText}`;
                        statusText.textContent = "Descarga autorizada.";
                    }
                }
            }, 1000);
        }

        ['how-to-download-modal', 'yape-modal', 'comments-modal', 'download-guide-modal', 'ai-chat-modal', 'download-gate-modal', 'admin-dashboard-modal', 'story-viewer-modal'].forEach(id => {
            const m = document.getElementById(id); 
            const c = document.getElementById(id+'-close');
            if(c) c.addEventListener('click', () => closeModal(id));
            if(m) m.addEventListener('click', (e) => { if(e.target === m) closeModal(id); });
        });
        
        function closeModal(id) {
            const el = document.getElementById(id);
            if(el) el.classList.remove('open');
            if(id === 'download-gate-modal') {
                const iframe = document.getElementById('gate-video-iframe');
                if(iframe) iframe.src = ""; 
                if(gateTimer) clearInterval(gateTimer); // Stop timer on close
            }
            if(id === 'comments-modal' && window.commentsUnsubscribe) { window.commentsUnsubscribe(); window.commentsUnsubscribe = null; }
            if(id === 'ai-chat-modal') window.speechSynthesis.cancel();
            if(id === 'admin-dashboard-modal' && unsubscribeActivity) { unsubscribeActivity(); unsubscribeActivity = null; }
            if(id === 'story-viewer-modal') {
                if(storyInterval) { clearInterval(storyInterval); storyInterval = null; }
            }
        }
        
        // ... (Keep existing modal button logic) ...
        const proceedBtn = document.getElementById('proceed-download-btn');
        if(proceedBtn) proceedBtn.addEventListener('click', () => {
            // Only proceed if enabled
            if(!proceedBtn.disabled) {
                closeModal('download-gate-modal');
                if(currentDownloadLink) { window.open(currentDownloadLink, '_blank'); currentDownloadLink = null; }
            }
        });

        // üî• LOGICA DEL DOBLE CLIC (TRAMPA ADSTERRA) üî•
        // üî• LOGICA DEL DOBLE CLIC (TRAMPA ADSTERRA + VIDEO GATE) üî•
        // üî• LOGICA DEL DOBLE CLIC (TRAMPA ADSTERRA + VIDEO GATE + PESO) üî•
        async function handleDownloadAction(e) {
            e.preventDefault();
            const btn = e.currentTarget;
            const id = btn.dataset.id;
            const title = btn.dataset.title;
            const link = btn.dataset.link;
            const gateVideo = btn.dataset.video; // üî• CAPTURAMOS EL LINK DEL VIDEO
            const fileSize = btn.dataset.size;   // üî• CAPTURAMOS EL PESO
            
            if (!link || link === '#' || link === 'undefined') { alert("Enlace no disponible."); return; }
            
            // TRAMPA ADSTERRA (Primer Clic)
            if (!btn.dataset.adClicked) {
                if (typeof ADSTERRA_DIRECT_LINK !== 'undefined' && ADSTERRA_DIRECT_LINK.includes("http")) {
                    window.open(ADSTERRA_DIRECT_LINK, '_blank'); 
                    btn.dataset.adClicked = "true"; 
                    
                    const originalText = btn.innerText;
                    btn.innerText = isEnglish ? "Click again to download" : "Clic de nuevo para descargar";
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    btn.classList.add('bg-green-600', 'hover:bg-green-700', 'animate-pulse');
                    
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'animate-pulse');
                    }, 4000);
                    return; 
                }
            }

            // SEGUNDO CLIC: Pasamos el link, el video y el peso
            openGateModal(link, gateVideo, fileSize);
            
            // Registrar descarga en base de datos
            const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, id);
            updateDoc(itemRef, { downloads: increment(1) }).catch(console.error);
            logActivity('Descarga', title || 'Desconocido');
        }

        async function handleLikeAction(e) {
            e.preventDefault();
            const btn = e.currentTarget;
            const id = btn.dataset.id;
            const title = btn.dataset.title;
            if (!auth.currentUser) await signInAnonymously(auth);
            const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, id);
            const isLiked = !!userLikes[id];
            const span = btn.querySelector('.likes-count-display');
            let current = parseInt(span.textContent) || 0;
            if (isLiked) {
                userLikes[id] = false; 
                btn.classList.remove('text-red-500');
                btn.classList.add('text-slate-400');
                span.textContent = Math.max(0, current - 1);
                await updateDoc(itemRef, { likes: increment(-1) });
            } else {
                userLikes[id] = true; 
                btn.classList.remove('text-slate-400');
                btn.classList.add('text-red-500');
                span.textContent = current + 1;
                await updateDoc(itemRef, { likes: increment(1) });
                logActivity('Like', title || 'Desconocido');
            }
            localStorage.setItem('userLikes', JSON.stringify(userLikes));
        }

        const storyViewerDownloadBtn = document.getElementById('story-viewer-download-btn');
        if(storyViewerDownloadBtn) {
            storyViewerDownloadBtn.addEventListener('click', () => {
                closeModal('story-viewer-modal');
                if(currentStoryItemId) {
                    handleTopDownloadClick(null, currentStoryItemId);
                } else {
                    if(currentStoryDownloadLink) window.open(currentStoryDownloadLink, '_blank');
                }
            });
        }
        
        const guideBtn = document.getElementById('download-guide-continue-btn');
        if(guideBtn) guideBtn.addEventListener('click', () => {
            closeModal('download-guide-modal');
            if(currentDownloadLink) { window.open(currentDownloadLink, '_blank'); currentDownloadLink = null; }
        });

        const openYapeBtn = document.getElementById('open-yape-btn');
        if(openYapeBtn) openYapeBtn.addEventListener('click', () => { window.location.href = "yape://"; });

        const adminBtn = document.getElementById('admin-login-btn');
        if(adminBtn) adminBtn.addEventListener('click', async () => {
            if (auth.currentUser) {
                await signOut(auth);
                adminBtn.textContent = "Login (Admin)";
                const status = document.getElementById('admin-status');
                const verBtn = document.getElementById('ver-actividad-btn');
                if(status) status.classList.add('hidden');
                if(verBtn) verBtn.style.display = 'none';
            } else {
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { console.error(e); }
            }
        });
        
        const activityBtn = document.getElementById('ver-actividad-btn');
        if(activityBtn) activityBtn.addEventListener('click', () => {
            openModal('admin-dashboard-modal');
            loadActivityLogs();
        });

        if(navContainer) navContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.smart-tag-btn');
            if(btn) { 
                e.preventDefault(); 
                currentCategory = btn.dataset.tag; // Use new dataset.tag 
                
                // AUTO SWITCH TABS LOGIC
                if (['android', 'mobile-games', 'mobile-apps'].includes(currentCategory)) {
                    activeTab = 'mobile';
                    setTabActive(tabMobile, tabPc);
                    contentPc.classList.add('hidden');
                    contentMobile.classList.remove('hidden');
                } else if (['pc-software', 'pc-games', 'office', 'adobe'].includes(currentCategory)) {
                    activeTab = 'pc';
                    setTabActive(tabPc, tabMobile);
                    contentMobile.classList.add('hidden');
                    contentPc.classList.remove('hidden');
                }
                
                updateView(); 
                
                // Visual update
                document.querySelectorAll('.smart-tag-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
        });

        const chatMessages = document.getElementById('ai-chat-messages');
        if(chatMessages) chatMessages.addEventListener('click', (e) => {
            if(e.target.classList.contains('chat-link')) {
                e.preventDefault(); closeModal('ai-chat-modal'); handleTopDownloadClick(null, e.target.dataset.cardId);
            }
        });

        function openModal(id) {
            const el = document.getElementById(id);
            if(el) el.classList.add('open');
            if(id === 'ai-chat-modal') {
                const input = document.getElementById('ai-chat-input');
                if(input) setTimeout(() => input.focus(), 100);
            }
        }

        // ... (Keep existing SEO/Log/Utils) ...
        function updateMetaTags(item) {
            if (!item) return;
            const ogImage = document.querySelector('meta[property="og:image"]');
            if (ogImage && item.imageUrl) ogImage.setAttribute('content', item.imageUrl);
            const twitterImage = document.querySelector('meta[name="twitter:image"]');
            if (twitterImage && item.imageUrl) twitterImage.setAttribute('content', item.imageUrl);
            const ogTitle = document.querySelector('meta[property="og:title"]');
            if (ogTitle) ogTitle.setAttribute('content', `Descargar ${item.title} - Full`);
            
            document.title = `Descargar ${item.title} - Ultima Version`;
        }
        
        async function logActivity(type, itemName, detail = "") {
            try {
                const user = auth.currentUser;
                const uid = user ? user.uid : "Anonimo";
                let flag = "";
                const finalUid = (uid === ADMIN_ID) ? "üëë ADMIN (Yo)" : uid;
                await addDoc(collection(db, `artifacts/${appId}/public/data/activity-logs`), {
                    type: type, item: itemName, detail: detail, uid: finalUid, timestamp: serverTimestamp(), flag: flag 
                });
            } catch(e) { console.error("Log error", e); }
        }

        function isValidImageUrl(url) {
            if (!url) return false;
            const invalidExtensions = ['.apk', '.exe', '.zip', '.rar', '.7z', '.msi', '.iso', '.bin', '.bat', '.cmd'];
            const lowerUrl = url.toLowerCase();
            return !invalidExtensions.some(ext => lowerUrl.includes(ext));
        }

        function renderCards(items, container, noResults) {
            container.innerHTML = '';
            if (items.length === 0) { noResults.classList.remove('hidden'); container.classList.add('hidden'); return; }
            noResults.classList.add('hidden'); container.classList.remove('hidden');
            const sorted = items.sort((a, b) => {
                const da = a.createdAt ? a.createdAt.toDate() : new Date(0);
                const db = b.createdAt ? b.createdAt.toDate() : new Date(0);
                return db - da;
            });
            sorted.forEach(item => {
                let placeholder = activeTab === 'mobile' ? '16a34a/ffffff' : 'e2e8f0/94a3b8';
                if(item.category && item.category.includes('adobe')) placeholder = '1e40af/ffffff';
                const card = document.createElement('article'); // SEMANTIC HTML: article instead of div
                card.className = 'bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200 hover:shadow-lg transition-all duration-300 relative';
                card.id = `card-${item.id}`;
                let dateStr = "Reciente";
                if(item.createdAt && item.createdAt.toDate) dateStr = item.createdAt.toDate().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                
                const formatTextContent = (text) => {
                    if (!text) return "";
                    if (text.includes('<') && text.includes('>')) return text; 
                    return text.replace(/\n/g, '<br>'); 
                };

                const installTextFormatted = formatTextContent(item.installation || "Descomprimir y ejecutar el setup. Si pide contrase√±a: <code>taiwebs.com</code>");
                const updateTextFormatted = formatTextContent(item.updates || "Versi√≥n optimizada y verificada.");
                const heartClass = userLikes[item.id] ? 'text-red-500' : 'text-slate-400';
                const safeImgUrl = isValidImageUrl(item.imageUrl) ? item.imageUrl : `https://placehold.co/600x400/${placeholder}?text=No+Image`;
                const displayTitle = `${item.title} ${item.version ? `<span class="text-sm font-normal text-slate-500 ml-1">${item.version}</span>` : ''}`;

                card.innerHTML = `
                    <img src="${safeImgUrl}" alt="Descargar ${item.title} Full" loading="lazy" style="width: 100%; height: 192px; object-fit: cover;" onerror="this.src='https://placehold.co/600x400/${placeholder}?text=Error'">
                    <div class="p-5">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-slate-500">${dateStr}</span>
                            <span class="inline-flex items-center gap-1 text-xs text-blue-600 font-medium bg-blue-50 px-2 py-0.5 rounded-full download-counter">
                                <svg style="width:12px;height:12px;" fill="currentColor" viewBox="0 0 20 20"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.23a.75.75 0 00-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.905 3.084V2.75z"></path></svg>
                                ${item.downloads || 0}
                            </span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2 leading-tight line-clamp-2" title="${item.title}">${displayTitle}</h3>
                        <p class="text-slate-600 text-sm mb-4 h-16 overflow-hidden leading-relaxed line-clamp-3">${item.description || ''}</p>
                        <details class="group mb-4 text-sm">
                            <summary class="list-none cursor-pointer text-blue-600 font-semibold hover:text-blue-800 transition-colors flex items-center gap-1"><span>‚ÑπÔ∏è Ver detalles e instalaci√≥n</span></summary>
                            <div class="mt-3 p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <div class="mb-3">
                                    <h4 class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-1">üì• Instalaci√≥n</h4>
                                    <div class="text-slate-600 text-xs leading-relaxed">${installTextFormatted}</div>
                                </div>
                                <div class="border-t border-dashed border-slate-300 my-3"></div>
                                <div>
                                    <h4 class="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">‚ú® Novedades</h4>
                                    <div class="text-slate-600 text-xs leading-relaxed">${updateTextFormatted}</div>
                                </div>
                            </div>
                        </details>
                        <div class="flex flex-col gap-3">
                            <!-- üî• BOT√ìN ACTUALIZADO CON DATA-SIZE üî• -->
                            <button class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors download-btn-action" 
                                data-id="${item.id}" 
                                data-title="${item.title}" 
                                data-link="${item.downloadLink}" 
                                data-video="${item.gateVideo || ''}"
                                data-size="${item.fileSize || ''}"> 
                                DESCARGAR
                            </button>
                            <a href="https://t.me/descargas_ultima_version_vip" target="_blank" class="mx-auto bg-sky-500 text-white font-bold py-1.5 px-5 rounded-full hover:bg-sky-600 transition-all animate-pulse flex items-center justify-center gap-2 text-xs shadow-lg transform hover:scale-105 border border-sky-400 w-fit mt-2 mb-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                                Suscribirse
                            </a>
                            <div class="flex justify-center items-center gap-8 pt-3 border-t border-slate-100 mt-1">
                                <button class="group flex flex-col items-center gap-1 hover:text-red-500 transition-colors like-btn-action ${heartClass}" data-id="${item.id}" data-title="${item.title}">
                                    <svg class="w-7 h-7 transition-transform group-hover:scale-110" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                                    <span class="text-[10px] font-bold likes-count-display">${item.likes || 0}</span>
                                </button>
                                <button class="group flex flex-col items-center gap-1 text-slate-400 hover:text-blue-500 transition-colors comment-btn-action" data-id="${item.id}" data-title="${item.title}">
                                    <svg class="w-7 h-7 transition-transform group-hover:scale-110" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg>
                                    <span class="text-[10px] font-bold comments-count-display">${item.commentsCount || 0}</span>
                                </button>
                                <button class="group flex flex-col items-center gap-1 text-slate-400 hover:text-green-500 transition-colors share-btn-action" data-id="${item.id}">
                                    <svg class="w-7 h-7 transition-transform group-hover:scale-110" fill="currentColor" viewBox="0 0 20 20"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
            
            container.querySelectorAll('.download-btn-action').forEach(b => { if (b) b.addEventListener('click', handleDownloadAction); });
            container.querySelectorAll('.like-btn-action').forEach(b => { if (b) b.addEventListener('click', handleLikeAction); });
            container.querySelectorAll('.comment-btn-action').forEach(b => { if (b) b.addEventListener('click', handleCommentAction); });
            container.querySelectorAll('.share-btn-action').forEach(b => { if (b) b.addEventListener('click', handleShareAction); });
        }

        async function handleUpdateReport(e) {
            e.preventDefault();
            const title = e.target.dataset.title;
            const id = e.target.dataset.id;
            
            if(confirm(`¬øLa aplicaci√≥n ${title} te est√° pidiendo actualizar? Si es as√≠, av√≠sanos para subir la nueva versi√≥n.`)) {
                await addSoftwareRequest(`[URGENTE-UPDATE] ${title}`);
                alert("¬°Gracias por el aviso! ü¶Ö Revisaremos y subiremos la nueva versi√≥n lo antes posible.");
            }
        }

        // üî• SMART TAGGING LOGIC üî•
        function assignSmartTags(item) {
            const tags = ['home']; // Everyone gets home
            const title = (item.title || '').toLowerCase();
            const cat = (item.category || '').toLowerCase();
            const plat = (item.platform || '').toLowerCase();

            // 1. Platform Base
            if (plat === 'pc' || plat === 'windows') tags.push('pc-software');
            
            // üî• LOGICA M√ìVIL REFINADA üî•
            if (plat === 'android' || plat === 'apk' || plat === 'mobile') {
                tags.push('android'); // Base tag
                
                // Detectar Juegos vs Apps
                if (title.includes('game') || title.includes('juego') || cat.includes('game') || cat.includes('juego')) {
                    tags.push('mobile-games');
                } else {
                    tags.push('mobile-apps'); // Si es android y no es juego, es app
                }
            }

            // 2. PC Games Detection
            if ((title.includes('game') || title.includes('juego') || title.includes('repack') || cat.includes('game') || cat.includes('juego')) && (plat === 'pc' || plat === 'windows')) {
                tags.push('pc-games');
            }

            // 3. Adobe / Design
            if (title.includes('adobe') || title.includes('photoshop') || title.includes('premiere') || title.includes('illustrator') || title.includes('after effects') || cat.includes('design') || cat.includes('dise√±o')) {
                tags.push('adobe');
            }

            // 4. Office / Productivity
            if (title.includes('office') || title.includes('word') || title.includes('excel') || title.includes('powerpoint') || cat.includes('office') || cat.includes('oficina')) {
                tags.push('office');
            }

            return tags;
        }

        function updateView() {
            if (!allSoftware.length) return;
            
            // Apply Smart Tags First
            let filtered = allSoftware.filter(item => {
                const itemTags = assignSmartTags(item);
                if (currentCategory === 'home') return true; // Show all on home
                return itemTags.includes(currentCategory);
            });

            // If we are just on 'home' tag, apply the tab filter (PC/Mobile) visually if needed, 
            // BUT since user wants new filters to drive the view, let's respect the tab filter ONLY if category is generic.
            if (currentCategory === 'home' || currentCategory === 'pc-software' || currentCategory === 'android') {
                 filtered = filtered.filter(i => {
                    const p = (i.platform || '').toLowerCase();
                    if (activeTab === 'mobile') {
                        return p === 'mobile' || p === 'android' || p === 'apk';
                    } else {
                        return p === 'pc' || p === 'windows' || p === 'desktop';
                    }
                });
            }

            if (currentSearchTerm) filtered = filtered.filter(i => i.title.toLowerCase().includes(currentSearchTerm.toLowerCase()));
            
            const container = activeTab === 'pc' ? document.getElementById('content-grid-pc') : document.getElementById('content-grid-mobile');
            const noRes = activeTab === 'pc' ? document.getElementById('no-results-pc') : document.getElementById('no-results-mobile');
            renderCards(filtered, container, noRes);
        }

        function handleCommentAction(e) {
            e.preventDefault();
            const id = e.currentTarget.dataset.id;
            currentItemId = id; 
            const item = allSoftware.find(i => i.id === id);
            document.getElementById('comments-modal-title').textContent = `Comentarios: ${item ? item.title : ''}`;
            openModal('comments-modal');
            loadComments(id);
        }
        
        // Mock loadComments since detailed implementation wasn't fully provided in snippet but required for modal
        function loadComments(itemId) {
            const list = document.getElementById('comments-list');
            if(window.commentsUnsubscribe) window.commentsUnsubscribe();
            
            list.innerHTML = '<p class="text-slate-500 text-sm">Cargando...</p>';
            
            const q = collection(db, `artifacts/${appId}/public/data/comments`, itemId, 'messages');
            // Simplified fetch w/o complex order by to satisfy strict rules
            window.commentsUnsubscribe = onSnapshot(q, (snapshot) => {
                const comments = [];
                snapshot.forEach(doc => comments.push({id: doc.id, ...doc.data()}));
                // Sort in memory
                comments.sort((a,b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
                
                if(comments.length === 0) {
                    list.innerHTML = '<p class="text-slate-500 text-sm">No hay comentarios a√∫n. ¬°S√© el primero!</p>';
                    return;
                }
                
                let html = '';
                comments.forEach(c => {
                    const isAdmin = c.displayName === 'Admin' || c.uid === ADMIN_ID;
                    html += `
                        <div class="comment ${isAdmin ? 'admin-comment' : ''}">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-xs ${isAdmin ? 'text-blue-600' : 'text-slate-700'}">${c.displayName || 'Usuario'}</span>
                                ${isAdmin ? '<span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded font-bold">ADMIN</span>' : ''}
                            </div>
                            <p class="text-sm text-slate-800">${c.text}</p>
                        </div>
                    `;
                });
                list.innerHTML = html;
                list.scrollTop = list.scrollHeight;
            });
        }

        function handleShareAction(e) {
            e.preventDefault();
            const id = e.currentTarget.dataset.id;
            const item = allSoftware.find(i => i.id === id);
            const url = `${window.location.origin}${window.location.pathname}?item=${id}`;
            if(item) updateMetaTags(item);

            if (navigator.share) {
                navigator.share({ 
                     title: item ? item.title : 'Descargar Software', 
                     text: `Mira esta descarga: ${item ? item.title : ''}`,
                     url: url 
                 }).catch(err => console.log('Share canceled'));
            } else {
                navigator.clipboard.writeText(url).then(() => alert("Enlace copiado al portapapeles!"));
            }
        }
        
        function handleTopDownloadClick(e, cardId) { 
             if (e) e.preventDefault();
            const itemId = cardId || (e ? e.currentTarget.dataset.itemId : null);
            if (!itemId) return;
            let item = allSoftware.find(i => i.id === itemId);
            if (!item) return;
            updateMetaTags(item);
            
            let itemTab = (item.platform || '').toLowerCase(); 
            if (itemTab === 'android' || itemTab === 'apk') itemTab = 'mobile';
            if (itemTab === 'windows') itemTab = 'pc';

            if (activeTab !== itemTab) {
                const tabToClick = (itemTab === 'pc') ? document.getElementById('tab-pc') : document.getElementById('tab-mobile');
                if (tabToClick) tabToClick.click();
            }
            setTimeout(() => {
                const cardElement = document.getElementById(`card-${item.id}`);
                if (cardElement) {
                    cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    cardElement.classList.add('card-highlight');
                    setTimeout(() => { cardElement.classList.remove('card-highlight'); }, 2000);
                }
            }, 300);
        }

        // --- STORY VIEWER FUNCTIONS (AUTO-ADVANCE, ETC) ---
        function renderProgressBars() {
            const container = document.getElementById('story-progress-container');
            container.innerHTML = '';
            currentStoryList.forEach((_, idx) => {
                const seg = document.createElement('div');
                seg.className = 'story-progress-segment';
                const fill = document.createElement('div');
                fill.className = 'story-progress-fill';
                fill.style.width = idx < currentStoryIndex ? '100%' : '0%';
                if (idx === currentStoryIndex) fill.id = 'active-story-progress';
                seg.appendChild(fill);
                container.appendChild(seg);
            });
        }

        function startStoryTimer() {
            if (storyInterval) clearInterval(storyInterval);
            const fill = document.getElementById('active-story-progress');
            if (!fill) return;
            
            let width = 0;
            // UPDATE: 10 Seconds per story (100ms * 100)
            storyInterval = setInterval(() => {
                width += 1; 
                fill.style.width = `${width}%`;
                if (width >= 100) {
                    clearInterval(storyInterval);
                    nextStory();
                }
            }, 100); 
        }

        function nextStory() {
            if (currentStoryIndex < currentStoryList.length - 1) {
                currentStoryIndex++;
                openStoryViewer(currentStoryList[currentStoryIndex], true);
            } else {
                closeModal('story-viewer-modal');
            }
        }

        function prevStory() {
            if (currentStoryIndex > 0) {
                currentStoryIndex--;
                openStoryViewer(currentStoryList[currentStoryIndex], true);
            }
        }

        function openStoryViewer(item, isNav = false) {
            if (!item) return;
            
            if (!isNav) {
                const foundIdx = currentStoryList.findIndex(x => x.id === item.id);
                if (foundIdx !== -1) currentStoryIndex = foundIdx;
                else {
                    currentStoryList = [item];
                    currentStoryIndex = 0;
                }
            }

            renderProgressBars();
            
            document.getElementById('story-viewer-title').textContent = item.title || 'Sin T√≠tulo';
            const dateStr = item.createdAt ? item.createdAt.toDate().toLocaleDateString() : 'Reciente';
            document.getElementById('story-viewer-date').textContent = dateStr;
            const safeImgUrl = isValidImageUrl(item.imageUrl) ? item.imageUrl : 'https://placehold.co/400x600/e2e8f0/94a3b8?text=App';
            document.getElementById('story-viewer-img').src = safeImgUrl;
            document.getElementById('story-viewer-version').textContent = item.version ? `v${item.version}` : 'Nueva Versi√≥n';
            let updates = item.updates || "Versi√≥n optimizada y libre de errores.";
            updates = updates.replace(/\n/g, '<br>');
            document.getElementById('story-viewer-desc').innerHTML = updates;
            currentStoryDownloadLink = item.downloadLink;
            currentStoryItemId = item.id; 
            
            const btnText = isEnglish ? "VIEW DETAILS" : "VER FICHA";
            document.getElementById('story-download-text').textContent = btnText;
            
            openModal('story-viewer-modal');
            startStoryTimer();
        }
        
        document.getElementById('story-prev-area').addEventListener('click', (e) => { e.stopPropagation(); prevStory(); });
        document.getElementById('story-next-area').addEventListener('click', (e) => { e.stopPropagation(); nextStory(); });

        // üî• SEO MAGIC: SCHEMA.ORG INJECTOR üî•
        function updateGoogleSchema(softwareList) {
            if (!softwareList || softwareList.length === 0) return;
            
            const schemaData = {
              "@context": "https://schema.org",
              "@type": "ItemList",
              "itemListElement": softwareList.slice(0, 10).map((item, index) => ({
                "@type": "ListItem",
                "position": index + 1,
                "item": {
                  "@type": "SoftwareApplication",
                  "name": item.title,
                  "operatingSystem": item.platform === 'pc' ? 'Windows' : 'Android',
                  "applicationCategory": "GameApplication", 
                  "dateModified": new Date().toISOString(), // <--- REAL-TIME UPDATE SIGNAL
                  "offers": {
                    "@type": "Offer",
                    "price": "0",
                    "priceCurrency": "USD"
                  },
                  "aggregateRating": {
                    "@type": "AggregateRating",
                    "ratingValue": "4.8",
                    "ratingCount": item.downloads ? item.downloads + 50 : 100
                  }
                }
              }))
            };

            // Remove old schema if exists
            const oldScript = document.getElementById('dynamic-schema');
            if (oldScript) oldScript.remove();

            const script = document.createElement('script');
            script.id = 'dynamic-schema';
            script.type = 'application/ld+json';
            script.text = JSON.stringify(schemaData);
            document.head.appendChild(script);
            console.log("ü¶Ö SEO: Esquema actualizado para Google (Ping Enviado).");
        }

        // --- INIT APP ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };

            // Call Auth first, then set listeners
            initAuth().then(() => {
                onAuthStateChanged(auth, (user) => {
                    if (!user) return; // Guard clause
                    
                    // --- STORIES LISTENER (Strict Mode) ---
                    // Changed from query with limit to simple collection fetch to comply with platform restrictions
                    const storiesRef = collection(db, `artifacts/${appId}/public/data/software-items`);
                    onSnapshot(storiesRef, (snapshot) => {
                        const allDocs = [];
                        snapshot.forEach(doc => {
                             allDocs.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // Sort by date descending in memory
                        allDocs.sort((a,b) => {
                            const dateA = a.createdAt ? a.createdAt.toMillis() : 0;
                            const dateB = b.createdAt ? b.createdAt.toMillis() : 0;
                            return dateB - dateA;
                        });

                        currentStoryList = allDocs.slice(0, 60);

                        const container = document.getElementById('stories-container');
                        if (container) {
                            let html = '';
                            currentStoryList.forEach(item => {
                                const safeImgUrl = isValidImageUrl(item.imageUrl) ? item.imageUrl : 'https://placehold.co/150x250/e2e8f0/94a3b8?text=App';
                                html += `
                                    <div class="story-card group ring-2 ring-blue-500 ring-offset-2" data-id="${item.id}">
                                        <div class="story-inner">
                                            <img src="${safeImgUrl}" class="story-img" loading="lazy" onerror="this.src='https://placehold.co/150x250/e2e8f0/94a3b8?text=Error'">
                                            <div class="story-overlay-top">
                                                <p class="story-title text-white drop-shadow-md text-xs font-bold leading-tight line-clamp-2">${item.title}</p>
                                            </div>
                                            <div class="story-overlay-bottom">
                                                <span class="story-version-badge">${item.version || 'New'}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                            container.innerHTML = html;
                        }
                    }, (e) => console.log("Stories offline/empty"));

                    const storiesContainer = document.getElementById('stories-container');
                    if (storiesContainer) {
                        storiesContainer.addEventListener('click', (e) => {
                            const card = e.target.closest('.story-card');
                            if (!card) return;
                            if (storiesContainer.classList.contains('was-dragged')) return;
                            
                            const id = card.dataset.id;
                            const item = currentStoryList.find(i => i.id === id);
                            if (item) openStoryViewer(item);
                        });
                    }

                    // --- SOFTWARE ITEMS LISTENER ---
                    if(!softwareUnsubscribe) {
                        const q = collection(db, `artifacts/${appId}/public/data/software-items`);
                        softwareUnsubscribe = onSnapshot(q, (snapshot) => {
                            allSoftware = [];
                            // We don't map old categories anymore, we use Smart Tags later
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                allSoftware.push({ id: doc.id, ...data });
                            });
                            
                            // SEO: Update Structured Data for Google
                            updateGoogleSchema(allSoftware);
                            
                            // üî• NEW FILTER MENU GENERATION üî•
                            const navContainer = document.getElementById('nav-container');
                            if (navContainer) {
                                // Definimos las etiquetas de alto valor CPM en Espa√±ol e Ingl√©s (El cerebro decide qu√© mostrar)
                                const filters = [
                                    { id: 'home', label: 'üî• Todo / All' },
                                    { id: 'pc-software', label: 'üíª Software' },
                                    { id: 'pc-games', label: 'üéÆ PC Games' },
                                    { id: 'android', label: 'üì± Android Mods' },
                                    { id: 'adobe', label: 'üé® Adobe / Design' },
                                    { id: 'office', label: 'üíº Office Tools' }
                                ];
                                
                                let html = '<ul class="flex flex-wrap justify-center gap-2 min-w-max px-2">';
                                filters.forEach(f => {
                                    const isActive = currentCategory === f.id ? 'active' : '';
                                    html += `<li><button class="smart-tag-btn ${isActive}" data-tag="${f.id}">${f.label}</button></li>`;
                                });
                                html += '</ul>';
                                navContainer.innerHTML = html;
                            }
                            
                            loadTopDownloads();
                            updateView();
                            
                            if (isFirstLoad) {
                                // DETECT LANGUAGE ON FIRST LOAD
                                detectAndApplyLanguage();
                                
                                const urlParams = new URLSearchParams(window.location.search);
                                const sharedItem = urlParams.get('item');
                                if (sharedItem) {
                                    setTimeout(() => {
                                        const item = allSoftware.find(i => i.id === sharedItem);
                                        if(item) updateMetaTags(item);
                                        handleTopDownloadClick(null, sharedItem);
                                        isFirstLoad = false;
                                    }, 1500);
                                }
                            }
                        }, (e) => console.log("Software offline"));
                    }

                    // --- RADAR / CONFIG LISTENER (RESTAURADO) ---
                    const radarRef = doc(db, `artifacts/${appId}/public/data/config`, "siteSettings");
                    if(!configUnsubscribe) {
                          configUnsubscribe = onSnapshot(radarRef, (s) => {
                            const adContainer = document.getElementById('ai-chat-ad-container');
                            if (adContainer && s.exists()) {
                                const data = s.data();
                                if (data.aiChatAd && data.aiChatAd.trim() !== "") {
                                    adContainer.innerHTML = data.aiChatAd; adContainer.classList.remove('hidden');
                                } else {
                                    adContainer.classList.remove('hidden'); 
                                 }
                            } else {
                                if(adContainer) adContainer.classList.remove('hidden');
                            }
                        }, (e) => {});
                    }

                    // --- REQUESTS LISTENER ---
                    if(!requestsUnsubscribe) {
                        loadGeneralRequests();
                    }
                });
            });

        } catch (e) { console.error("Error Firebase:", e); }

        async function addSoftwareRequest(softwareName) {
            if (!db) return;
            const user = auth.currentUser || (await signInAnonymously(auth)).user;
            const requestsCollection = collection(db, `artifacts/${appId}/public/data/general-requests`);
            const lowerCaseName = softwareName.toLowerCase().trim();
            
            // STRICT MODE: Fetch all to check for existence instead of using where()
            const snapshot = await getDocs(requestsCollection);
            let exists = false;
            snapshot.forEach(doc => {
                if (doc.data().lowerCaseName === lowerCaseName) exists = true;
            });
            
            if (!exists) {
                try {
                    const newRequestRef = await addDoc(requestsCollection, {
                        text: softwareName, lowerCaseName: lowerCaseName, timestamp: serverTimestamp(),
                        uid: user.uid, displayName: (user.uid === ADMIN_ID) ? 'Admin' : (user.isAnonymous ? 'An√≥nimo' : (user.displayName || 'Usuario')), votes: 1 
                    });
                    userVotes[newRequestRef.id] = true;
                    localStorage.setItem('userVotes', JSON.stringify(userVotes));
                } catch (e) { console.error("Error adding request:", e); }
            }
        }

        function loadTopDownloads() {
            const topList = document.getElementById('top-downloads-list');
            if (!topList || allSoftware.length === 0) return;
            const top = [...allSoftware].sort((a,b) => (b.downloads||0) - (a.downloads||0)).slice(0, 50);
            topList.innerHTML = '';
            top.forEach((item, idx) => {
                let placeholder = activeTab === 'mobile' ? '16a34a/ffffff' : 'e2e8f0/94a3b8';
                const safeImgUrl = isValidImageUrl(item.imageUrl) ? item.imageUrl : `https://placehold.co/600x400/${placeholder}?text=No+Image`;

                const el = document.createElement('div');
                el.className = "min-w-[140px] w-[140px] sm:min-w-[180px] sm:w-[180px] bg-white p-2 sm:p-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all transform hover:-translate-y-1 snap-center flex flex-col relative";
                el.innerHTML = `
                    <div class="absolute top-2 left-2 bg-yellow-400 text-yellow-900 text-[10px] font-bold px-2 py-0.5 rounded-full z-10 shadow-sm">#${idx+1}</div>
                    <img src="${safeImgUrl}" class="w-full h-24 sm:h-32 object-cover rounded-lg mb-2 bg-gray-100" loading="lazy">
                    <h3 class="font-bold text-slate-800 text-xs sm:text-sm leading-tight mb-1 line-clamp-2 h-8 sm:h-10">${item.title}</h3>
                    <p class="text-[10px] sm:text-xs text-blue-600 font-medium bg-blue-50 px-2 py-1 rounded-full mt-auto self-start">
                        üî• ${(item.downloads||0).toLocaleString()}
                    </p>
                `;
                el.addEventListener('click', (e) => {
                    handleTopDownloadClick(e, item.id);
                });
                topList.appendChild(el);
            });
        }
        
        function loadGeneralRequests() {
            const generalRequestsList = document.getElementById('general-requests-list');
            if (!generalRequestsList || !db) return; 
            generalRequestsList.innerHTML = '<p class="text-slate-500 text-sm p-4 text-center">Cargando pedidos...</p>';
            if (window.generalRequestsUnsubscribe) window.generalRequestsUnsubscribe();
            
            const q = collection(db, `artifacts/${appId}/public/data/general-requests`);
            window.generalRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
                generalRequestsList.innerHTML = '';
                
                let requests = [];
                snapshot.forEach(doc => { 
                     const data = doc.data();
                     if (!data.text.toUpperCase().includes('[ROBOT]')) {
                        requests.push({ id: doc.id, ...data });
                    }
                });

                if (requests.length === 0) {
                      generalRequestsList.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-8 text-center opacity-80">
                            <span class="text-4xl mb-2">‚úÖ</span>
                            <p class="font-bold text-slate-600">¬°Todo al d√≠a!</p>
                            <p class="text-xs text-slate-400">Hasta el momento estamos actualizados.</p>
                        </div>
                      `;
                      return;
                }
                
                // Sort in memory (votes desc)
                requests.sort((a, b) => (b.votes || 0) - (a.votes || 0));
                
                // Helper format function (since it wasn't defined in snippet)
                const formatRequestText = (txt) => txt;

                requests.forEach(req => {
                    const voteClass = userVotes[req.id] ? 'vote-btn voted' : 'vote-btn';
                    const el = document.createElement('div');
                    el.className = 'request-board-item';
                    
                    const formattedContent = formatRequestText(req.text);
                    
                    el.innerHTML = `
                        <div class="request-text">
                            ${formattedContent}
                            <span class="block text-xs text-slate-500 mt-1">Pedido por: ${req.displayName || 'An√≥nimo'}</span>
                        </div>
                        <button class="${voteClass}" data-id="${req.id}">
                            ‚ñ≤ <span>${req.votes || 0}</span>
                        </button>
                    `;
                    generalRequestsList.appendChild(el);
                    el.querySelector('button').addEventListener('click', handleVote);
                });
            }, (e) => { console.log("Pedidos offline"); });
        }
        
        async function handleVote(e) {
            e.preventDefault(); 
            const btn = e.currentTarget;
            const id = btn.dataset.id;
            const user = auth.currentUser;
            if (!user) { await signInAnonymously(auth); }
            const ref = doc(db, `artifacts/${appId}/public/data/general-requests`, id);
            const isVoted = !!userVotes[id];
            try {
                await runTransaction(db, async (t) => {
                    const docSnap = await t.get(ref);
                    if(!docSnap.exists()) return;
                    const current = docSnap.data().votes || 0;
                    const newVotes = isVoted ? (current > 0 ? current - 1 : 0) : current + 1;
                    t.update(ref, { votes: newVotes });
                });
                if(isVoted) delete userVotes[id]; else userVotes[id] = true;
                localStorage.setItem('userVotes', JSON.stringify(userVotes));
            } catch(err) { console.error("Vote error", err); }
        }

        // --- TTS FUNCTION (VOZ DEL ROBOT) ---
        function speak(text) {
            if (!isSpeechEnabled || !window.speechSynthesis) return;
            
            // Cancelar cualquier audio anterior para no saturar
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.5; // Velocidad 1.5x (R√°pido)
            utterance.pitch = 1.0; // Tono normal
            utterance.volume = 1.0; // Volumen m√°ximo
            utterance.lang = isEnglish ? 'en-US' : 'es-ES'; // Idioma din√°mico
            
            window.speechSynthesis.speak(utterance);
        }

        // --- SPEAKER TOGGLE LOGIC ---
        const speakerToggle = document.getElementById('ai-speaker-toggle');
        const speakerOnIcon = document.getElementById('speaker-on');
        const speakerOffIcon = document.getElementById('speaker-off');

        if (speakerToggle && speakerOnIcon && speakerOffIcon) {
            speakerToggle.addEventListener('click', () => {
                isSpeechEnabled = !isSpeechEnabled;
                
                if (isSpeechEnabled) {
                    speakerOnIcon.classList.remove('hidden');
                    speakerOffIcon.classList.add('hidden');
                    // Opcional: Decir algo para confirmar
                    speak(isEnglish ? "Audio activated." : "Audio activado.");
                } else {
                    speakerOnIcon.classList.add('hidden');
                    speakerOffIcon.classList.remove('hidden');
                    window.speechSynthesis.cancel(); // Callar inmediatamente
                }
            });
        }

        // --- GOOGLE STYLE AUTOCOMPLETE & SUGGESTIONS ---
        const aiChatInput = document.getElementById('ai-chat-input');
        const suggestionsBox = document.getElementById('search-suggestions');

        if(aiChatInput && suggestionsBox) {
            aiChatInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                if(query.length < 2) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                const matches = allSoftware.filter(item => 
                    item.title.toLowerCase().includes(query) || 
                    (item.category && item.category.toLowerCase().includes(query))
                ).slice(0, 5); // Limit to 5 suggestions

                if(matches.length > 0) {
                    let html = '';
                    matches.forEach(item => {
                        // Highlight match logic (Simple)
                        const title = item.title;
                        const regex = new RegExp(`(${query})`, 'gi');
                        const highlightedTitle = title.replace(regex, '<span class="suggestion-match">$1</span>');
                        
                        html += `<div class="suggestion-item" data-id="${item.id}" data-title="${title}">
                                    ${highlightedTitle} <span class="text-xs text-gray-400 ml-2">(${item.platform})</span>
                                 </div>`;
                    });
                    suggestionsBox.innerHTML = html;
                    suggestionsBox.style.display = 'block';
                    
                    // Add click listeners to items
                    suggestionsBox.querySelectorAll('.suggestion-item').forEach(el => {
                        el.addEventListener('click', () => {
                            const id = el.dataset.id;
                            const title = el.dataset.title;
                            aiChatInput.value = title;
                            suggestionsBox.style.display = 'none';
                            // Automatically trigger "search/chat" with exact context
                            handleTopDownloadClick(null, id); // Direct open or chat response
                            
                            // Optional: Make bot say something
                            const msgs = document.getElementById('ai-chat-messages');
                            msgs.innerHTML += `<div class="ai-chat-bubble user">${title}</div>`;
                            setTimeout(() => {
                                const reply = isEnglish ? `Here is ${title}. Downloading now...` : `Aqu√≠ tienes ${title}. Preparando descarga...`;
                                msgs.innerHTML += `<div class="ai-chat-bubble ai">${reply}</div>`;
                                msgs.scrollTop = msgs.scrollHeight;
                                speak(reply);
                            }, 500);
                        });
                    });
                } else {
                    suggestionsBox.style.display = 'none';
                }
            });

            // Hide suggestions on click outside
            document.addEventListener('click', (e) => {
                if (!aiChatInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                    suggestionsBox.style.display = 'none';
                }
            });
        }

        // --- NEW CHAT LOGIC FIX (ROBUST & SMART LOCAL FALLBACK) ---
        // --- CHAT IA REPARADO Y BLINDADO ---
        async function sendAiMessage() {
            const input = document.getElementById('ai-chat-input');
            const suggestionsBox = document.getElementById('search-suggestions');
            if(suggestionsBox) suggestionsBox.style.display = 'none'; 
            
            const text = input.value.trim();
            if (!text) return;
            
            // 1. Mostrar mensaje del usuario
            const msgs = document.getElementById('ai-chat-messages');
            msgs.innerHTML += `<div class="ai-chat-bubble user">${text}</div>`;
            input.value = '';
            msgs.scrollTop = msgs.scrollHeight;

            const user = auth.currentUser;
            const userName = user && !user.isAnonymous ? (user.displayName || 'Amigo') : 'Amigo';
            
            // üî• API KEY FIJA (No borrar)
            const apiKey = "AIzaSyAiWoTawt-HDu5-mD_UpxjKncb55JkGRSE"; 
            
            try {
                let reply = "";
                
                // 2. CONEXI√ìN CON GEMINI
                if (apiKey) {
                    const inventoryList = allSoftware.map(s => `- ID: ${s.id} | NOMBRE: ${s.title}`).join('\n');
                    
                    // PROMPT DE INGENIER√çA ESTRICTA (Orden Forzado)
                    const finalPrompt = `
                        ROL: Eres DUV, el sistema operativo de esta web.
                        CONTEXTO: El usuario busca software.
                        
                        INVENTARIO ACTUAL:
                        ${inventoryList}
                        
                        IDIOMA: ${isEnglish ? 'INGL√âS' : 'ESPA√ëOL'}
                        
                        --- INSTRUCCIONES DE RESPUESTA (SIGUE ESTRICTAMENTE ESTE ORDEN) ---
                        
                        CASO A: EL USUARIO PIDE UN SOFTWARE QUE S√ç TIENES EN EL INVENTARIO
                        1. (L√≠nea 1) Confirma corto: "S√≠, tengo [Nombre] listo." (No expliques qu√© hace).
                        2. (L√≠nea 2) EXPLICACI√ìN OBLIGATORIA (Tu personalidad): "Advertencia del Sistema: El bot√≥n de descarga tiene un peque√±o peaje. Primer clic abre publicidad (ci√©rrala), Segundo clic activa la espera de 15s. ¬°Es el costo de la seguridad!"
                        3. (L√≠nea 3 - FINAL) Solo pon el c√≥digo: [LINK:ID_DEL_ITEM_EN_INVENTARIO]
                        
                        CASO B: EL USUARIO PIDE ALGO QUE NO TIENES
                        1. Di: "No encuentro [Nombre] en mi base de datos."
                        2. Pon el c√≥digo: [ADD_TO_BOARD:Nombre]
                        
                        CASO C: EL USUARIO SOLO CONVERSA
                        1. Responde con tu personalidad de IA atrapada. NO INVENTES LINKS.
                        
                        ENTRADA DEL USUARIO: "${text}"
                    `;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{parts: [{text: text}]}], systemInstruction: { parts: [{ text: finalPrompt }] } })
                    });
                    
                    const data = await response.json();
                    if(data.candidates && data.candidates[0].content) {
                        reply = data.candidates[0].content.parts[0].text;

                        // --- 3. TRADUCTOR VISUAL (El que crea el bot√≥n) ---
                        
                        // Limpiar texto para la voz
                        let textForSpeech = reply.replace(/\[LINK:[^\]]+\]/g, isEnglish ? "Download link below." : "Enlace de descarga abajo.")
                                                 .replace(/\[ADD_TO_BOARD:[^\]]+\]/g, isEnglish ? "Request noted." : "Pedido anotado.")
                                                 .replace(/\*/g, ""); 

                        // TRANSFORMACI√ìN DEL LINK EN BOT√ìN
                        reply = reply.replace(/\[LINK:\s*([^\]]+)\s*\]/g, (match, cardId) => {
                            const cleanId = cardId.trim();
                            const item = allSoftware.find(i => i.id === cleanId);
                            const title = item ? item.title : 'Software';
                            // HTML del bot√≥n
                            return `
                                <div class="mt-3 w-full flex justify-center">
                                    <button class="chat-link-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition-transform transform active:scale-95 flex items-center gap-2 border-b-4 border-blue-800" data-card-id="${cleanId}">
                                        <span>üì•</span> ${isEnglish ? 'DOWNLOAD' : 'DESCARGAR'} ${title}
                                    </button>
                                </div>
                            `;
                        });

                        // Transformaci√≥n de Pedido
                        reply = reply.replace(/\[ADD_TO_BOARD:\s*([^\]]+)\s*\]/g, (match, name) => {
                            if(typeof addSoftwareRequest === 'function') addSoftwareRequest(name.trim()); 
                            return `<br><em class="text-green-600 text-xs font-bold block mt-2">‚úÖ ${isEnglish ? 'Added to Request Board' : 'A√±adido a la Pizarra'}: ${name}</em>`;
                        });

                        // Renderizar en el chat
                        msgs.innerHTML += `<div class="ai-chat-bubble ai">${reply}</div>`;
                        msgs.scrollTop = msgs.scrollHeight;

                        // Hablar
                        if(typeof speak === 'function') speak(textForSpeech);

                        // --- 4. ACTIVADOR DE CLICS (CR√çTICO) ---
                        // Damos tiempo al navegador para pintar el bot√≥n y luego le pegamos el evento
                        setTimeout(() => {
                            const buttons = msgs.querySelectorAll('.chat-link-btn');
                            buttons.forEach(btn => {
                                // Sobrescribimos el onclick directamente para asegurar que funcione
                                btn.onclick = (e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    const targetId = e.currentTarget.dataset.cardId;
                                    
                                    console.log("üöÄ Abriendo desde chat:", targetId);
                                    
                                    closeModal('ai-chat-modal'); // Cerrar chat
                                    if(typeof handleTopDownloadClick === 'function') {
                                        handleTopDownloadClick(null, targetId); // Ir a la ficha
                                    }
                                };
                            });
                        }, 200);

                        return; // Salimos para no ejecutar l√≥gica local
                    }
                }
                
                // Si la API falla o no hay respuesta, mostrar error
                msgs.innerHTML += `<div class="ai-chat-bubble ai text-red-500">Error de conexi√≥n con el n√∫cleo.</div>`;

            } catch (err) {
                console.error(err);
                msgs.innerHTML += `<div class="ai-chat-bubble ai">Error: ${err.message}</div>`;
            }
        }
        // Re-bind chat form correctly
        const originalChatForm = document.getElementById('ai-chat-form');
        if (originalChatForm) {
            const newForm = originalChatForm.cloneNode(true);
            originalChatForm.parentNode.replaceChild(newForm, originalChatForm);
            
            newForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendAiMessage();
            });
            
            // Re-bind mic
            const micBtn = newForm.querySelector('#ai-chat-mic');
            if(micBtn) micBtn.addEventListener('click', () => alert(isEnglish ? "Voice under maintenance." : "Voz en mantenimiento."));
        }

        // --- FIX COMMENT SUBMIT (Enter & Click) ---
        // --- ENV√çO DE COMENTARIOS (CON COPIA AL ADMIN) ---
        const submitComment = async () => {
            const input = document.getElementById('comment-input');
            const text = input.value.trim();
            if(!text || !currentItemId) return;
            
            // Force Auth
            let user = auth.currentUser;
            if(!user) {
                try {
                    const cred = await signInAnonymously(auth);
                    user = cred.user;
                } catch(e) { console.error(e); return; }
            }
            
            // 1. Guardar en la ficha del software (Para que se vea en la web)
            await addDoc(collection(db, `artifacts/${appId}/public/data/comments`, currentItemId, 'messages'), {
                text: text, 
                uid: user.uid, 
                displayName: user.uid === ADMIN_ID ? 'Admin' : 'Usuario', 
                timestamp: serverTimestamp()
            });
            
            // 2. üî• MENSAJE ESPEJO AL ADMIN (Para que t√∫ lo veas) üî•
            const currentItemName = allSoftware.find(i => i.id === currentItemId)?.title || currentItemId;
            await addDoc(collection(db, `artifacts/${appId}/public/data/general-requests`), {
                text: `[üí¨ ${currentItemName}] ${text}`, // Etiqueta especial para identificarlo
                lowerCaseName: text.toLowerCase(),
                timestamp: serverTimestamp(),
                uid: user.uid,
                displayName: 'Comentario Web',
                votes: 0,
                type: 'comment_mirror' // Marca interna
            });
            
            // Update counter locally
            const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, currentItemId);
            updateDoc(itemRef, { commentsCount: increment(1) }).catch(console.error);

            const item = allSoftware.find(i => i.id === currentItemId);
            logActivity('Comentario', item ? item.title : 'Item', text);
            
            input.value = '';
            alert("Comentario enviado."); // Feedback visual r√°pido
        };

        const commentBtn = document.getElementById('submit-comment-btn');
        if (commentBtn) {
            // Remove old listeners
            const newBtn = commentBtn.cloneNode(true);
            commentBtn.parentNode.replaceChild(newBtn, commentBtn);
            newBtn.addEventListener('click', submitComment);
        }

        const commentInput = document.getElementById('comment-input');
        if (commentInput) {
            // Remove old listeners
            const newInput = commentInput.cloneNode(true);
            commentInput.parentNode.replaceChild(newInput, commentInput);
            newInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitComment();
                }
            });
        }

// --- üì° RADAR: SE√ëAL DE VIDA PARA EL ADMIN ---
        const enviarLatido = async () => {
            if (!auth.currentUser) return; // Si no est√° logueado, no env√≠a nada
            const esMovil = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            
            try {
                // Escribimos en la base de datos que estamos vivos
                await setDoc(doc(db, `artifacts/${appId}/public/data/presence`, auth.currentUser.uid), {
                    platform: esMovil ? 'mobile' : 'pc',
                    timestamp: serverTimestamp(),
                    flag: 'üåç' // Icono de visitante normal
                });
            } catch (e) { console.log("Radar silencioso..."); }
        };

        // Activar el repetidor y la configuraci√≥n cuando el usuario entra
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // 1. Radar (Tu se√±al de vida)
                enviarLatido(); 
                setInterval(enviarLatido, 30000); 

                // 2. Conexi√≥n con el Cerebro del Admin (IA Personalizada)
                // Esto permite que cambies lo que dice la IA desde el panel de control
                const configRef = doc(db, `artifacts/${appId}/public/data/config`, "siteSettings");
                onSnapshot(configRef, (s) => {
                    const data = s.data();
                    if (data) {
                        // Guardamos el Prompt Maestro en una variable global
                        if (data.systemPrompt) {
                            window.globalSystemPrompt = data.systemPrompt; 
                            console.log("üß† Personalidad DUV actualizada desde Admin.");
                        }
                        // Actualizamos el anuncio del chat si existe
                        const adContainer = document.getElementById('ai-chat-ad-container');
                        if (adContainer && data.aiChatAd) {
                            adContainer.innerHTML = data.aiChatAd;
                            adContainer.classList.remove('hidden');
                        }
                    }
                }, (e) => console.log("Config offline"));
            }
        });
    </script>
</body>
</html>