<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descargar Ultima Version - Software y Juegos Full</title>

    <!-- METADATA & SEO -->
    <meta name="description" content="Descarga las √∫ltimas versiones de tu software favorito. Adobe, 3ds Max, Blender, Office y m√°s. Versiones full, verificadas.">
    <meta name="google-site-verification" content="QKoomqLzQqAgclq1tgbxrJG3aaRX4iiIrPCp0XP4yRE" />
    <meta name="keywords" content="descargar, software, ultima version, full, adobe, blender, apk mod, android, pc, free download">
    <meta name="author" content="Descargar Ultima Version">
    <meta name="robots" content="index, follow">

    <!-- Pasaporte Mundial -->
    <link rel="alternate" hreflang="x-default" href="https://mi-web-descargas.vercel.app/" />

    <!-- Open Graph / Twitter -->
    <meta property="og:title" content="Descargar √öltima Versi√≥n - Software Seguro y Full">
    <meta property="og:description" content="Software verificado y seguro. Adobe, Office, Juegos y m√°s.">
    <meta property="og:image" content="https://mi-web-descargas.vercel.app/imagen-preview.jpg?v=1">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <!-- Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; margin: 0; }
        .hidden { display: none !important; }
        svg { width: 24px; height: 24px; display: inline-block; vertical-align: middle; }
        img { max-width: 100%; height: auto; display: block; }
        
        /* LOGO */
        .logo { width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #38bdf8, #3b82f6); border-radius: 14px; color: white; font-weight: 800; font-size: 32px; transform: rotate(-15deg); box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }
        
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        
        /* Modales */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; backdrop-filter: blur(5px); }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 0; border-radius: 16px; max-width: 900px; width: 95%; position: relative; margin: 1rem; transform: scale(0.95); transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; overflow-x: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-overlay.open .modal-content { transform: scale(1); }
        
        /* Video Containers */
        .modal-video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background: #000; }
        .modal-video-container-vertical { position: relative; width: 100%; padding-bottom: 177.77%; height: 0; overflow: hidden; border-radius: 12px; background: #000; }
        .modal-video-container iframe, .modal-video-container-vertical iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        
        /* UI Elements */
        .nav-link { cursor: pointer; }
        .nav-link.active { color: #2563eb; font-weight: 700; }
        .tab-button { cursor: pointer; transition: all 0.2s; }
        .active-tab { border-bottom-color: #2563eb !important; color: #2563eb !important; background-color: #eff6ff !important; }
        
        /* Chat IA */
        #ai-chat-content { width: 95%; max-width: 450px; height: 80vh; max-height: 600px; display: flex; flex-direction: column; }
        #ai-chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; background: #fff; }
        .ai-chat-bubble { max-width: 85%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.5rem; word-wrap: break-word; line-height: 1.4; font-size: 0.95rem; }
        .ai-chat-bubble.user { background-color: #3b82f6; color: white; border-bottom-right-radius: 0.25rem; align-self: flex-end; margin-left: auto; }
        .ai-chat-bubble.ai { background-color: #f3f4f6; color: #1f2937; border-bottom-left-radius: 0.25rem; align-self: flex-start; margin-right: auto; border: 1px solid #e5e7eb; }
        
        /* Animations */
        @keyframes highlight-card { 0% { transform: scale(1); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        .card-highlight { animation: highlight-card 2s ease-in-out; border-color: #2563eb; z-index: 10; position: relative; }
        
        /* Banners Mobile/PC */
        @media (max-width: 768px) {
            #mobile-ad-top { position: fixed; top: 0; left: 0; width: 100%; height: 60px; display: flex !important; justify-content: center; align-items: center; background: #fff; z-index: 50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
            body { padding-top: 60px; }
            #pc-ad-top-downloads { display: none !important; }
        }
        @media (min-width: 769px) {
            #mobile-ad-top { display: none !important; }
            #pc-ad-top-downloads { display: flex !important; justify-content: center; align-items: center; width: 100%; max-width: 728px; margin: 0 auto; }
        }

        /* Comentarios & Pizarra - CORREGIDO OVERFLOW */
        .comment { background-color: #f8fafc !important; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .comment.admin-comment { background-color: #f0f9ff !important; border-color: #bae6fd; }
        .request-board-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 0.75rem 1rem; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 0.75rem; gap: 10px; }
        .request-text { flex: 1; min-width: 0; word-break: break-word; overflow-wrap: anywhere; } 
        .vote-btn { background-color: #f1f5f9; color: #64748b; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; cursor: pointer; flex-shrink: 0; }
        .vote-btn.voted { background-color: #dbeafe; color: #2563eb; border: 1px solid #93c5fd; }
        
        /* Scroll Horizontal & Stories */
        .scroll-container { -ms-overflow-style: none; scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
        .scroll-container::-webkit-scrollbar { height: 6px; }
        .scroll-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Drag Cursor Styles */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }

        /* --- STORIES ESTILO FACEBOOK CORREGIDO --- */
        .story-card {
            width: 105px !important; /* ANCHO FIJO */
            height: 175px !important; /* ALTO FIJO */
            flex: 0 0 auto;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            border: 1px solid #e2e8f0; 
            padding: 0;
            background: #f1f5f9;
            transition: transform 0.2s;
            user-select: none; 
        }
        .story-card:hover { transform: scale(1.02); }
        
        .story-inner { width: 100%; height: 100%; position: relative; }

        .story-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transition: transform 0.5s; display: block;
        }
        .story-card:hover .story-img { transform: scale(1.05); }
        
        .story-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
            padding: 8px 6px; color: white;
            display: flex; flex-direction: column; justify-content: flex-end;
            height: 100%; pointer-events: none;
        }
        
        .story-title {
            font-size: 0.75rem; font-weight: 700; line-height: 1.15; text-align: left;
            text-shadow: 0 1px 2px rgba(0,0,0,0.9);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 2px;
        }
        
        .story-user-icon {
            position: absolute; top: 8px; left: 8px; width: 36px; height: 36px;
            border-radius: 50%; border: 3px solid #2563eb; 
            background: white; display: flex; align-items: center; justify-content: center;
            font-size: 14px; z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); pointer-events: none;
        }
        
        @media (min-width: 640px) {
            .story-card { width: 120px !important; height: 200px !important; }
        }
        
        /* Estilos Pizarra Links - MEJORADOS */
        .robot-link-btn {
            display: inline-flex; align-items: center; gap: 4px;
            background-color: #eff6ff; color: #2563eb;
            font-size: 0.75rem; padding: 4px 10px; border-radius: 6px;
            border: 1px solid #bfdbfe; text-decoration: none;
            margin-top: 6px; font-weight: 700; transition: all 0.2s;
        }
        .robot-link-btn:hover { background-color: #dbeafe; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1); }
    </style>
    <link rel="icon" type="image/png" href="favicon.png">
</head>

<body class="text-slate-800 flex flex-col min-h-screen">

    <div id="mobile-ad-top">
      <div id="adsterra-mobile">
        <script type="text/javascript">
            atOptions = { 'key' : '8bc9527f0527b1ea5f2e3fc1efd1083d', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="//honeywhyvowel.com/8bc9527f0527b1ea5f2e3fc1efd1083d/invoke.js"></script>
      </div>
    </div>
    
    <div id="app" class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex-grow">
        
        <!-- Header -->
        <header class="mb-4">
            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 pb-2 border-b border-slate-200">
                <div class="flex items-center gap-4">
                    <div class="logo">D</div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-900">Descargar Ultima Version</h1>
                </div>
            </div>
        </header>

        <!-- STORIES CONTAINER -->
        <div class="mb-2">
            <h3 class="text-sm font-bold text-slate-500 mb-2 px-1">‚ú® √öltimas Actualizaciones</h3>
            <div id="stories-container" class="flex overflow-x-auto gap-2.5 py-2 px-1 snap-x scroll-container no-scrollbar pb-4 cursor-grab">
                <div class="story-card animate-pulse border-slate-200"><div class="w-full h-full bg-slate-200"></div></div>
                <div class="story-card animate-pulse border-slate-200"><div class="w-full h-full bg-slate-200"></div></div>
                <div class="story-card animate-pulse border-slate-200"><div class="w-full h-full bg-slate-200"></div></div>
            </div>
        </div>
        
        <!-- BIENVENIDA -->
        <div class="mt-2 mb-6 relative rounded-2xl shadow-xl overflow-hidden border border-slate-600/50 group">
            <div class="absolute inset-0">
                <img src="imagen-preview.jpg?v=1" class="w-full h-full object-cover opacity-80" alt="Background">
            </div>
            <div class="absolute inset-0 bg-gradient-to-br from-slate-900/90 via-slate-900/70 to-blue-900/60 backdrop-blur-[2px]"></div>
            <div class="relative z-10 p-6 sm:p-10 text-center">
                <h2 class="text-2xl sm:text-3xl font-bold text-white mb-4 flex flex-col sm:flex-row items-center justify-center gap-3">
                    <span class="text-4xl">üõ°Ô∏è</span> <span>Tu Zona Segura de Descargas</span>
                </h2>
                <p class="text-slate-100 text-base sm:text-lg font-medium leading-relaxed max-w-4xl mx-auto">
                    Internet es una jungla llena de virus y enlaces rotos. 
                    <span class="text-cyan-300 font-bold bg-blue-900/40 px-2 rounded border border-blue-500/30">Nosotros somos tu filtro.</span>
                    Nuestro equipo rastrea y verifica manualmente los mejores archivos de la red para tra√©rtelos limpios y seguros.
                </p>
                <div class="mt-8 bg-white/10 backdrop-blur-md p-5 rounded-xl border border-white/20 shadow-2xl text-left max-w-3xl mx-auto">
                    <div class="flex flex-col sm:flex-row gap-4 items-start">
                        <span class="text-4xl sm:text-3xl self-center sm:self-start bg-yellow-500/20 rounded-full p-2">üí°</span>
                        <div class="text-slate-100 text-sm sm:text-base leading-relaxed w-full">
                            <strong class="text-yellow-300 tracking-wide text-lg block sm:inline mb-1 sm:mb-0">OJO:</strong> 
                            Estos son archivos de otras p√°ginas, pero al traerlos aqu√≠, si alguno presenta alg√∫n tipo de virus <strong class="text-red-300">es eliminado instant√°neamente.</strong>
                            <br class="hidden sm:block mb-2">
                            As√≠ es que si√©ntete seguro de descargarlo desde aqu√≠, venga de donde venga.
                            <span class="block mt-3 font-bold text-cyan-200 text-base border-l-4 border-cyan-400 pl-3 bg-cyan-900/20 p-2 rounded-r">
                                No arriesgues tu equipo buscando por fuera; aqu√≠ ya hicimos el trabajo duro por ti.
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu -->
        <nav id="nav-container" class="mb-8 p-4 bg-white rounded-xl shadow-sm border border-slate-200 z-40 relative">
            <p class="text-slate-500 text-sm text-center">Cargando categor√≠as...</p>
        </nav>
        
        <!-- Top Downloads -->
        <div id="top-downloads-container" class="mb-8 p-6 bg-white rounded-xl shadow-sm border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-4">
                <h2 class="text-2xl font-bold text-slate-900 flex-shrink-0 flex items-center gap-2">
                    <svg class="h-6 w-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.2 3.31a.75.75 0 00-1.4 0l-1.11 4.331a.75.75 0 01-.692.518l-4.502.39a.75.75 0 00-.434 1.336l3.41 2.812a.75.75 0 01.248.746l-1.03 4.41a.75.75 0 001.12.825l3.854-2.26a.75.75 0 01.762 0l3.854 2.26a.75.75 0 001.12-.825l-1.03-4.41a.75.75 0 01.248-.746l3.41-2.812a.75.75 0 00-.434-1.336l-4.502-.39a.75.75 0 01-.692-.518L11.2 3.31z" clip-rule="evenodd"></path></svg>
                    üî• Lo M√°s Descargado
                </h2>
                <div id="pc-ad-top-downloads">
                 <script type="text/javascript">atOptions = { 'key' : 'a09ade7f1de75ea02cb1d7597a7a2ae6', 'format' : 'iframe', 'height' : 90, 'width' : 728, 'params' : {} };</script>
                 <script type="text/javascript" src="//honeywhyvowel.com/a09ade7f1de75ea02cb1d7597a7a2ae6/invoke.js"></script>
                </div>
            </div>
            <div id="top-downloads-list" class="flex overflow-x-auto pb-4 gap-4 snap-x snap-mandatory scroll-container">
                <p class="text-slate-500 text-sm w-full text-center py-4">Cargando...</p>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="mb-6 sm:mb-8">
            <div class="flex flex-wrap border-b border-slate-300 bg-white rounded-t-xl overflow-hidden shadow-sm">
              <button id="tab-pc" class="tab-button flex-1 text-blue-700 bg-blue-100 border-b-4 border-blue-600 font-semibold py-3">üñ•Ô∏è Descargas para PC</button>
              <button id="tab-mobile" class="tab-button flex-1 text-slate-500 bg-slate-100 border-b-4 border-transparent font-semibold py-3">üì± Descargas para M√≥vil</button>
            </div>
        </div>

        <main class="w-full">
            <div id="content-pc" class="tab-content">
                <h2 class="text-2xl sm:text-3xl font-bold text-blue-700 mb-6">Descargas para PC</h2>
                <div id="content-grid-pc" class="card-container"><p class="text-slate-500 text-sm">Cargando...</p></div>
                <div id="no-results-pc" class="hidden text-center py-16"><h2 class="text-2xl font-semibold text-slate-700">No se encontraron resultados</h2></div>
            </div>
            <div id="content-mobile" class="tab-content hidden">
                <h2 class="text-2xl sm:text-3xl font-bold text-green-700 mb-6">Descargas para M√≥vil</h2>
                <div id="content-grid-mobile" class="card-container"><p class="text-slate-500 text-sm">Cargando...</p></div>
                <div id="no-results-mobile" class="hidden text-center py-16"><h2 class="text-2xl font-semibold text-slate-700">No se encontraron resultados</h2></div>
            </div>
        </main>
    </div>

    <!-- BOT√ìN FLOTANTE -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 items-end">
        <div class="bg-white/90 backdrop-blur text-slate-800 text-xs font-bold py-2 px-3 rounded-lg shadow-md mb-1 animate-bounce">¬øBuscas algo? üëá</div>
        <button id="open-ai-chat-btn" class="flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-4 px-7 rounded-full shadow-2xl transform transition hover:scale-110 active:scale-95 border-2 border-white/50 backdrop-blur-sm animate-pulse">
            <svg style="width: 32px; height: 32px;" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </button>
    </div>

    <!-- ===== MODALES ===== -->
    <div id="download-gate-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="download-gate-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 z-50 bg-white rounded-full p-1 shadow-sm"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <div class="flex flex-col md:flex-row h-full">
                <div class="w-full md:w-2/3 bg-black relative">
                      <div id="video-container-wrapper" class="modal-video-container h-full rounded-none md:rounded-l-xl">
                        <iframe id="gate-video-iframe" src="" frameborder="0" allowfullscreen class="w-full h-full absolute inset-0"></iframe>
                    </div>
                </div>
                <div class="w-full md:w-1/3 p-6 flex flex-col justify-center items-center bg-gradient-to-br from-white to-slate-50">
                    <h2 class="text-2xl font-extrabold text-slate-900 mb-2 text-center">¬øC√≥mo descargar?</h2>
                    <p class="text-slate-600 text-sm text-center mb-6">Mira el video para aprender a saltar la publicidad.</p>
                    <button id="proceed-download-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform transition hover:scale-105 active:scale-95 text-lg flex items-center justify-center gap-2 animate-pulse">
                        <span>¬°Ya vi el video, DAME EL ARCHIVO!</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="yape-modal" class="modal-overlay">
        <div class="yape-modal-content">
            <button id="yape-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-xl font-bold text-slate-900 mb-4">Donar con Yape</h2>
            <img src="imagenes/yape.jpeg" alt="QR Yape" class="w-48 h-48 mx-auto rounded-lg border border-slate-200 mb-6" onerror="this.style.display='none'">
            <button id="open-yape-btn" class="w-full bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-purple-700 transition-colors">Abrir Yape</button>
        </div>
    </div>
    
    <div id="comments-modal" class="modal-overlay">
        <div class="comments-modal-content">
            <button id="comments-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-xl font-bold text-slate-900 mb-4" id="comments-modal-title">Comentarios</h2>
            <div id="comments-list" class="flex-grow"><p class="text-slate-500 text-sm">Cargando...</p></div>
            <div class="mt-4 pt-4 border-t border-slate-200">
                <textarea id="comment-input" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Escribe tu comentario..."></textarea>
                <div class="flex justify-between items-center mt-3">
                      <!-- BOT√ìN REPORTAR LINK -->
                      <button id="report-link-btn" class="text-xs text-red-500 font-bold hover:text-red-700 flex items-center gap-1 border border-red-200 bg-red-50 px-3 py-1.5 rounded-full transition-colors">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Reportar Link Roto
                      </button>
                    <button id="submit-comment-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Enviar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="download-guide-modal" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <button id="download-guide-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="ml-4 text-xl sm:text-2xl font-bold text-slate-900">GU√çA R√ÅPIDA</h2>
            <p class="text-slate-700 text-base mb-5">Sigue los pasos en el video para saltar publicidad.</p>
            <button id="download-guide-continue-btn" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 text-lg">¬°Entendido!</button>
        </div>
    </div>

    <!-- Modal Admin Dashboard (MEJORADO CON HERRAMIENTA DE MIGRACI√ìN) -->
    <div id="admin-dashboard-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="admin-dashboard-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-xl font-bold text-slate-900 mb-4 p-4 border-b">Panel de Actividad & Herramientas</h2>
            <div class="p-4">
                <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-bold text-yellow-800 mb-2">Herramienta de Recuperaci√≥n</h3>
                    <p class="text-sm text-yellow-700 mb-3">Si te faltan fichas de la web anterior, pulsa este bot√≥n. El sistema buscar√° en la base de datos vieja y las copiar√° aqu√≠.</p>
                    <button id="migrate-db-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded shadow-md transition-colors flex justify-center items-center gap-2">
                        <span>üîÑ IMPORTAR DATOS DE LA WEB ANTIGUA</span>
                    </button>
                    <p id="migration-status" class="text-xs text-center mt-2 font-mono text-slate-500"></p>
                </div>
                <h3 class="font-bold text-slate-700 mb-2">Actividad Reciente</h3>
                <div id="admin-logs-container" class="overflow-y-auto" style="max-height: 40vh;">
                    <p class="text-slate-500 text-center">Cargando actividad...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Chat IA -->
    <div id="ai-chat-modal" class="modal-overlay">
        <div id="ai-chat-content" class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-slate-200 bg-slate-50">
                <div><h2 id="ai-chat-greeting" class="text-lg font-bold text-slate-900">¬°Hola! üëã</h2></div>
                <button id="ai-speaker-toggle" class="p-2 rounded-full text-slate-600 hover:bg-slate-200 transition-colors">
                     <svg id="speaker-on" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M10 21v-7m0 0V3m0 0a2 2 0 100 4v0m0-4a2 2 0 010 4v0m7.536-1.464a9 9 0 010 12.728M10 3H7a2 2 0 00-2 2v14a2 2 0 002 2h3m0-18v18"></path></svg>
                     <svg id="speaker-off" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15.1l-2.829 2.829a1 1 0 01-1.414-1.414L15.9 2.8A1 1 0 0117.3 4.2l-2.8 2.8m0 0a5 5 0 01-7.072 0M10 21v-7m0 0V3m0 0a2 2 0 100 4v0m0-4a2 2 0 010 4v0m7.536-1.464a9 9 0 010 12.728M10 3H7a2 2 0 00-2 2v14a2 2 0 002 2h3m0-18v18"></path></svg>
                </button>
                <button id="ai-chat-modal-close" class="text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            
            <div id="ai-chat-ad-container" class="bg-pink-50 border-b border-pink-200 p-3 flex items-center gap-3 cake-ad-anim shadow-sm">
                 <div class="flex-shrink-0 bg-white p-1 rounded-full shadow border border-pink-100"><img src="./imagenes/thaliacakes.png" class="w-12 h-12 rounded-full object-cover shadow-sm border border-pink-200" alt="Thalia Cakes" onerror="this.src='https://placehold.co/100x100/pink/white?text=TC'"></div>
                 <div class="flex-grow text-left"><h3 class="font-bold text-pink-600 text-sm leading-tight">Thalia Cakes üéÇ</h3><p class="text-xs text-slate-600">¬°Dulzura!</p></div>
                 <a href="https://www.facebook.com/share/1GY4SEQJTx/" target="_blank" class="bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white text-xs font-bold py-1.5 px-3 rounded-full transition shadow-sm transform hover:scale-105">Ver m√°s</a>
            </div>

            <div id="ai-chat-messages" class="flex-grow flex flex-col p-4 space-y-2 overflow-y-auto bg-white">
                <div class="ai-chat-bubble ai">Hola, soy DUV. ¬øQu√© buscas hoy?</div>
            </div>
            <div class="p-4 border-t border-slate-200 bg-slate-50">
                <div id="ai-chat-error" class="hidden text-sm text-red-600 bg-red-100 p-3 rounded-lg mb-3"></div>
                <form id="ai-chat-form" class="flex items-center gap-3">
                    <input type="text" id="ai-chat-input" placeholder="Escribe..." class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" autocomplete="off">
                    <button type="button" id="ai-chat-mic" class="p-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors flex items-center justify-center min-w-[44px] min-h-[44px]">
                         <svg id="mic-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                         <svg id="mic-listening" class="h-6 w-6 text-red-500 hidden animate-pulse" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"></circle></svg>
                    </button>
                    <button type="submit" id="ai-chat-submit" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center min-w-[44px] min-h-[44px]">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <footer class="bg-slate-100 border-t border-slate-200 w-full">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 text-center">
            <h2 class="text-2xl font-bold text-slate-900">Un Proyecto Hecho para Ti</h2>
            <div class="mt-8 flex flex-wrap justify-center items-center gap-4">
                <button id="yape-modal-open" class="bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-purple-700 flex items-center gap-2">Yape</button>
                <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=lahsvergon_23%40hotmail.com&item_name=Apoyo" target="_blank" class="bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-blue-700 flex items-center gap-2">PayPal</a>
                <a href="https://t.me/descargas_ultima_version_vip" target="_blank" class="inline-flex items-center gap-2 bg-sky-500 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-sky-600 transition-colors">Telegram</a>
            </div>
            <div class="mt-6">
                <a href="https://wa.me/51924814457" target="_blank" class="inline-flex items-center gap-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-full">WhatsApp</a>
            </div>
            <div class="mt-10 pt-8 border-t border-slate-300 max-w-2xl mx-auto text-left">
                <h3 class="text-xl font-bold text-slate-900 text-center mb-6">Pizarra de Pedidos</h3>
                <div id="general-requests-list" class="mb-4 max-h-96 overflow-y-auto p-2 bg-white rounded-lg shadow-inner border border-slate-200">
                    <p class="text-slate-500 text-sm p-4 text-center">Cargando...</p>
                </div>
            </div>
            <div class="mt-10 pt-8 border-t border-slate-300 max-w-2xl mx-auto text-center flex flex-col items-center gap-2">
                <button id="admin-login-btn" class="text-sm text-slate-500 hover:text-blue-600">Login (Admin)</button>
                <p id="admin-status" class="text-sm text-green-600 mt-2 hidden"></p>
                <!-- BOT√ìN OCULTO POR DEFECTO CON STYLE DISPLAY NONE -->
                <button id="ver-actividad-btn" style="display: none;" class="text-sm bg-slate-800 text-white px-3 py-1 rounded-full hover:bg-slate-700 transition-colors flex items-center gap-2 mx-auto">
                    <span>üëÅÔ∏è</span> Abrir Panel & Herramientas
                </button>
            </div>
        </div>
    </footer>
    
    <div class="flex flex-col items-center justify-center my-8 px-4">
        <div class="rounded-xl overflow-hidden shadow-md border-2 border-green-500/30 bg-white p-1 hover:scale-105 transition-transform duration-300">
             <a href="https://exe.io/ref/lahsvergon" target="_blank"><img src="https://exe.io/img/ref/r1.gif" title="¬°Gana dinero acortando enlaces!" alt="Exe.io Banner" class="max-w-full h-auto rounded-lg" /></a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, limit, addDoc, serverTimestamp, runTransaction, increment, updateDoc, getDocs, where, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN H√çBRIDA (INTOCABLE) ---
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : null;

        // CONFIG ACTUAL (NUEVA)
        const userConfig = {
          apiKey: "AIzaSyDeNCckeg9KYlsk__1UQF1yA64WK_nb3Vw", 
          authDomain: "web-descargarultimaversion.firebaseapp.com",
          projectId: "web-descargarultimaversion",
          storageBucket: "web-descargarultimaversion.firebasestorage.app",
          messagingSenderId: "1028999431387",
          appId: "1:1028999431387:web:3f6799e9adfca72d3078fe",
          measurementId: "G-BZRK62Y3S5"
        };

        // CONFIG ANTIGUA (PARA MIGRACI√ìN)
        const oldFirebaseConfig = {
          apiKey: "AIzaSyCPB82qY7h3YGvk_cClAw5so0DFgiePzNM",
          authDomain: "descargar-ultima-version.firebaseapp.com",
          projectId: "descargar-ultima-version",
          storageBucket: "descargar-ultima-version.firebasestorage.app",
          messagingSenderId: "1028999431387",
          appId: "1:1028999431387:web:3f6799e9adfca72d3078fe",
          measurementId: "G-BZRK62Y3S5"
        };

        const firebaseConfig = envConfig || userConfig;
        const appId = envAppId || "descargar-ultima-version"; 
        const ADMIN_ID = "vDq0ZPy7f0UYpTzP44H0nvRDPYD2";

        // --- ESTADO GLOBAL ---
        let app, db, auth;
        let allSoftware = [];
        let activeTab = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'mobile' : 'pc';
        let currentCategory = 'home';
        let currentSearchTerm = '';
        let userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');
        let userVotes = JSON.parse(localStorage.getItem('userVotes') || '{}');
        let radarInterval = null;
        let configUnsubscribe = null;
        let softwareUnsubscribe = null;
        let requestsUnsubscribe = null;
        let unsubscribeActivity = null; 
        let currentItemId = null;
        let currentDownloadLink = null;
        window.commentsUnsubscribe = null;
        window.generalRequestsUnsubscribe = null;
        let isFirstLoad = true;

        // UI Refs
        const tabPc = document.getElementById('tab-pc');
        const tabMobile = document.getElementById('tab-mobile');
        const contentPc = document.getElementById('content-pc');
        const contentMobile = document.getElementById('content-mobile');
        const navContainer = document.getElementById('nav-container');
        
        let dynamicSystemPrompt = "Eres DUV, un asistente √∫til.";
        let isSpeechEnabled = true;

        if (activeTab === 'mobile') {
            setTabActive(tabMobile, tabPc);
            contentPc.classList.add('hidden');
            contentMobile.classList.remove('hidden');
            if(navContainer) navContainer.classList.add('hidden');
        } else {
            setTabActive(tabPc, tabMobile);
            contentMobile.classList.add('hidden');
            contentPc.classList.remove('hidden');
            if(navContainer) navContainer.classList.remove('hidden');
        }

        function setTabActive(activeBtn, inactiveBtn) {
            if (activeBtn) {
                activeBtn.classList.add('active-tab', 'text-blue-700', 'bg-blue-100', 'border-blue-600');
                activeBtn.classList.remove('text-slate-500', 'bg-slate-100', 'border-transparent');
            }
            if (inactiveBtn) {
                inactiveBtn.classList.remove('active-tab', 'text-blue-700', 'bg-blue-100', 'border-blue-600');
                inactiveBtn.classList.add('text-slate-500', 'bg-slate-100', 'border-transparent');
            }
        }

        // --- EVENT LISTENERS ---
        if(tabPc) tabPc.addEventListener('click', () => {
            activeTab = 'pc';
            currentCategory = 'home';
            setTabActive(tabPc, tabMobile);
            contentMobile.classList.add('hidden');
            contentPc.classList.remove('hidden');
            if(navContainer) navContainer.classList.remove('hidden');
            updateView();
        });
        if(tabMobile) tabMobile.addEventListener('click', () => {
            activeTab = 'mobile';
            setTabActive(tabMobile, tabPc);
            contentPc.classList.add('hidden');
            contentMobile.classList.remove('hidden');
            if(navContainer) navContainer.classList.add('hidden');
            updateView();
        });

        const modalMap = { 'yape-modal-open': 'yape-modal', 'open-ai-chat-btn': 'ai-chat-modal' };
        Object.keys(modalMap).forEach(id => { 
            const btn = document.getElementById(id); 
            if(btn) btn.addEventListener('click', () => { openModal(modalMap[id]); }); 
        });

        function openGateModal(downloadLink) {
            currentDownloadLink = downloadLink; 
            const modal = document.getElementById('download-gate-modal');
            const iframe = document.getElementById('gate-video-iframe');
            const videoContainerWrapper = document.getElementById('video-container-wrapper');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const videoId = isMobile ? "sZ1BZN9tnDw" : "Zs-1k7F0_vE"; 
            
            if (videoContainerWrapper) {
                if (isMobile) {
                    videoContainerWrapper.classList.remove('modal-video-container');
                    videoContainerWrapper.classList.add('modal-video-container-vertical');
                } else {
                    videoContainerWrapper.classList.remove('modal-video-container-vertical');
                    videoContainerWrapper.classList.add('modal-video-container');
                }
            }
            if(iframe) iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&showinfo=0&rel=0`;
            if(modal) modal.classList.add('open');
        }

        ['how-to-download-modal', 'yape-modal', 'comments-modal', 'download-guide-modal', 'ai-chat-modal', 'download-gate-modal', 'admin-dashboard-modal'].forEach(id => {
            const m = document.getElementById(id); 
            const c = document.getElementById(id+'-close');
            if(c) c.addEventListener('click', () => closeModal(id));
            if(m) m.addEventListener('click', (e) => { if(e.target === m) closeModal(id); });
        });
        
        function closeModal(id) {
            const el = document.getElementById(id);
            if(el) el.classList.remove('open');
            if(id === 'download-gate-modal') {
                const iframe = document.getElementById('gate-video-iframe');
                if(iframe) iframe.src = ""; 
            }
            if(id === 'comments-modal' && window.commentsUnsubscribe) { window.commentsUnsubscribe(); window.commentsUnsubscribe = null; }
            if(id === 'ai-chat-modal') window.speechSynthesis.cancel();
            if(id === 'admin-dashboard-modal' && unsubscribeActivity) { unsubscribeActivity(); unsubscribeActivity = null; }
        }

        const proceedBtn = document.getElementById('proceed-download-btn');
        if(proceedBtn) proceedBtn.addEventListener('click', () => {
            closeModal('download-gate-modal');
            if(currentDownloadLink) { window.open(currentDownloadLink, '_blank'); currentDownloadLink = null; }
        });

        const guideBtn = document.getElementById('download-guide-continue-btn');
        if(guideBtn) guideBtn.addEventListener('click', () => {
            closeModal('download-guide-modal');
            if(currentDownloadLink) { window.open(currentDownloadLink, '_blank'); currentDownloadLink = null; }
        });

        const openYapeBtn = document.getElementById('open-yape-btn');
        if(openYapeBtn) openYapeBtn.addEventListener('click', () => { window.location.href = "yape://"; });

        const adminBtn = document.getElementById('admin-login-btn');
        if(adminBtn) adminBtn.addEventListener('click', async () => {
            if (auth.currentUser) {
                await signOut(auth);
                adminBtn.textContent = "Login (Admin)";
                const status = document.getElementById('admin-status');
                const verBtn = document.getElementById('ver-actividad-btn');
                if(status) status.classList.add('hidden');
                // HIDE BUTTON WITH STYLE
                if(verBtn) verBtn.style.display = 'none';
            } else {
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { console.error(e); }
            }
        });
        
        const activityBtn = document.getElementById('ver-actividad-btn');
        if(activityBtn) activityBtn.addEventListener('click', () => {
            openModal('admin-dashboard-modal');
            loadActivityLogs();
        });

        if(navContainer) navContainer.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if(link) { e.preventDefault(); currentCategory = link.dataset.category; updateView(); }
        });

        const chatMessages = document.getElementById('ai-chat-messages');
        if(chatMessages) chatMessages.addEventListener('click', (e) => {
            if(e.target.classList.contains('chat-link')) {
                e.preventDefault(); closeModal('ai-chat-modal'); handleTopDownloadClick(null, e.target.dataset.cardId);
            }
        });

        function openModal(id) {
            const el = document.getElementById(id);
            if(el) el.classList.add('open');
            if(id === 'ai-chat-modal') {
                const input = document.getElementById('ai-chat-input');
                if(input) setTimeout(() => input.focus(), 100);
            }
        }
        
        function updateMetaTags(item) {
            if (!item) return;
            const ogImage = document.querySelector('meta[property="og:image"]');
            if (ogImage && item.imageUrl) ogImage.setAttribute('content', item.imageUrl);
            const twitterImage = document.querySelector('meta[name="twitter:image"]');
            if (twitterImage && item.imageUrl) twitterImage.setAttribute('content', item.imageUrl);
            const ogTitle = document.querySelector('meta[property="og:title"]');
            if (ogTitle) ogTitle.setAttribute('content', `Descargar ${item.title} - Full`);
        }
        
        // --- FUNCI√ìN DE REGISTRO VISITA CON BANDERA (√öNICA) ---
        async function logActivity(type, itemName, detail = "") {
            try {
                const user = auth.currentUser;
                const uid = user ? user.uid : "Anonimo";
                
                let flag = "";
                if (type === 'Visita') {
                      try {
                        const response = await fetch("https://ipwho.is/");
                        const data = await response.json();
                        if (data.success) flag = data.flag.emoji; 
                      } catch(e) {}
                }
                
                // ADMIN ID FIX
                const finalUid = (uid === ADMIN_ID) ? "üëë ADMIN (Yo)" : uid;

                await addDoc(collection(db, `artifacts/${appId}/public/data/activity-logs`), {
                    type: type, 
                    item: itemName,
                    detail: detail,
                    uid: finalUid,
                    timestamp: serverTimestamp(),
                    flag: flag 
                });
            } catch(e) { console.error("Log error", e); }
        }

        // --- Helper de Seguridad para Im√°genes ---
        function isValidImageUrl(url) {
            if (!url) return false;
            const invalidExtensions = ['.apk', '.exe', '.zip', '.rar', '.7z', '.msi', '.iso', '.bin', '.bat', '.cmd'];
            const lowerUrl = url.toLowerCase();
            return !invalidExtensions.some(ext => lowerUrl.includes(ext));
        }

        // --- CARDS RENDER ---
        function renderCards(items, container, noResults) {
            container.innerHTML = '';
            if (items.length === 0) { noResults.classList.remove('hidden'); container.classList.add('hidden'); return; }
            noResults.classList.add('hidden'); container.classList.remove('hidden');
            const sorted = items.sort((a, b) => {
                const da = a.createdAt ? a.createdAt.toDate() : new Date(0);
                const db = b.createdAt ? b.createdAt.toDate() : new Date(0);
                return db - da;
            });
            sorted.forEach(item => {
                let placeholder = activeTab === 'mobile' ? '16a34a/ffffff' : 'e2e8f0/94a3b8';
                if(item.category && item.category.includes('adobe')) placeholder = '1e40af/ffffff';
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200 hover:shadow-lg transition-all duration-300 relative';
                card.id = `card-${item.id}`;
                let dateStr = "Reciente";
                if(item.createdAt && item.createdAt.toDate) dateStr = item.createdAt.toDate().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                
                const formatTextContent = (text) => {
                    if (!text) return "";
                    if (text.includes('<') && text.includes('>')) return text; 
                    return text.replace(/\n/g, '<br>'); 
                };

                const installTextFormatted = formatTextContent(item.installation || "Descomprimir y ejecutar el setup. Si pide contrase√±a: <code>taiwebs.com</code>");
                const updateTextFormatted = formatTextContent(item.updates || "Versi√≥n optimizada y verificada.");

                const heartClass = userLikes[item.id] ? 'text-red-500' : 'text-slate-400';

                // VALIDACI√ìN DE IMAGEN PARA EVITAR DESCARGAS AUTOM√ÅTICAS
                const safeImgUrl = isValidImageUrl(item.imageUrl) ? item.imageUrl : `https://placehold.co/600x400/${placeholder}?text=No+Image`;

                // CONCATENACI√ìN VISUAL: T√≠tulo + Versi√≥n
                const displayTitle = `${item.title} ${item.version ? `<span class="text-sm font-normal text-slate-500 ml-1">${item.version}</span>` : ''}`;

                card.innerHTML = `
                    <img src="${safeImgUrl}" alt="${item.title}" style="width: 100%; height: 192px; object-fit: cover;" onerror="this.src='https://placehold.co/600x400/${placeholder}?text=Error'">
                    <div class="p-5">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-slate-500">${dateStr}</span>
                            <span class="inline-flex items-center gap-1 text-xs text-blue-600 font-medium bg-blue-50 px-2 py-0.5 rounded-full download-counter">
                                <svg style="width:12px;height:12px;" fill="currentColor" viewBox="0 0 20 20"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.23a.75.75 0 00-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.905 3.084V2.75z"></path></svg>
                                ${item.downloads || 0}
                            </span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2 leading-tight line-clamp-2" title="${item.title}">${displayTitle}</h3>
                        <p class="text-slate-600 text-sm mb-4 h-16 overflow-hidden leading-relaxed line-clamp-3">${item.description || ''}</p>
                        <details class="group mb-4 text-sm">
                            <summary class="list-none cursor-pointer text-blue-600 font-semibold hover:text-blue-800 transition-colors flex items-center gap-1"><span>‚ÑπÔ∏è Ver detalles e instalaci√≥n</span></summary>
                            <div class="mt-3 p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <div class="mb-3">
                                    <h4 class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-1">üì• Instalaci√≥n</h4>
                                    <div class="text-slate-600 text-xs leading-relaxed">${installTextFormatted}</div>
                                </div>
                                <div class="border-t border-dashed border-slate-300 my-3"></div>
                                <div>
                                    <h4 class="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">‚ú® Novedades</h4>
                                    <div class="text-slate-600 text-xs leading-relaxed">${updateTextFormatted}</div>
                                </div>
                            </div>
                        </details>
                        <div class="flex flex-col gap-3">
                            <button class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors download-btn-action" data-id="${item.id}" data-title="${item.title}" data-link="${item.downloadLink}">DESCARGAR</button>
                            <a href="https://t.me/descargas_ultima_version_vip" target="_blank" class="mx-auto bg-sky-500 text-white font-bold py-1.5 px-5 rounded-full hover:bg-sky-600 transition-all animate-pulse flex items-center justify-center gap-2 text-xs shadow-lg transform hover:scale-105 border border-sky-400 w-fit mt-2 mb-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>
                                Suscribirse
                            </a>
                            <div class="flex justify-center items-center gap-8 pt-3 border-t border-slate-100 mt-1">
                                <button class="group flex flex-col items-center gap-1 hover:text-red-500 transition-colors like-btn-action ${heartClass}" data-id="${item.id}" data-title="${item.title}">
                                    <svg class="w-7 h-7 transition-transform group-hover:scale-110" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                                    <span class="text-[10px] font-bold likes-count-display">${item.likes || 0}</span>
                                </button>
                                <button class="group flex flex-col items-center gap-1 text-slate-400 hover:text-blue-500 transition-colors comment-btn-action" data-id="${item.id}" data-title="${item.title}">
                                    <svg class="w-7 h-7 transition-transform group-hover:scale-110" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg>
                                    <span class="text-[10px] font-bold comments-count-display">${item.commentsCount || 0}</span>
                                </button>
                                <button class="group flex flex-col items-center gap-1 text-slate-400 hover:text-green-500 transition-colors share-btn-action" data-id="${item.id}">
                                    <svg class="w-7 h-7 transition-transform group-hover:scale-110" fill="currentColor" viewBox="0 0 20 20"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
            
            // PROTECCI√ìN PARA EVENTOS DE BOTONES DIN√ÅMICOS
            container.querySelectorAll('.download-btn-action').forEach(b => {
                if (b) b.addEventListener('click', handleDownloadAction);
            });
            container.querySelectorAll('.like-btn-action').forEach(b => {
                if (b) b.addEventListener('click', handleLikeAction);
            });
            container.querySelectorAll('.comment-btn-action').forEach(b => {
                if (b) b.addEventListener('click', handleCommentAction);
            });
            container.querySelectorAll('.share-btn-action').forEach(b => {
                if (b) b.addEventListener('click', handleShareAction);
            });
        }

        // --- FUNCI√ìN DE REPORTE DE ACTUALIZACI√ìN ---
        async function handleUpdateReport(e) {
            e.preventDefault();
            const title = e.target.dataset.title;
            const id = e.target.dataset.id;
            
            if(confirm(`¬øLa aplicaci√≥n ${title} te est√° pidiendo actualizar? Si es as√≠, av√≠sanos para subir la nueva versi√≥n.`)) {
                // Agregar a Pizarra de Pedidos como URGENTE
                await addSoftwareRequest(`[URGENTE-UPDATE] ${title}`);
                alert("¬°Gracias por el aviso! ü¶Ö Revisaremos y subiremos la nueva versi√≥n lo antes posible.");
            }
        }

        function updateView() {
            if (!allSoftware.length) return;
            // FIX: Filtro ampliado para recuperar items "Android" o "Windows" y may√∫sculas/min√∫sculas
            let filtered = allSoftware.filter(i => {
                const p = (i.platform || '').toLowerCase();
                if (activeTab === 'mobile') {
                    return p === 'mobile' || p === 'android' || p === 'apk';
                } else {
                    return p === 'pc' || p === 'windows' || p === 'desktop';
                }
            });
            
            if (currentCategory !== 'home' && activeTab === 'pc') filtered = filtered.filter(i => i.category === currentCategory);
            if (currentSearchTerm) filtered = filtered.filter(i => i.title.toLowerCase().includes(currentSearchTerm.toLowerCase()));
            const container = activeTab === 'pc' ? document.getElementById('content-grid-pc') : document.getElementById('content-grid-mobile');
            const noRes = activeTab === 'pc' ? document.getElementById('no-results-pc') : document.getElementById('no-results-mobile');
            renderCards(filtered, container, noRes);
        }

        // --- ACTIONS ---
        async function handleDownloadAction(e) {
            e.preventDefault();
            const id = e.currentTarget.dataset.id;
            const title = e.currentTarget.dataset.title;
            const link = e.currentTarget.dataset.link;
            if (!link || link === '#' || link === 'undefined') { alert("Enlace no disponible."); return; }
            
            const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, id);
            updateDoc(itemRef, { downloads: increment(1) }).catch(console.error);
            
            // LOGGING
            logActivity('Descarga', title || 'Desconocido');
            
            openGateModal(link);
        }

        async function handleLikeAction(e) {
            e.preventDefault();
            const btn = e.currentTarget;
            const id = btn.dataset.id;
            const title = btn.dataset.title;
            if (!auth.currentUser) await signInAnonymously(auth);
            const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, id);
            const isLiked = !!userLikes[id];
            const span = btn.querySelector('.likes-count-display');
            let current = parseInt(span.textContent) || 0;
            if (isLiked) {
                userLikes[id] = false; 
                btn.classList.remove('text-red-500');
                btn.classList.add('text-slate-400');
                span.textContent = Math.max(0, current - 1);
                await updateDoc(itemRef, { likes: increment(-1) });
            } else {
                userLikes[id] = true; 
                btn.classList.remove('text-slate-400');
                btn.classList.add('text-red-500');
                span.textContent = current + 1;
                await updateDoc(itemRef, { likes: increment(1) });
                logActivity('Like', title || 'Desconocido');
            }
            localStorage.setItem('userLikes', JSON.stringify(userLikes));
        }

        function handleCommentAction(e) {
            e.preventDefault();
            const id = e.currentTarget.dataset.id;
            currentItemId = id; 
            const item = allSoftware.find(i => i.id === id);
            document.getElementById('comments-modal-title').textContent = `Comentarios: ${item ? item.title : ''}`;
            openModal('comments-modal');
            loadComments(id);
        }

        function handleShareAction(e) {
            e.preventDefault();
            const id = e.currentTarget.dataset.id;
            const item = allSoftware.find(i => i.id === id);
            const url = `${window.location.origin}${window.location.pathname}?item=${id}`;
            if(item) updateMetaTags(item);

            if (navigator.share) {
                navigator.share({ 
                    title: item ? item.title : 'Descargar Software', 
                    text: `Mira esta descarga: ${item ? item.title : ''}`,
                    url: url 
                }).catch(err => console.log('Share canceled'));
            } else {
                navigator.clipboard.writeText(url).then(() => alert("Enlace copiado al portapapeles!"));
            }
        }
        
        function handleTopDownloadClick(e, cardId) {
             if (e) e.preventDefault();
            const itemId = cardId || (e ? e.currentTarget.dataset.itemId : null);
            if (!itemId) return;
            let item = allSoftware.find(i => i.id === itemId);
            if (!item) return;
            updateMetaTags(item);
            
            let itemTab = (item.platform || '').toLowerCase(); 
            if (itemTab === 'android' || itemTab === 'apk') itemTab = 'mobile'; // Normalizar
            if (itemTab === 'windows') itemTab = 'pc'; // Normalizar

            if (activeTab !== itemTab) {
                const tabToClick = (itemTab === 'pc') ? document.getElementById('tab-pc') : document.getElementById('tab-mobile');
                if (tabToClick) tabToClick.click();
            }
            setTimeout(() => {
                const cardElement = document.getElementById(`card-${item.id}`);
                if (cardElement) {
                    cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    cardElement.classList.add('card-highlight');
                    setTimeout(() => { cardElement.classList.remove('card-highlight'); }, 2000);
                }
            }, 300);
        }

        function loadComments(id) {
            const list = document.getElementById('comments-list');
            list.innerHTML = '<p class="text-center text-gray-500">Cargando...</p>';
            if (window.commentsUnsubscribe) window.commentsUnsubscribe();
            try {
                const q = query(collection(db, `artifacts/${appId}/public/data/comments`, id, 'messages'), orderBy('timestamp', 'desc'));
                window.commentsUnsubscribe = onSnapshot(q, (snapshot) => {
                    list.innerHTML = '';
                    if (snapshot.empty) { list.innerHTML = '<p class="text-center text-gray-400 py-4">S√© el primero en comentar.</p>'; return; }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        div.className = `comment ${data.uid === ADMIN_ID ? 'admin-comment' : ''}`;
                        div.innerHTML = `<div class="flex justify-between text-xs text-gray-400 mb-1"><span>${data.displayName || 'An√≥nimo'}</span><span>${data.timestamp?.toDate().toLocaleDateString() || ''}</span></div><p>${data.text}</p>`;                    list.appendChild(div);
                    });
                }, (error) => { console.log("Comentarios off (permisos)"); });
            } catch(e) {}
        }
        
        // --- ADMIN DASHBOARD LOADER (FUNCIONANDO) ---
        function loadActivityLogs() {
            const container = document.getElementById('admin-logs-container');
            if(!container) return;
            
            // REMOVIDO CHECK DE ADMIN_ID PARA PERMITIR MIGRACI√ìN TEMPORAL
            // const user = auth.currentUser;
            // if(!user || user.uid !== ADMIN_ID) { ... }
            
            container.innerHTML = '<p class="text-slate-500 text-center p-4">Cargando registros...</p>';
            
            // LOGICA DEL BOTON DE MIGRACION
            const migrateBtn = document.getElementById('migrate-db-btn');
            const status = document.getElementById('migration-status');
            if (migrateBtn) {
                migrateBtn.onclick = async () => {
                    if (!confirm("‚ö†Ô∏è ¬øIniciar la importaci√≥n de datos? Esto copiar√° las fichas antiguas a la nueva base de datos.")) return;
                    status.textContent = "Conectando a base antigua...";
                    migrateBtn.disabled = true;
                    migrateBtn.classList.add('opacity-50');
                    
                    try {
                        // 1. Conectar a DB vieja
                        const oldApp = initializeApp(oldFirebaseConfig, "OLD_APP");
                        const oldDb = getFirestore(oldApp);
                        
                        // 2. Leer datos viejos
                        status.textContent = "Leyendo datos antiguos...";
                        const oldSnapshot = await getDocs(collection(oldDb, 'artifacts/descargar-ultima-version/public/data/software-items'));
                        
                        if (oldSnapshot.empty) {
                            status.textContent = "‚ùå No se encontraron datos en la DB antigua.";
                            return;
                        }
                        
                        // 3. Copiar a DB nueva
                        let count = 0;
                        for (const oldDoc of oldSnapshot.docs) {
                            const data = oldDoc.data();
                            // Verificar si ya existe por ID o T√≠tulo para no duplicar
                            const existsRef = doc(db, `artifacts/${appId}/public/data/software-items`, oldDoc.id);
                            const existsSnap = await getDoc(existsRef);
                            
                            if (!existsSnap.exists()) {
                                await setDoc(existsRef, data);
                                count++;
                                status.textContent = `Importando... (${count} fichas)`;
                            }
                        }
                        
                        status.textContent = `‚úÖ ¬°√âxito! Se importaron ${count} fichas nuevas. Recarga la p√°gina.`;
                        alert(`Proceso finalizado. Se recuperaron ${count} descargas.`);
                        location.reload();
                        
                    } catch (e) {
                        console.error(e);
                        status.textContent = "‚ùå Error: " + e.message;
                        migrateBtn.disabled = false;
                        migrateBtn.classList.remove('opacity-50');
                    }
                };
            }
            
            // Cancelar listener anterior si existe
            if (unsubscribeActivity) unsubscribeActivity();
            
            const q = query(collection(db, `artifacts/${appId}/public/data/activity-logs`), orderBy('timestamp', 'desc'), limit(50));
            
            unsubscribeActivity = onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                if(snapshot.empty) {
                    container.innerHTML = '<p class="text-slate-500 text-center p-4">No hay actividad reciente.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const log = doc.data();
                    const time = log.timestamp ? log.timestamp.toDate().toLocaleTimeString() : '';
                    const date = log.timestamp ? log.timestamp.toDate().toLocaleDateString() : '';
                    
                    const div = document.createElement('div');
                    div.className = 'bg-white p-3 mb-2 rounded border border-slate-200 text-sm shadow-sm';
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-blue-600">${log.type || 'Info'} ${log.flag || ''}</span>
                            <span class="text-xs text-slate-400">${date} ${time}</span>
                        </div>
                        <p class="font-medium text-slate-800">${log.item || '-'}</p>
                        ${log.detail ? `<p class="text-xs text-slate-500 mt-1">${log.detail}</p>` : ''}
                        <p class="text-xs text-slate-400 mt-1">UID: ${log.uid ? log.uid.substring(0,8) + '...' : 'Anon'}</p>
                    `;
                    container.appendChild(div);
                });
            }, (error) => {
                console.error("Error logs:", error);
                container.innerHTML = '<p class="text-red-500 text-center">Error cargando logs (Permisos).</p>';
            });
        }

        // PROTECCI√ìN: Bot√≥n de comentario
        const submitCommentBtn = document.getElementById('submit-comment-btn');
        if (submitCommentBtn) {
            submitCommentBtn.addEventListener('click', async () => {
                const input = document.getElementById('comment-input');
                const text = input.value.trim();
                if(!text || !currentItemId) return;
                const user = auth.currentUser || (await signInAnonymously(auth)).user;
                
                // Guardar comentario
                await addDoc(collection(db, `artifacts/${appId}/public/data/comments`, currentItemId, 'messages'), {
                    text: text, uid: user.uid, displayName: user.uid === ADMIN_ID ? 'Admin' : 'Usuario', timestamp: serverTimestamp()
                });
                
                // Incrementar contador de comentarios en la ficha
                const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, currentItemId);
                updateDoc(itemRef, { commentsCount: increment(1) }).catch(console.error);

                const item = allSoftware.find(i => i.id === currentItemId);
                logActivity('Comentario', item ? item.title : 'Item', text);
                
                input.value = '';
            });
        }
        
        // REPORT BUTTON LOGIC
        const reportLinkBtn = document.getElementById('report-link-btn');
        if (reportLinkBtn) {
            reportLinkBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user || user.isAnonymous) {
                    try {
                        await signInWithPopup(auth, new GoogleAuthProvider());
                    } catch (e) {
                        alert("Debes iniciar sesi√≥n con Google para reportar.");
                        return;
                    }
                }
                
                if (confirm("¬øEst√°s seguro de reportar este enlace como ca√≠do?")) {
                    const item = allSoftware.find(i => i.id === currentItemId);
                    const title = item ? item.title : "Desconocido";
                    
                    // Add report to general requests
                    await addDoc(collection(db, `artifacts/${appId}/public/data/general-requests`), {
                        text: `[REPORT-LINK] Enlace ca√≠do: ${title}`,
                        lowerCaseName: `report ${title}`.toLowerCase(),
                        votes: 999, // High priority
                        displayName: user.displayName || 'Usuario Verificado',
                        uid: user.uid,
                        timestamp: serverTimestamp()
                    });
                    
                    alert("Reporte enviado al administrador. ¬°Gracias!");
                }
            });
        }

        // --- HELPER FUNCTION PARA PIZARRA LIMPIA (MEJORADA) ---
        function formatRequestText(text) {
            if (!text) return '';
            
            // Detectar si es un mensaje del Robot
            const robotRegex = /\[ROBOT\]\s*([\s\S]*?)\s*(https?:\/\/[^\s]+)/i;
            const match = text.match(robotRegex);
            
            if (match) {
                const appName = match[1];
                const url = match[2];
                return `
                    <div class="flex flex-col gap-1">
                        <span class="font-bold text-slate-800">${appName}</span>
                        <span class="text-xs text-green-600 font-bold uppercase tracking-wide bg-green-50 w-fit px-2 py-0.5 rounded border border-green-200">üöÄ Nueva versi√≥n detectada</span>
                        <a href="${url}" target="_blank" class="robot-link-btn">
                            <span>Ver Enlace</span>
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                        </a>
                    </div>
                `;
            }
            
            // Si no es robot, devolver texto normal
            return `<strong>${text}</strong>`;
        }

        // --- INIT & AUTH ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            const initAuth = async () => {
                // Wait a tick to see if persistence restores a user
                await new Promise(r => setTimeout(r, 500));
                
                if (!auth.currentUser) {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            // Only sign in anonymously if really no one is logged in
                            console.log("Iniciando an√≥nimo...");
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Auth Error:", e);
                    }
                }
            };
            initAuth();

            // CHAT IA LOGIC
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition = null;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'es-ES';
                recognition.continuous = false; 
                recognition.interimResults = false;
                recognition.onresult = (e) => {
                    const text = e.results[0][0].transcript;
                    document.getElementById('ai-chat-input').value = text;
                    stopListeningUI();
                };
                recognition.onerror = (e) => { stopListeningUI(); };
                recognition.onend = () => { stopListeningUI(); };
            }

            function stopListeningUI() {
                document.getElementById('mic-listening').classList.add('hidden');
                document.getElementById('mic-icon').classList.remove('hidden');
            }

            const micBtn = document.getElementById('ai-chat-mic');
            if(micBtn) {
                micBtn.addEventListener('click', () => {
                    if (!recognition) { alert("Tu navegador no soporta voz."); return; }
                    try { 
                        document.getElementById('mic-icon').classList.add('hidden'); 
                        document.getElementById('mic-listening').classList.remove('hidden');
                        recognition.start(); 
                    } catch (e) { stopListeningUI(); }
                });
            }

            const speakerToggle = document.getElementById('ai-speaker-toggle');
            if(speakerToggle) {
                speakerToggle.addEventListener('click', () => {
                    isSpeechEnabled = !isSpeechEnabled;
                    document.getElementById('speaker-on').classList.toggle('hidden');
                    document.getElementById('speaker-off').classList.toggle('hidden');
                    if(!isSpeechEnabled) window.speechSynthesis.cancel();
                });
            }

            function speak(text) {
                if(!isSpeechEnabled) return;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                window.speechSynthesis.speak(utterance);
            }

            const aiChatForm = document.getElementById('ai-chat-form');
            if (aiChatForm) {
                aiChatForm.addEventListener('submit', async (e) => {
                    e.preventDefault(); 
                    const input = document.getElementById('ai-chat-input');
                    const text = input.value.trim();
                    if (!text) return;
                    
                    const msgs = document.getElementById('ai-chat-messages');
                    msgs.innerHTML += `<div class="ai-chat-bubble user">${text}</div>`;
                    input.value = '';
                    msgs.scrollTop = msgs.scrollHeight;

                    // Contexto para la IA
                    const inventoryList = allSoftware.map(s => `- ID: ${s.id} | NOMBRE: ${s.title}`).join('\n');
                    const user = auth.currentUser;
                    const userName = user && !user.isAnonymous ? (user.displayName || 'Amigo') : 'Amigo';
                    
                    const finalPrompt = `
                        ACT√öA COMO: DUV (Inteligencia Artificial de Descargar Ultima Version), un experto amigable.
                        TONO: Natural, breve, jovial.
                        NOMBRE DEL USUARIO: ${userName}
                        INVENTARIO:
                        ${inventoryList}
                        
                        REGLAS:
                        1. Si piden algo que tienes, di "¬°Lo tengo!" y da el link en formato [LINK:ID_DEL_SOFTWARE].
                        2. Si no, di que lo anotas en la pizarra y usa [ADD_TO_BOARD:Nombre].
                        3. Ayuda con problemas de descarga (saltar publicidad exe.io).
                    `;

                    // LLAMADA A GEMINI
                    const apiKey = "AIzaSyAa5UK_-dsdt98eNnVykR40bcwZuYN2oB4"; 
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ 
                                contents: [{parts: [{text: text}]}], 
                                systemInstruction: { parts: [{ text: finalPrompt }] } 
                            })
                        });
                        const data = await response.json();
                        let reply = data.candidates[0].content.parts[0].text;
                        
                        reply = reply.replace(/\[LINK:([^\]]+)\]/g, (match, cardId) => {
                            const item = allSoftware.find(i => i.id === cardId);
                            return ` <a href="#" class="chat-link font-bold text-blue-600 underline" data-card-id="${cardId}">${item ? item.title : 'ver'}</a>`;
                        });
                        reply = reply.replace(/\[ADD_TO_BOARD:([^\]]+)\]/g, (match, name) => {
                            addSoftwareRequest(name); return ` <em>(A√±adido a pizarra: ${name})</em>`;
                        });

                        msgs.innerHTML += `<div class="ai-chat-bubble ai">${reply}</div>`;
                        msgs.scrollTop = msgs.scrollHeight;
                        speak(reply.replace(/<[^>]+>/g, ''));
                        
                        document.querySelectorAll('.chat-link').forEach(link => {
                            link.addEventListener('click', (e) => {
                                e.preventDefault(); handleTopDownloadClick(null, e.currentTarget.dataset.cardId); closeModal('ai-chat-modal');
                            });
                        });

                    } catch (err) {
                        console.error(err);
                        msgs.innerHTML += `<div class="ai-chat-bubble ai">Error de conexi√≥n.</div>`;
                    }
                });
            }

            // Improved Auth State Listener
            onAuthStateChanged(auth, user => {
                const status = document.getElementById('admin-status');
                const verBtn = document.getElementById('ver-actividad-btn');
                const loginBtn = document.getElementById('admin-login-btn');

                if (user) {
                    if (user.uid === ADMIN_ID) {
                        // ADMIN
                        if(status) { 
                            status.textContent = `‚úÖ ADMINISTRADOR ACTIVO`; 
                            status.classList.remove('hidden'); 
                            status.classList.remove('text-slate-500');
                            status.classList.add('text-green-600');
                        }
                        if(verBtn) { 
                            verBtn.style.display = 'inline-flex'; 
                            verBtn.classList.remove('hidden'); 
                        }
                    } else {
                        // USER
                        if(status) { 
                            status.textContent = `üë§ Usuario (ID: ${user.uid.substring(0,6)}...)`; 
                            status.classList.remove('hidden'); 
                            status.classList.add('text-slate-500');
                            status.classList.remove('text-green-600');
                        }
                        if(verBtn) { 
                            verBtn.style.display = 'none'; 
                            verBtn.classList.add('hidden'); 
                        }
                    }
                    if(loginBtn) loginBtn.textContent = "Cerrar Sesi√≥n";
                } else {
                    // LOGGED OUT - RESET UI
                    if(status) status.classList.add('hidden');
                    if(verBtn) {
                        verBtn.style.display = 'none';
                        verBtn.classList.add('hidden');
                    }
                    if(loginBtn) loginBtn.textContent = "Login (Admin)";
                }
            });

            if (!sessionStorage.getItem('visitLogged')) {
                let userFlag = "üåç";
                async function fetchUserFlag() {
                    try {
                        const response = await fetch("https://ipwho.is/");
                        const data = await response.json();
                        if (data.success) userFlag = data.flag.emoji; 
                    } catch (e) {}
                    logActivity('Visita', 'Usuario nuevo', `Desde ${userFlag}`);
                }
                fetchUserFlag();
                sessionStorage.setItem('visitLogged', 'true');
            }

            if (!radarInterval) {
                let userFlag = "üåç";
                fetch("https://ipwho.is/").then(r => r.json()).then(d => { if(d.success) userFlag = d.flag.emoji; }).catch(()=>{});
                radarInterval = setInterval(() => {
                    const user = auth.currentUser;
                    if(user) {
                        setDoc(doc(db, `artifacts/${appId}/public/data/presence`, user.uid), { 
                            platform: activeTab, 
                            timestamp: serverTimestamp(),
                            flag: userFlag 
                        }).catch(() => {});
                    }
                }, 60000);
            }

            const storiesQ = query(collection(db, `artifacts/${appId}/public/data/software-items`), orderBy("createdAt", "desc"), limit(60));
            onSnapshot(storiesQ, (snapshot) => {
                const container = document.getElementById('stories-container');
                if (container) {
                    let html = '';
                    snapshot.forEach(doc => {
                        const item = doc.data();
                        const safeImgUrl = isValidImageUrl(item.imageUrl) ? item.imageUrl : 'https://placehold.co/150x250/e2e8f0/94a3b8?text=App';
                        html += `
                            <div class="story-card group" data-id="${doc.id}">
                                <div class="story-inner">
                                    <div class="story-user-icon">üî•</div>
                                    <img src="${safeImgUrl}" class="story-img" onerror="this.src='https://placehold.co/150x250/e2e8f0/94a3b8?text=Error'">
                                    <div class="story-overlay">
                                        <p class="story-title text-white drop-shadow-md">${item.title}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
            }, (e) => console.log("Stories offline"));
            
            // Story clicks
            const storiesContainer = document.getElementById('stories-container');
            if (storiesContainer) {
                storiesContainer.addEventListener('click', (e) => {
                    const card = e.target.closest('.story-card');
                    if (!card) return;
                    if (storiesContainer.classList.contains('was-dragged')) return;
                    handleTopDownloadClick(null, card.dataset.id);
                });
            }


            const radarRef = doc(db, `artifacts/${appId}/public/data/config`, "siteSettings");
            if(!configUnsubscribe) {
                 configUnsubscribe = onSnapshot(radarRef, (s) => {
                    const adContainer = document.getElementById('ai-chat-ad-container');
                    if (adContainer && s.exists()) {
                        const data = s.data();
                        if (data.aiChatAd && data.aiChatAd.trim() !== "") {
                            adContainer.innerHTML = data.aiChatAd; adContainer.classList.remove('hidden');
                        } else {
                            adContainer.classList.remove('hidden'); 
                        }
                    } else {
                        if(adContainer) adContainer.classList.remove('hidden');
                    }
                }, (e) => {});
            }
            
            if(!softwareUnsubscribe) {
                 const q = collection(db, `artifacts/${appId}/public/data/software-items`);
                 softwareUnsubscribe = onSnapshot(q, (snapshot) => {
                    allSoftware = [];
                    const categoriesMap = new Map();
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        allSoftware.push({ id: doc.id, ...data });
                        if (data.platform === 'pc' && data.category && !categoriesMap.has(data.category)) {
                            categoriesMap.set(data.category, { id: data.category, name: data.category.charAt(0).toUpperCase() + data.category.slice(1).replace(/-/g, ' ') });
                        }
                    });
                    
                    const navContainer = document.getElementById('nav-container');
                    if (navContainer) {
                        let html = '<ul class="flex flex-wrap justify-center gap-4">';
                        html += `<li><button class="nav-link font-medium hover:text-blue-600 transition ${currentCategory==='home'?'text-blue-600':''}" data-category="home">Inicio</button></li>`;
                        Array.from(categoriesMap.values()).sort((a,b) => a.name.localeCompare(b.name)).forEach(cat => {
                            html += `<li><button class="nav-link font-medium hover:text-blue-600 transition" data-category="${cat.id}">${cat.name}</button></li>`;
                        });
                        html += '</ul>';
                        navContainer.innerHTML = html;
                    }
                    
                    loadTopDownloads();
                    updateView();
                    
                    if (isFirstLoad) {
                        const urlParams = new URLSearchParams(window.location.search);
                        const sharedItem = urlParams.get('item');
                        if (sharedItem) {
                            setTimeout(() => {
                                const item = allSoftware.find(i => i.id === sharedItem);
                                if(item) updateMetaTags(item);
                                handleTopDownloadClick(null, sharedItem);
                                isFirstLoad = false;
                            }, 1500);
                        }
                    }
                }, (e) => console.log("Software offline"));
            }
            
            if(!requestsUnsubscribe) {
                 loadGeneralRequests();
            }

        } catch (e) { console.error("Error Firebase:", e); }

        
        async function addSoftwareRequest(softwareName) {
            if (!db) return;
            const user = auth.currentUser || (await signInAnonymously(auth)).user;
            const requestsCollection = collection(db, `artifacts/${appId}/public/data/general-requests`);
            const lowerCaseName = softwareName.toLowerCase().trim();
            const q = query(requestsCollection, where("lowerCaseName", "==", lowerCaseName));
            
            try {
                const existing = await getDocs(q);
                if (existing.empty) {
                    const newRequestRef = await addDoc(requestsCollection, {
                        text: softwareName, lowerCaseName: lowerCaseName, timestamp: serverTimestamp(),
                        uid: user.uid, displayName: (user.uid === ADMIN_ID) ? 'Admin' : (user.isAnonymous ? 'An√≥nimo' : (user.displayName || 'Usuario')), votes: 1 
                    });
                    userVotes[newRequestRef.id] = true;
                    localStorage.setItem('userVotes', JSON.stringify(userVotes));
                }
            } catch (e) {}
        }

        function loadTopDownloads() {
            const topList = document.getElementById('top-downloads-list');
            if (!topList || allSoftware.length === 0) return;
            const top = [...allSoftware].sort((a,b) => (b.downloads||0) - (a.downloads||0)).slice(0, 50);
            topList.innerHTML = '';
            top.forEach((item, idx) => {
                let placeholder = activeTab === 'mobile' ? '16a34a/ffffff' : 'e2e8f0/94a3b8';
                const safeImgUrl = isValidImageUrl(item.imageUrl) ? item.imageUrl : `https://placehold.co/600x400/${placeholder}?text=No+Image`;

                const el = document.createElement('div');
                el.className = "min-w-[180px] w-[180px] sm:min-w-[200px] sm:w-[200px] bg-white p-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all transform hover:-translate-y-1 snap-center flex flex-col relative";
                el.innerHTML = `
                    <div class="absolute top-2 left-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full z-10 shadow-sm">#${idx+1}</div>
                    <img src="${safeImgUrl}" class="w-full h-32 object-cover rounded-lg mb-2 bg-gray-100">
                    <h3 class="font-bold text-slate-800 text-sm leading-tight mb-1 line-clamp-2 h-10">${item.title}</h3>
                    <p class="text-xs text-blue-600 font-medium bg-blue-50 px-2 py-1 rounded-full mt-auto self-start">
                        üî• ${(item.downloads||0).toLocaleString()}
                    </p>
                `;
                el.addEventListener('click', (e) => {
                    handleTopDownloadClick(e, item.id);
                });
                topList.appendChild(el);
            });
        }
        
        function loadGeneralRequests() {
            const generalRequestsList = document.getElementById('general-requests-list');
            if (!generalRequestsList || !db) return; 
            generalRequestsList.innerHTML = '<p class="text-slate-500 text-sm p-4 text-center">Cargando pedidos...</p>';
            if (window.generalRequestsUnsubscribe) window.generalRequestsUnsubscribe();
            
            const q = collection(db, `artifacts/${appId}/public/data/general-requests`);
            window.generalRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
                generalRequestsList.innerHTML = '';
                
                let requests = [];
                snapshot.forEach(doc => { 
                    const data = doc.data();
                    if (!data.text.toUpperCase().includes('[ROBOT]')) {
                        requests.push({ id: doc.id, ...data });
                    }
                });

                if (requests.length === 0) {
                     generalRequestsList.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-8 text-center opacity-80">
                            <span class="text-4xl mb-2">‚úÖ</span>
                            <p class="font-bold text-slate-600">¬°Todo al d√≠a!</p>
                            <p class="text-xs text-slate-400">Hasta el momento estamos actualizados.</p>
                        </div>
                     `;
                     return;
                }
                
                requests.sort((a, b) => (b.votes || 0) - (a.votes || 0));
                
                requests.forEach(req => {
                    const voteClass = userVotes[req.id] ? 'vote-btn voted' : 'vote-btn';
                    const el = document.createElement('div');
                    el.className = 'request-board-item';
                    
                    const formattedContent = formatRequestText(req.text);
                    
                    el.innerHTML = `
                        <div class="request-text">
                            ${formattedContent}
                            <span class="block text-xs text-slate-500 mt-1">Pedido por: ${req.displayName || 'An√≥nimo'}</span>
                        </div>
                        <button class="${voteClass}" data-id="${req.id}">
                            ‚ñ≤ <span>${req.votes || 0}</span>
                        </button>
                    `;
                    generalRequestsList.appendChild(el);
                    el.querySelector('button').addEventListener('click', handleVote);
                });
            }, (e) => { console.log("Pedidos offline"); });
        }
        
        async function handleVote(e) {
            e.preventDefault(); 
            const btn = e.currentTarget;
            const id = btn.dataset.id;
            const user = auth.currentUser;
            if (!user) { await signInAnonymously(auth); }
            const ref = doc(db, `artifacts/${appId}/public/data/general-requests`, id);
            const isVoted = !!userVotes[id];
            try {
                await runTransaction(db, async (t) => {
                    const docSnap = await t.get(ref);
                    if(!docSnap.exists()) return;
                    const current = docSnap.data().votes || 0;
                    const newVotes = isVoted ? (current > 0 ? current - 1 : 0) : current + 1;
                    t.update(ref, { votes: newVotes });
                });
                if(isVoted) delete userVotes[id]; else userVotes[id] = true;
                localStorage.setItem('userVotes', JSON.stringify(userVotes));
            } catch(err) { console.error("Vote error", err); }
        }

    </script>
</body>
</html>