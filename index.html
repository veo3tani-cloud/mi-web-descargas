<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descargar Ultima Version - Software y Juegos Full</title>

    <!-- ================================================================== -->
    <!-- üåç BLOQUE DE VIRALIDAD Y SEO MUNDIAL (VERIFICADO) üåç               -->
    <!-- ================================================================== -->
    <meta name="description" content="Descarga las √∫ltimas versiones de tu software favorito. Adobe, 3ds Max, Blender, Office y m√°s. Versiones full, verificadas y actualizadas diariamente.">
    <!-- TU LLAVE DE GOOGLE -->
    <meta name="google-site-verification" content="QKoomqLzQqAgclq1tgbxrJG3aaRX4iiIrPCp0XP4yRE" />
    <meta name="keywords" content="descargar, software, ultima version, full, adobe, blender, office, photoshop, premiere, apk mod, android, pc, free download">
    <meta name="author" content="Descargar Ultima Version">
    <meta name="robots" content="index, follow">

    <!-- Pasaporte Mundial -->
    <link rel="alternate" hreflang="es" href="https://mi-web-descargas.vercel.app/" />
    <link rel="alternate" hreflang="en" href="https://mi-web-descargas.vercel.app/" />
    <link rel="alternate" hreflang="pt" href="https://mi-web-descargas.vercel.app/" />
    <link rel="alternate" hreflang="fr" href="https://mi-web-descargas.vercel.app/" />
    <link rel="alternate" hreflang="ru" href="https://mi-web-descargas.vercel.app/" />
    <link rel="alternate" hreflang="hi" href="https://mi-web-descargas.vercel.app/" />
    <link rel="alternate" hreflang="x-default" href="https://mi-web-descargas.vercel.app/" />

    <!-- Tarjeta Viral -->
    <meta property="og:title" content="Descargar √öltima Versi√≥n - Software Seguro y Full">
    <meta property="og:description" content="¬øBuscas software sin virus? Aqu√≠ publicamos lo que pasa nuestros filtros de seguridad. Adobe, Office, Juegos y m√°s. ¬°Entra ya!">
    <meta property="og:image" content="https://mi-web-descargas.vercel.app/imagen-preview.jpg">
    <meta property="og:url" content="https://mi-web-descargas.vercel.app/">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Descargar Ultima Version">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Descargar √öltima Versi√≥n - Software Seguro">
    <meta name="twitter:description" content="Descargas directas y verificadas de software y juegos.">
    <meta name="twitter:image" content="https://mi-web-descargas.vercel.app/imagen-preview.jpg">

    <!-- Autoridad -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "Descargar Ultima Version",
      "url": "https://mi-web-descargas.vercel.app/",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://mi-web-descargas.vercel.app/?q={search_term_string}",
        "query-input": "required name=search_term_string"
      },
      "description": "El mejor repositorio de software verificado y seguro para PC y M√≥vil."
    }
    </script>

    <!-- üõ°Ô∏è ESCUDO ANTI-FALLOS üõ°Ô∏è -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; margin: 0; }
        .hidden { display: none !important; }
        svg { width: 24px; height: 24px; max-width: 100%; display: inline-block; vertical-align: middle; }
        img { max-width: 100%; height: auto; display: block; }
        .logo { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #38bdf8, #3b82f6); border-radius: 12px; color: white; font-weight: 800; font-size: 28px; transform: rotate(-15deg); }
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        
        /* Modales */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 90%; width: 600px; position: relative; margin: 1rem; transform: scale(0.95); transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .modal-content { transform: scale(1); }
        .modal-video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; margin-top: 1rem; border-radius: 8px; background: #000; }
        .modal-video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        
        /* Navegaci√≥n */
        .nav-link.active { color: #2563eb; font-weight: 700; }
        .nav-link { cursor: pointer; }
        
        /* Chat IA */
        #ai-chat-content { width: 95%; max-width: 450px; height: 80vh; max-height: 600px; display: flex; flex-direction: column; }
        #ai-chat-messages { flex-grow: 1; overflow-y: auto; padding: 1rem; background: #fff; }
        .ai-chat-bubble { max-width: 85%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.5rem; word-wrap: break-word; line-height: 1.4; font-size: 0.95rem; }
        .ai-chat-bubble.user { background-color: #3b82f6; color: white; border-bottom-right-radius: 0.25rem; align-self: flex-end; margin-left: auto; }
        .ai-chat-bubble.ai { background-color: #f3f4f6; color: #1f2937; border-bottom-left-radius: 0.25rem; align-self: flex-start; margin-right: auto; border: 1px solid #e5e7eb; }
        
        /* Animaciones */
        @keyframes highlight-card { 0% { transform: scale(1); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); } 50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); } 100% { transform: scale(1); } }
        .card-highlight { animation: highlight-card 2s ease-in-out; border-color: #2563eb; z-index: 10; position: relative; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        /* Pesta√±as */
        .tab-button { cursor: pointer; transition: all 0.2s; }
        .active-tab { border-bottom-color: #2563eb !important; color: #2563eb !important; background-color: #eff6ff !important; }

        /* Banners */
        @media (max-width: 768px) {
            #mobile-ad-top { position: fixed; top: 0; left: 0; width: 100%; height: 60px; display: flex !important; justify-content: center; align-items: center; background: #fff; z-index: 50; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
            body { padding-top: 60px; }
            #pc-ad-top-downloads { display: none !important; }
        }
        @media (min-width: 769px) {
            #mobile-ad-top { display: none !important; }
            #pc-ad-top-downloads { display: flex !important; justify-content: center; align-items: center; width: 100%; max-width: 728px; margin: 0 auto; }
        }
        
        /* Comentarios */
        .comment { background-color: #f8fafc !important; border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .comment p { color: #334155 !important; font-size: 0.95rem; line-height: 1.5; } 
        .comment span { color: #94a3b8; font-size: 0.75rem; }
        .comment.admin-comment { background-color: #f0f9ff !important; border-color: #bae6fd; }
        
        /* Ticker */
        .ticker-wrap { width: 100%; overflow: hidden; background-color: #1e293b; color: white; padding: 8px 0; font-size: 0.9rem; white-space: nowrap; box-sizing: border-box; }
        .ticker { display: inline-block; padding-left: 100%; animation: ticker 35s linear infinite; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }
        .ticker-item { display: inline-block; padding: 0 2rem; font-weight: 600; }
        .ticker-highlight { color: #fbbf24; text-shadow: 0 0 5px rgba(251, 191, 36, 0.3); }

        /* Publicidad Tortas */
        @keyframes gentle-bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
        .cake-ad-anim { animation: gentle-bounce 2s infinite ease-in-out; }

        details > summary { list-style: none; outline: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        
        /* Scroll Horizontal (Carrusel) */
        .scroll-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: thin;  /* Firefox */
            scrollbar-color: #cbd5e1 transparent;
        }
        .scroll-container::-webkit-scrollbar { height: 6px; }
        .scroll-container::-webkit-scrollbar-track { background: transparent; }
        .scroll-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        /* Pizarra */
        .request-board-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; margin-bottom: 0.75rem; }
        .vote-btn { background-color: #f1f5f9; color: #64748b; padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; transition: all 0.2s ease; display: flex; align-items: center; gap: 0.25rem; }
        .vote-btn:hover { background-color: #e2e8f0; }
        .vote-btn.voted { background-color: #dbeafe; color: #2563eb; border: 1px solid #93c5fd; }
        .request-text { font-size: 0.875rem; color: #334155; word-wrap: break-word; flex-grow: 1; margin-right: 1rem; line-height: 1.5; }
        .request-text strong { font-weight: 600; color: #1e293b; }
        .request-text span { font-size: 0.75rem; color: #64748b; display: block; margin-top: 0.25rem; }
    </style>

    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body class="text-slate-800 flex flex-col min-h-screen">

    <div id="mobile-ad-top">
      <div id="adsterra-mobile">
        <script type="text/javascript">
            atOptions = { 'key' : '8bc9527f0527b1ea5f2e3fc1efd1083d', 'format' : 'iframe', 'height' : 50, 'width' : 320, 'params' : {} };
        </script>
        <script type="text/javascript" src="//honeywhyvowel.com/8bc9527f0527b1ea5f2e3fc1efd1083d/invoke.js"></script>
      </div>
    </div>
    
    <div id="app" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
        
        <!-- BARRA DE NOTICIAS AUTOM√ÅTICA -->
        <div class="ticker-wrap mb-4 rounded-lg shadow-md border-b-4 border-blue-500">
            <div class="ticker" id="news-ticker-content">
                <span class="ticker-item">Conectando con el servidor...</span>
            </div>
        </div>

        <header class="mb-6">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-6 pb-4 border-b border-slate-200">
                <div class="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
                    <div class="flex items-center gap-4">
                        <div class="logo">D</div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-slate-900">Descargar Ultima Version</h1>
                    </div>
                    <!-- ===== BOT√ìN 'C√ìMO DESCARGAR' (ROJO GIGANTE) ===== -->
                    <button id="how-to-download-btn" class="flex items-center gap-4 text-white font-bold mt-2 sm:mt-0 px-6 py-4 bg-red-600 rounded-full transition-colors hover:bg-red-700 animate-pulse shadow-lg border-4 border-red-500 sm:text-lg">
                        <!-- √çCONO PLAY GIGANTE -->
                        <svg style="width: 48px; height: 48px;" class="h-12 w-12 sm:h-16 sm:w-16 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                        <span>¬øC√≥mo descargar nuestros archivos? <br class="sm:hidden"><span class="text-sm sm:text-base font-normal opacity-90">(Ver video gu√≠a)</span></span>
                    </button>
                </div>
                <div class="relative w-full sm:max-w-md">
                    <button id="open-ai-chat-btn" class="w-full flex items-center justify-center gap-3 px-4 py-2.5 border border-transparent rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold shadow-lg hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-blue-400 transition-all duration-300 ease-out transform hover:scale-105 text-sm border-2 border-blue-100">
                        <svg style="width: 28px; height: 28px; stroke-width: 2.5;" class="h-7 w-7 flex-shrink-0 text-blue-200 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        Busca tu software o APK aqu√≠
                    </button>
                </div>
            </div>
        </header>
        
        <div class="mt-4 mb-6 bg-white/60 dark:bg-slate-800/60 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700">
          <p class="text-slate-800 dark:text-slate-100 text-base leading-relaxed text-center">
            üëã <strong>Bienvenido a Descargar √öltima Versi√≥n</strong><br>
            Aqu√≠ reunimos las <strong>apps y juegos que realmente funcionan</strong>. 
            Cada archivo ha sido <strong>probado, verificado y elegido a mano</strong> para ahorrarte tiempo, frustraciones y enlaces rotos. 
            Solo publicamos lo que <strong>pasa por nuestros filtros de seguridad y rendimiento</strong>, as√≠ puedes descargar con total confianza. üöÄ
          </p>
        </div>

        <!-- Men√∫ de Navegaci√≥n -->
        <nav id="nav-container" class="mb-8 p-4 bg-white rounded-xl shadow-sm border border-slate-200 sticky top-4 z-50">
            <p class="text-slate-500 text-sm text-center">Cargando categor√≠as...</p>
        </nav>
        
        <!-- SECCI√ìN 'LO M√ÅS DESCARGADO' (TOP 14 CARRUSEL) -->
        <div id="top-downloads-container" class="mb-8 p-6 bg-white rounded-xl shadow-sm border border-slate-200">
            <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-4">
                <h2 class="text-2xl font-bold text-slate-900 flex-shrink-0 flex items-center gap-2">
                    <svg class="h-6 w-6 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.2 3.31a.75.75 0 00-1.4 0l-1.11 4.331a.75.75 0 01-.692.518l-4.502.39a.75.75 0 00-.434 1.336l3.41 2.812a.75.75 0 01.248.746l-1.03 4.41a.75.75 0 001.12.825l3.854-2.26a.75.75 0 01.762 0l3.854 2.26a.75.75 0 001.12-.825l-1.03-4.41a.75.75 0 01.248-.746l3.41-2.812a.75.75 0 00-.434-1.336l-4.502-.39a.75.75 0 01-.692-.518L11.2 3.31z" clip-rule="evenodd"></path></svg>
                    üî• Lo M√°s Descargado
                </h2>
                <!-- Banner PC -->
                <div id="pc-ad-top-downloads">
                 <script type="text/javascript">
                    atOptions = { 'key' : 'a09ade7f1de75ea02cb1d7597a7a2ae6', 'format' : 'iframe', 'height' : 90, 'width' : 728, 'params' : {} };
                </script>
                <script type="text/javascript" src="//honeywhyvowel.com/a09ade7f1de75ea02cb1d7597a7a2ae6/invoke.js"></script>
                </div>
            </div>
            
            <!-- Carrusel Horizontal -->
            <div id="top-downloads-list" class="flex overflow-x-auto pb-4 gap-4 snap-x snap-mandatory scroll-container">
                <p class="text-slate-500 text-sm w-full text-center py-4">Cargando ranking...</p>
            </div>
        </div>
        
        <div class="mb-6 sm:mb-8">
            <div class="flex flex-wrap border-b border-slate-300 bg-white rounded-t-xl overflow-hidden shadow-sm">
              <button id="tab-pc" class="tab-button flex-1 text-blue-700 bg-blue-100 border-b-4 border-blue-600 font-semibold py-3">üñ•Ô∏è Descargas para PC</button>
              <button id="tab-mobile" class="tab-button flex-1 text-slate-500 bg-slate-100 border-b-4 border-transparent font-semibold py-3">üì± Descargas para M√≥vil</button>
            </div>
        </div>

        <main class="w-full">
            <div id="content-pc" class="tab-content">
                <h2 class="text-2xl sm:text-3xl font-bold text-blue-700 mb-6">Descargas para PC</h2>
                <div id="content-grid-pc" class="card-container"><p class="text-slate-500 text-sm">Cargando software...</p></div>
                <div id="no-results-pc" class="hidden text-center py-16"><h2 class="text-2xl font-semibold text-slate-700">No se encontraron resultados</h2></div>
            </div>
            <div id="content-mobile" class="tab-content hidden">
                <h2 class="text-2xl sm:text-3xl font-bold text-green-700 mb-6">Descargas para M√≥vil</h2>
                <div id="content-grid-mobile" class="card-container"><p class="text-slate-500 text-sm">Cargando software...</p></div>
                <div id="no-results-mobile" class="hidden text-center py-16"><h2 class="text-2xl font-semibold text-slate-700">No se encontraron resultados</h2></div>
            </div>
        </main>
    </div>

    <!-- ===== MODALES ===== -->
    <div id="how-to-download-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="how-to-download-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-xl font-bold text-slate-900 mb-2">¬°Importante antes de descargar!</h2>
            <p class="text-slate-700">Yo te brindo gratis la descarga, pero colab√≥rame con unos clics.</p>
            <div class="modal-video-container">
                <iframe id="video-iframe" src="" frameborder="0" allowfullscreen></iframe>
            </div>
        </div>
    </div>
    
    <div id="yape-modal" class="modal-overlay">
        <div class="yape-modal-content">
            <button id="yape-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-xl font-bold text-slate-900 mb-4">Donar con Yape</h2>
            <img src="imagenes/yape.jpeg" alt="C√≥digo QR de Yape" class="w-48 h-48 mx-auto rounded-lg border border-slate-200 mb-6" style="max-width: 200px; display: block;" onerror="this.style.display='none'">
            <button id="open-yape-btn" class="w-full bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-purple-700 transition-colors">Abrir Yape (solo m√≥vil)</button>
        </div>
    </div>
    
    <div id="comments-modal" class="modal-overlay">
        <div class="comments-modal-content">
            <button id="comments-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="text-xl font-bold text-slate-900 mb-4" id="comments-modal-title">Comentarios</h2>
            <div id="comments-list" class="flex-grow"><p class="text-slate-500 text-sm">Cargando comentarios...</p></div>
            <div class="mt-4 pt-4 border-t border-slate-200">
                <textarea id="comment-input" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Escribe tu comentario..."></textarea>
                <button id="submit-comment-btn" class="mt-3 w-full bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-blue-700 transition-colors">Enviar Comentario</button>
            </div>
        </div>
    </div>
    
    <div id="download-guide-modal" class="modal-overlay">
        <div class="modal-content max-w-lg">
            <button id="download-guide-modal-close" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            <h2 class="ml-4 text-xl sm:text-2xl font-bold text-slate-900">GU√çA R√ÅPIDA (M√ìVIL)</h2>
            <p class="text-slate-700 text-base mb-5">Sigue los pasos en el video de arriba para poder saltar la publicidad.</p>
            <button id="download-guide-continue-btn" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors text-lg">¬°Entendido!</button>
        </div>
    </div>

    <!-- Modal Chat IA CON ANUNCIO ESPOSA -->
    <div id="ai-chat-modal" class="modal-overlay">
        <div id="ai-chat-content" class="bg-white rounded-xl shadow-2xl overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-slate-200 bg-slate-50">
                <div><h2 id="ai-chat-greeting" class="text-lg font-bold text-slate-900">¬°Hola! üëã</h2></div>
                <!-- Bot√≥n Parlante -->
                <button id="ai-speaker-toggle" class="p-2 rounded-full text-slate-600 hover:bg-slate-200 transition-colors">
                     <svg id="speaker-on" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M10 21v-7m0 0V3m0 0a2 2 0 100 4v0m0-4a2 2 0 010 4v0m7.536-1.464a9 9 0 010 12.728M10 3H7a2 2 0 00-2 2v14a2 2 0 002 2h3m0-18v18"></path></svg>
                     <svg id="speaker-off" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15.1l-2.829 2.829a1 1 0 01-1.414-1.414L15.9 2.8A1 1 0 0117.3 4.2l-2.8 2.8m0 0a5 5 0 01-7.072 0M10 21v-7m0 0V3m0 0a2 2 0 100 4v0m0-4a2 2 0 010 4v0m7.536-1.464a9 9 0 010 12.728M10 3H7a2 2 0 00-2 2v14a2 2 0 002 2h3m0-18v18"></path></svg>
                </button>
                <button id="ai-chat-modal-close" class="text-slate-500 hover:text-slate-800"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            
            <!-- PUBLICIDAD ESPOSA (DEFAULT = THALIA CAKES) -->
            <!-- Usamos ./ para asegurar la ruta relativa -->
            <div id="ai-chat-ad-container" class="bg-pink-50 border-b border-pink-200 p-3 flex items-center gap-3 cake-ad-anim shadow-sm">
                 <div class="flex-shrink-0 bg-white p-1 rounded-full shadow border border-pink-100">
                     <!-- IMAGEN DEL LOGO -->
                     <img src="./imagenes/thaliacakes.png" class="w-12 h-12 rounded-full object-cover shadow-sm border border-pink-200" alt="Thalia Cakes" onerror="this.src='https://placehold.co/100x100/pink/white?text=TC'">
                 </div>
                 <div class="flex-grow text-left">
                     <h3 class="font-bold text-pink-600 text-sm leading-tight">Thalia Cakes üéÇ</h3>
                     <p class="text-xs text-slate-600">¬°Dulzura hecha con amor para ti!</p>
                 </div>
                 <a href="https://www.facebook.com/share/1GY4SEQJTx/" target="_blank" class="bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white text-xs font-bold py-1.5 px-3 rounded-full transition shadow-sm transform hover:scale-105">Ver m√°s</a>
            </div>

            <div id="ai-chat-messages" class="flex-grow flex flex-col p-4 space-y-2 overflow-y-auto bg-white">
                <div class="ai-chat-bubble ai">Hola, soy la Inteligencia Artificial de Descargar Ultima Version, y me llamo DUV, te ayudare a buscar tu sofware o apk de forma mas rapida. y si gustas tambien te guio en la descarga. escribe que estas buscando</div>
            </div>
            <div class="p-4 border-t border-slate-200 bg-slate-50">
                <div id="ai-chat-error" class="hidden text-sm text-red-600 bg-red-100 p-3 rounded-lg mb-3"></div>
                <form id="ai-chat-form" class="flex items-center gap-3">
                    <input type="text" id="ai-chat-input" placeholder="Escribe..." class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" autocomplete="off">
                    <button type="button" id="ai-chat-mic" class="p-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                         <svg id="mic-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                         <svg id="mic-listening" class="h-6 w-6 text-red-500 hidden animate-pulse" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"></circle></svg>
                    </button>
                    <button type="submit" id="ai-chat-submit" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <footer class="bg-slate-100 border-t border-slate-200 w-full">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 text-center">
            <h2 class="text-2xl font-bold text-slate-900">Un Proyecto Hecho para Ti</h2>
            <div class="max-w-3xl mx-auto mt-6 mb-6 bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-xl border border-yellow-200 shadow-sm">
                <h3 class="text-xl font-extrabold text-orange-600 mb-2">üö´‚è≥ ¬øOdias la publicidad y esperar?</h3>
                <p class="text-slate-700 text-lg leading-relaxed">
                    Haz una <strong>donaci√≥n voluntaria</strong> (lo que te nazca ‚ù§Ô∏è) y te daremos 
                    <strong>ACCESO VIP DIRECTO</strong> a la descarga que quieras. 
                    <br>
                    ¬°Sin esperas, sin acortadores, directo a tu PC o M√≥vil! ‚ö°
                </p>
                <p class="text-sm text-slate-500 mt-3 font-medium">
                    üëá Solo dona y manda la captura a nuestro WhatsApp aqu√≠ abajo para recibir tu enlace.
                </p>
            </div>

            <div class="mt-8 flex flex-wrap justify-center items-center gap-4">
                <button id="yape-modal-open" class="bg-purple-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-purple-700 flex items-center gap-2">Yape</button>
                <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&business=lahsvergon_23%40hotmail.com&item_name=Apoyo+para+el+sitio+web+de+descargas&currency_code=USD" target="_blank" class="bg-blue-600 text-white font-semibold py-2.5 px-5 rounded-full hover:bg-blue-700 flex items-center gap-2">PayPal</a>
            </div>
            <div class="mt-6">
                <a href="https://wa.me/51924814457" target="_blank" class="inline-flex items-center gap-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-full">WhatsApp</a>
            </div>
            <div class="mt-10 pt-8 border-t border-slate-300 max-w-2xl mx-auto text-left">
                <h3 class="text-xl font-bold text-slate-900 text-center mb-6">Pizarra de Pedidos</h3>
                <div id="general-requests-list" class="mb-4 max-h-96 overflow-y-auto p-2 bg-white rounded-lg shadow-inner border border-slate-200">
                    <p class="text-slate-500 text-sm p-4 text-center">Cargando pedidos...</p>
                </div>
            </div>
            <div class="mt-10 pt-8 border-t border-slate-300 max-w-2xl mx-auto text-center">
                <button id="admin-login-btn" class="text-sm text-slate-500 hover:text-blue-600">Login (Admin)</button>
                <p id="admin-status" class="text-sm text-green-600 mt-2 hidden"></p>
            </div>
        </div>
    </footer>
    
    <!-- BANNER DEL FOOTER -->
    <div class="flex justify-center my-6">
      <div class="rounded-xl overflow-hidden shadow-sm border border-slate-200 bg-white/80 p-2" style="display: inline-block !important;">
        <script type="text/javascript">
            atOptions = { 'key' : '982a5d0f66cf17a976727779b97a1183', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };
        </script>
        <script type="text/javascript" src="//honeywhyvowel.com/982a5d0f66cf17a976727779b97a1183/invoke.js"></script>  
      </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, limit, addDoc, serverTimestamp, runTransaction, increment, updateDoc, getDocs, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI√ìN H√çBRIDA ---
        const envConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const envAppId = typeof __app_id !== 'undefined' ? __app_id : null;

        const userConfig = {
          apiKey: "AIzaSyCPB82qY7h3YGvk_cClAw5so0DFgiePzNM",
          authDomain: "descargar-ultima-version.firebaseapp.com",
          projectId: "descargar-ultima-version",
          storageBucket: "descargar-ultima-version.firebasestorage.app",
          messagingSenderId: "1028999431387",
          appId: "1:1028999431387:web:3f6799e9adfca72d3078fe",
          measurementId: "G-BZRK62Y3S5"
        };

        const firebaseConfig = envConfig || userConfig;
        const appId = envAppId || "descargar-ultima-version"; 
        const ADMIN_ID = "GL22tXZLqzcCRpfvNxAoO3sbFt03";

        // --- ESTADO GLOBAL ---
        let app, db, auth;
        let allSoftware = [];
        let activeTab = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? 'mobile' : 'pc';
        let currentCategory = 'home';
        let currentSearchTerm = '';
        let userLikes = JSON.parse(localStorage.getItem('userLikes') || '{}');
        let userVotes = JSON.parse(localStorage.getItem('userVotes') || '{}');
        let recognition = null;
        let radarInterval = null;
        let configUnsubscribe = null;
        let softwareUnsubscribe = null;
        let requestsUnsubscribe = null;
        let currentItemId = null;
        let currentDownloadLink = null;
        window.commentsUnsubscribe = null;
        window.generalRequestsUnsubscribe = null;

        // UI
        const tabPc = document.getElementById('tab-pc');
        const tabMobile = document.getElementById('tab-mobile');
        const contentPc = document.getElementById('content-pc');
        const contentMobile = document.getElementById('content-mobile');
        const navContainer = document.getElementById('nav-container');
        
        // IA Config
        let dynamicSystemPrompt = "Eres DUV, un asistente √∫til.";
        let isSpeechEnabled = true;

        // --- INICIALIZACI√ìN VISUAL ---
        if (activeTab === 'mobile') {
            setTabActive(tabMobile, tabPc);
            contentPc.classList.add('hidden');
            contentMobile.classList.remove('hidden');
            if(navContainer) navContainer.classList.add('hidden');
        } else {
            setTabActive(tabPc, tabMobile);
            contentMobile.classList.add('hidden');
            contentPc.classList.remove('hidden');
            if(navContainer) navContainer.classList.remove('hidden');
        }

        function setTabActive(activeBtn, inactiveBtn) {
            if (activeBtn) {
                activeBtn.classList.add('active-tab', 'text-blue-700', 'bg-blue-100', 'border-blue-600');
                activeBtn.classList.remove('text-slate-500', 'bg-slate-100', 'border-transparent');
            }
            if (inactiveBtn) {
                inactiveBtn.classList.remove('active-tab', 'text-blue-700', 'bg-blue-100', 'border-blue-600');
                inactiveBtn.classList.add('text-slate-500', 'bg-slate-100', 'border-transparent');
            }
        }

        // --- EVENT LISTENERS CENTRALIZADOS ---
        if(tabPc) tabPc.addEventListener('click', () => {
            activeTab = 'pc';
            currentCategory = 'home';
            setTabActive(tabPc, tabMobile);
            contentMobile.classList.add('hidden');
            contentPc.classList.remove('hidden');
            if(navContainer) navContainer.classList.remove('hidden');
            updateView();
        });
        if(tabMobile) tabMobile.addEventListener('click', () => {
            activeTab = 'mobile';
            setTabActive(tabMobile, tabPc);
            contentPc.classList.add('hidden');
            contentMobile.classList.remove('hidden');
            if(navContainer) navContainer.classList.add('hidden');
            updateView();
        });

        // Manejo de Video en Modal (AUTOM√ÅTICO Y BLINDADO)
        const modalMap = { 'how-to-download-btn': 'how-to-download-modal', 'yape-modal-open': 'yape-modal', 'open-ai-chat-btn': 'ai-chat-modal' };
        Object.keys(modalMap).forEach(id => { 
            const btn = document.getElementById(id); 
            if(btn) btn.addEventListener('click', () => {
                openModal(modalMap[id]);
                // L√ìGICA DE VIDEO
                if(id === 'how-to-download-btn') {
                    const iframe = document.querySelector('#how-to-download-modal iframe');
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    // Video Celular vs Video PC
                    const videoId = isMobile ? "90ZzYKrxS6U" : "Zs-1k7F0_vE";
                    if(iframe) iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&showinfo=0&rel=0`;
                }
            }); 
        });

        ['how-to-download-modal', 'yape-modal', 'comments-modal', 'download-guide-modal', 'ai-chat-modal'].forEach(id => {
            const m = document.getElementById(id); const c = document.getElementById(id+'-close');
            if(c) c.addEventListener('click', () => closeModal(id));
            if(m) m.addEventListener('click', (e) => { if(e.target === m) closeModal(id); });
        });
        
        // Detener video al cerrar
        function closeModal(id) {
            const el = document.getElementById(id);
            if(el) el.classList.remove('open');
            if(id === 'how-to-download-modal') {
                const iframe = document.querySelector('#how-to-download-modal iframe');
                if(iframe) iframe.src = ""; // Stop video
            }
            if(id === 'comments-modal' && window.commentsUnsubscribe) { window.commentsUnsubscribe(); window.commentsUnsubscribe = null; }
            if(id === 'ai-chat-modal') window.speechSynthesis.cancel();
        }

        const guideBtn = document.getElementById('download-guide-continue-btn');
        if(guideBtn) guideBtn.addEventListener('click', () => {
            closeModal('download-guide-modal');
            if(currentDownloadLink) { window.open(currentDownloadLink, '_blank'); currentDownloadLink = null; }
        });

        const openYapeBtn = document.getElementById('open-yape-btn');
        if(openYapeBtn) openYapeBtn.addEventListener('click', () => { window.location.href = "yape://"; });

        const adminBtn = document.getElementById('admin-login-btn');
        if(adminBtn) adminBtn.addEventListener('click', async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e) { console.error(e); }
        });

        if(navContainer) navContainer.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if(link) { e.preventDefault(); currentCategory = link.dataset.category; updateView(); }
        });

        const chatMessages = document.getElementById('ai-chat-messages');
        if(chatMessages) chatMessages.addEventListener('click', (e) => {
            if(e.target.classList.contains('chat-link')) {
                e.preventDefault(); closeModal('ai-chat-modal'); handleTopDownloadClick(null, e.target.dataset.cardId);
            }
        });

        // --- L√ìGICA CORE ---
        function openModal(id) {
            const el = document.getElementById(id);
            if(el) el.classList.add('open');
            if(id === 'ai-chat-modal') {
                const input = document.getElementById('ai-chat-input');
                if(input) setTimeout(() => input.focus(), 100);
            }
        }

        // --- CARDS RENDER ---
        function renderCards(items, container, noResults) {
            container.innerHTML = '';
            if (items.length === 0) { noResults.classList.remove('hidden'); container.classList.add('hidden'); return; }
            noResults.classList.add('hidden'); container.classList.remove('hidden');
            const sorted = items.sort((a, b) => {
                const da = a.createdAt ? a.createdAt.toDate() : new Date(0);
                const db = b.createdAt ? b.createdAt.toDate() : new Date(0);
                return db - da;
            });
            sorted.forEach(item => {
                let placeholder = activeTab === 'mobile' ? '16a34a/ffffff' : 'e2e8f0/94a3b8';
                if(item.category && item.category.includes('adobe')) placeholder = '1e40af/ffffff';
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200 hover:shadow-lg transition-all duration-300 relative';
                card.id = `card-${item.id}`;
                let dateStr = "Reciente";
                if(item.createdAt && item.createdAt.toDate) dateStr = item.createdAt.toDate().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                
                // NUEVA L√ìGICA PARA DETALLES
                const installText = item.installation || "Descomprimir y ejecutar el setup. Si pide contrase√±a: <code>taiwebs.com</code>";
                const updateText = item.updates || "Versi√≥n optimizada y verificada.";

                card.innerHTML = `
                    <img src="${item.imageUrl || `https://placehold.co/600x400/${placeholder}`}" alt="${item.title}" style="width: 100%; height: 192px; object-fit: cover;" onerror="this.src='https://placehold.co/600x400/${placeholder}?text=Error'">
                    <div class="p-5">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-slate-500">${dateStr}</span>
                            <span class="inline-flex items-center gap-1 text-xs text-blue-600 font-medium bg-blue-50 px-2 py-0.5 rounded-full download-counter">
                                <svg style="width:12px;height:12px;" fill="currentColor" viewBox="0 0 20 20"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.23a.75.75 0 00-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.905 3.084V2.75z"></path></svg>
                                ${item.downloads || 0}
                            </span>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2 leading-tight line-clamp-2" title="${item.title}">${item.title}</h3>
                        <p class="text-slate-600 text-sm mb-4 h-16 overflow-hidden leading-relaxed line-clamp-3">${item.description || ''}</p>
                        <details class="group mb-4 text-sm">
                            <summary class="list-none cursor-pointer text-blue-600 font-semibold hover:text-blue-800 transition-colors flex items-center gap-1"><span>‚ÑπÔ∏è Ver detalles e instalaci√≥n</span></summary>
                            <div class="mt-2 p-3 bg-slate-50 rounded-lg border border-slate-100 text-slate-700">
                                <p><strong>Instalaci√≥n:</strong> ${installText}</p>
                                <p class="mt-1"><strong>Novedades:</strong> ${updateText}</p>
                            </div>
                        </details>
                        <div class="flex flex-col gap-3">
                            <button class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors download-btn-action" data-id="${item.id}" data-link="${item.downloadLink}">DESCARGAR</button>
                            ${item.platform === 'pc' ? '<div class="text-center text-xs text-slate-400 font-mono">Pass: taiwebs.com</div>' : ''}
                            <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                                <button class="flex items-center gap-2 text-slate-500 hover:text-red-500 transition-colors like-btn-action ${userLikes[item.id] ? 'text-red-500' : ''}" data-id="${item.id}">
                                    <svg style="width:20px;height:20px;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                                    <span class="text-sm font-medium likes-count-display">${item.likes || 0}</span>
                                </button>
                                <div class="flex gap-2">
                                    <button class="p-2 text-slate-400 hover:text-blue-500 transition-colors comment-btn-action" data-id="${item.id}"><svg style="width:20px;height:20px;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg></button>
                                    <button class="p-2 text-slate-400 hover:text-green-500 transition-colors share-btn-action" data-id="${item.id}"><svg style="width:20px;height:20px;" fill="currentColor" viewBox="0 0 20 20"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"></path></svg></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
            
            // PROTECCI√ìN PARA EVENTOS DE BOTONES DIN√ÅMICOS
            container.querySelectorAll('.download-btn-action').forEach(b => {
                if (b) b.addEventListener('click', handleDownloadAction);
            });
            container.querySelectorAll('.like-btn-action').forEach(b => {
                if (b) b.addEventListener('click', handleLikeAction);
            });
            container.querySelectorAll('.comment-btn-action').forEach(b => {
                if (b) b.addEventListener('click', handleCommentAction);
            });
            container.querySelectorAll('.share-btn-action').forEach(b => {
                if (b) b.addEventListener('click', handleShareAction);
            });
        }

        function updateView() {
            if (!allSoftware.length) return;
            let filtered = allSoftware.filter(i => i.platform === (activeTab === 'pc' ? 'pc' : 'mobile'));
            if (currentCategory !== 'home' && activeTab === 'pc') filtered = filtered.filter(i => i.category === currentCategory);
            if (currentSearchTerm) filtered = filtered.filter(i => i.title.toLowerCase().includes(currentSearchTerm.toLowerCase()));
            const container = activeTab === 'pc' ? document.getElementById('content-grid-pc') : document.getElementById('content-grid-mobile');
            const noRes = activeTab === 'pc' ? document.getElementById('no-results-pc') : document.getElementById('no-results-mobile');
            renderCards(filtered, container, noRes);
        }

        // --- ACTIONS ---
        async function handleDownloadAction(e) {
            e.preventDefault();
            const id = e.currentTarget.dataset.id;
            const link = e.currentTarget.dataset.link;
            if (!link || link === '#' || link === 'undefined') { alert("Enlace no disponible."); return; }
            currentDownloadLink = link;
            const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, id);
            updateDoc(itemRef, { downloads: increment(1) }).catch(console.error);
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) openModal('download-guide-modal');
            else window.open(link, '_blank');
        }

        async function handleLikeAction(e) {
            e.preventDefault();
            const btn = e.currentTarget;
            const id = btn.dataset.id;
            if (!auth.currentUser) await signInAnonymously(auth);
            const itemRef = doc(db, `artifacts/${appId}/public/data/software-items`, id);
            const isLiked = !!userLikes[id];
            const span = btn.querySelector('.likes-count-display');
            let current = parseInt(span.textContent) || 0;
            if (isLiked) {
                userLikes[id] = false; btn.classList.remove('text-red-500');
                span.textContent = Math.max(0, current - 1);
                await updateDoc(itemRef, { likes: increment(-1) });
            } else {
                userLikes[id] = true; btn.classList.add('text-red-500');
                span.textContent = current + 1;
                await updateDoc(itemRef, { likes: increment(1) });
            }
            localStorage.setItem('userLikes', JSON.stringify(userLikes));
        }

        function handleCommentAction(e) {
            e.preventDefault();
            const id = e.currentTarget.dataset.id;
            currentItemId = id; 
            const item = allSoftware.find(i => i.id === id);
            document.getElementById('comments-modal-title').textContent = `Comentarios: ${item ? item.title : ''}`;
            openModal('comments-modal');
            loadComments(id);
        }

        function handleShareAction(e) {
            e.preventDefault();
            const id = e.currentTarget.dataset.id;
            const url = `${window.location.origin}${window.location.pathname}?item=${id}`;
            if (navigator.share) navigator.share({ title: 'Descargar', url: url });
            else navigator.clipboard.writeText(url).then(() => alert("Copiado!"));
        }
        
        // SE MOVI√ì AQU√ç LA DEFINICI√ìN (Fuera de otras funciones)
        function handleTopDownloadClick(e, cardId) {
             if (e) e.preventDefault();
            const itemId = cardId || (e ? e.currentTarget.dataset.itemId : null);
            if (!itemId) return;
            let item = allSoftware.find(i => i.id === itemId);
            if (!item) return;
            let itemTab = item.platform || 'pc'; 
            if (activeTab !== itemTab) {
                const tabToClick = (itemTab === 'pc') ? document.getElementById('tab-pc') : document.getElementById('tab-mobile');
                if (tabToClick) tabToClick.click();
            }
            setTimeout(() => {
                const cardElement = document.getElementById(`card-${item.id}`);
                if (cardElement) {
                    cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    cardElement.classList.add('card-highlight');
                    setTimeout(() => { cardElement.classList.remove('card-highlight'); }, 1500);
                }
            }, 100);
        }

        function loadComments(id) {
            const list = document.getElementById('comments-list');
            list.innerHTML = '<p class="text-center text-gray-500">Cargando...</p>';
            if (window.commentsUnsubscribe) window.commentsUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/public/data/comments`, id, 'messages'), orderBy('timestamp', 'desc'));
            window.commentsUnsubscribe = onSnapshot(q, (snapshot) => {
                list.innerHTML = '';
                if (snapshot.empty) { list.innerHTML = '<p class="text-center text-gray-400 py-4">S√© el primero en comentar.</p>'; return; }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = `comment ${data.uid === ADMIN_ID ? 'admin-comment' : ''}`;
                    div.innerHTML = `<div class="flex justify-between text-xs text-gray-400 mb-1"><span>${data.displayName || 'An√≥nimo'}</span><span>${data.timestamp?.toDate().toLocaleDateString() || ''}</span></div><p>${data.text}</p>`;
                    list.appendChild(div);
                });
            });
        }

        // PROTECCI√ìN: Bot√≥n de comentario
        const submitCommentBtn = document.getElementById('submit-comment-btn');
        if (submitCommentBtn) {
            submitCommentBtn.addEventListener('click', async () => {
                const input = document.getElementById('comment-input');
                const text = input.value.trim();
                if(!text || !currentItemId) return;
                const user = auth.currentUser || (await signInAnonymously(auth)).user;
                await addDoc(collection(db, `artifacts/${appId}/public/data/comments`, currentItemId, 'messages'), {
                    text: text, uid: user.uid, displayName: user.uid === ADMIN_ID ? 'Admin' : 'Usuario', timestamp: serverTimestamp()
                });
                input.value = '';
            });
        }

        // --- CHAT IA (AUDIO & VOZ) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'es-ES';
            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                document.getElementById('ai-chat-input').value = text;
                document.getElementById('mic-listening').classList.add('hidden');
                document.getElementById('mic-icon').classList.remove('hidden');
            };
            recognition.onend = () => {
                document.getElementById('mic-listening').classList.add('hidden');
                document.getElementById('mic-icon').classList.remove('hidden');
            };
        } else {
            const micBtn = document.getElementById('ai-chat-mic');
            if(micBtn) micBtn.style.display = 'none';
        }

        const micBtn = document.getElementById('ai-chat-mic');
        if(micBtn) micBtn.addEventListener('click', () => {
            if (!recognition) { alert("Tu navegador no soporta voz."); return; }
            try { recognition.start(); document.getElementById('mic-icon').classList.add('hidden'); document.getElementById('mic-listening').classList.remove('hidden'); } catch (e) { console.error(e); }
        });

        // PROTECCI√ìN: Bot√≥n de parlante
        const speakerToggle = document.getElementById('ai-speaker-toggle');
        if(speakerToggle) {
            speakerToggle.addEventListener('click', () => {
                isSpeechEnabled = !isSpeechEnabled;
                document.getElementById('speaker-on').classList.toggle('hidden');
                document.getElementById('speaker-off').classList.toggle('hidden');
                if(!isSpeechEnabled) window.speechSynthesis.cancel();
            });
        }

        function speak(text) {
            if(!isSpeechEnabled) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            window.speechSynthesis.speak(utterance);
        }

        // PROTECCI√ìN: Formulario de chat
        const aiChatForm = document.getElementById('ai-chat-form');
        if(aiChatForm) {
            aiChatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('ai-chat-input');
                const text = input.value.trim();
                if(!text) return;
                const msgs = document.getElementById('ai-chat-messages');
                msgs.innerHTML += `<div class="ai-chat-bubble user">${text}</div>`;
                input.value = '';
                msgs.scrollTop = msgs.scrollHeight;
                
                const inventoryList = allSoftware.map(s => `- ID: ${s.id} | NOMBRE: ${s.title}`).join('\n');
                const user = auth.currentUser;
                const userName = user && !user.isAnonymous ? (user.displayName || 'Amigo') : 'Amigo';
                const finalPrompt = `
                    ACT√öA COMO: DUV (Inteligencia Artificial de Descargar Ultima Version), un experto amigable.
                    TONO: Natural, breve, jovial. Nunca hables como robot.
                    NOMBRE DEL USUARIO: ${userName}
                    
                    TU CONOCIMIENTO (INVENTARIO REAL):
                    ${inventoryList}

                    TU CONOCIMIENTO EXTRA (NEGOCIO FAMILIAR):
                    - Si preguntan por "Thalia Cakes" o "tortas", responde con mucho entusiasmo.
                    - Diles que es la mejor pasteler√≠a, propiedad de la talentosa Thalia Alday.
                    - Hacen tortas para bodas, cumplea√±os, bocaditos y dise√±os personalizados.
                    - Inv√≠talos a hacer clic en el bot√≥n "Ver m√°s" que aparece arriba en el chat.

                    REGLAS:
                    1. SI EL USUARIO SALUDA: Responde corto y amable usando su nombre si lo tienes. NO listes el software.
                    2. SI PIDEN ALGO QUE TIENES: Responde "¬°Lo tengo!" y usa el formato [LINK:ID_DEL_SOFTWARE].
                    3. SI PIDEN ALGO QUE NO TIENES:
                       - Primero VERIFICA en tu conocimiento general si ese software realmente existe.
                       - Si existe pero no lo tenemos: "No lo tengo, pero lo anoto en la pizarra" y usa [ADD_TO_BOARD:NombreDelSoftware].
                       - Si NO existe o es un nombre inventado/raro: Di que no lo conoces y pregunta si escribieron bien el nombre.
                    4. SI PREGUNTAN C√ìMO DESCARGAR: Explica que deben saltar la publicidad de exe.io. 
                       - PC: Cerrar pesta√±as nuevas hasta ver el captcha.
                       - M√ìVIL: Advertir sobre bloqueo de popups y decir que vean el video amarillo.
                    5. IMPORTANTE: Jam√°s inventes enlaces. Usa solo los IDs del inventario.
                `;
                const apiKey = "AIzaSyC2eih2fC7lR3VA9Uv1zOWbxy7egX9UMCw"; 
                try {
                     const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{parts: [{text: text}]}], systemInstruction: { parts: [{ text: finalPrompt }] } })
                    });
                    const data = await response.json();
                    let reply = data.candidates[0].content.parts[0].text;
                    reply = reply.replace(/\[LINK:([^\]]+)\]/g, (match, cardId) => {
                        const item = allSoftware.find(i => i.id === cardId);
                        return ` <a href="#" class="chat-link font-bold text-blue-600 underline" data-card-id="${cardId}">${item ? item.title : 'ver'}</a>`;
                    });
                    reply = reply.replace(/\[ADD_TO_BOARD:([^\]]+)\]/g, (match, name) => {
                        addSoftwareRequest(name); return ` <em>(A√±adido a pizarra: ${name})</em>`;
                    });
                    msgs.innerHTML += `<div class="ai-chat-bubble ai">${reply}</div>`;
                    speak(reply.replace(/<[^>]+>/g, ''));
                    document.querySelectorAll('.chat-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault(); handleTopDownloadClick(null, e.currentTarget.dataset.cardId); closeModal('ai-chat-modal');
                        });
                    });
                } catch(err) { msgs.innerHTML += `<div class="ai-chat-bubble ai">Error conexi√≥n.</div>`; }
                msgs.scrollTop = msgs.scrollHeight;
            });
        }

        // --- INIT & AUTH ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // --- AUTH SIMPLE DIRECTO ---
            const initAuth = async () => {
                try {
                    // Intentar primero con token si existe (para entornos preview)
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        throw new Error("No token");
                    }
                } catch (e) {
                    // Si falla CUALQUIER COSA, usar an√≥nimo (Red de Seguridad)
                    console.log("Usando acceso an√≥nimo de respaldo...");
                    await signInAnonymously(auth);
                }
            };
            initAuth();

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // TICKER
                    onSnapshot(query(collection(db, `artifacts/${appId}/public/data/software-items`), orderBy("createdAt", "desc"), limit(14)), (snapshot) => {
                        const ticker = document.getElementById('news-ticker-content');
                        if (ticker) {
                            let html = '';
                            const dateStr = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                            html += `<span class="ticker-item">üìÖ Hoy es ${dateStr} - ¬°Nuevas descargas!</span>`;
                            snapshot.forEach(doc => {
                                const item = doc.data();
                                let uploadDate = "Reciente";
                                if (item.createdAt && item.createdAt.toDate) uploadDate = item.createdAt.toDate().toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                                html += `<span class="ticker-item">üöÄ ¬°Actualizaci√≥n! El ${uploadDate} se a√±adi√≥: <span class="ticker-highlight">${item.title}</span></span>`;
                            });
                            ticker.innerHTML = html;
                        }
                    });

                    const radarRef = doc(db, `artifacts/${appId}/public/data/config`, "siteSettings");
                    if(!configUnsubscribe) {
                         configUnsubscribe = onSnapshot(radarRef, (s) => {
                            if (s.exists() && s.data().radarEnabled) {
                                if (!radarInterval) {
                                    radarInterval = setInterval(() => {
                                        setDoc(doc(db, `artifacts/${appId}/public/data/presence`, user.uid), { platform: activeTab, timestamp: serverTimestamp() });
                                    }, 60000);
                                }
                            } else {
                                if (radarInterval) { clearInterval(radarInterval); radarInterval = null; }
                            }
                            
                            const adContainer = document.getElementById('ai-chat-ad-container');
                            if (adContainer && s.exists()) {
                                const data = s.data();
                                if (data.aiChatAd && data.aiChatAd.trim() !== "") {
                                    adContainer.innerHTML = data.aiChatAd; adContainer.classList.remove('hidden');
                                } else {
                                    // Si no hay anuncio en DB, usar el de Thalia (ya en HTML), por lo que removemos hidden.
                                    adContainer.classList.remove('hidden'); 
                                }
                            } else {
                                // Si no existe config, mostramos Thalia por defecto
                                if(adContainer) adContainer.classList.remove('hidden');
                            }
                        });
                    }
                    
                    if(!softwareUnsubscribe) {
                         const q = collection(db, `artifacts/${appId}/public/data/software-items`);
                         softwareUnsubscribe = onSnapshot(q, (snapshot) => {
                            allSoftware = [];
                            const categoriesMap = new Map();
                            snapshot.forEach(doc => {
                                const data = doc.data();
                                allSoftware.push({ id: doc.id, ...data });
                                if (data.platform === 'pc' && data.category && !categoriesMap.has(data.category)) {
                                    categoriesMap.set(data.category, { id: data.category, name: data.category.charAt(0).toUpperCase() + data.category.slice(1).replace(/-/g, ' ') });
                                }
                            });
                            
                            const navContainer = document.getElementById('nav-container');
                            if (navContainer) {
                                let html = '<ul class="flex flex-wrap justify-center gap-4">';
                                html += `<li><button class="nav-link font-medium hover:text-blue-600 transition ${currentCategory==='home'?'text-blue-600':''}" data-category="home">Inicio</button></li>`;
                                Array.from(categoriesMap.values()).sort((a,b) => a.name.localeCompare(b.name)).forEach(cat => {
                                    html += `<li><button class="nav-link font-medium hover:text-blue-600 transition" data-category="${cat.id}">${cat.name}</button></li>`;
                                });
                                html += '</ul>';
                                navContainer.innerHTML = html;
                            }
                            
                            // LOAD TOP DOWNLOADS (CAROUSEL TOP 14)
                            loadTopDownloads();

                            updateView();
                        });
                    }
                    
                    if(!requestsUnsubscribe) {
                         loadGeneralRequests();
                    }

                    if (user.uid === ADMIN_ID) {
                        const status = document.getElementById('admin-status');
                        if(status) { status.textContent = "Modo Admin Activo"; status.classList.remove('hidden'); }
                    }
                }
            });

        } catch (e) { console.error("Error Firebase:", e); }

        
        async function addSoftwareRequest(softwareName) {
            if (!db) return;
            const user = auth.currentUser || (await signInAnonymously(auth)).user;
            const requestsCollection = collection(db, `artifacts/${appId}/public/data/general-requests`);
            const lowerCaseName = softwareName.toLowerCase().trim();
            const q = query(requestsCollection, where("lowerCaseName", "==", lowerCaseName));
            const existing = await getDocs(q);
            if (existing.empty) {
                try {
                    const newRequestRef = await addDoc(requestsCollection, {
                        text: softwareName, lowerCaseName: lowerCaseName, timestamp: serverTimestamp(),
                        uid: user.uid, displayName: (user.uid === ADMIN_ID) ? 'Admin' : (user.isAnonymous ? 'An√≥nimo' : (user.displayName || 'Usuario')), votes: 1 
                    });
                    userVotes[newRequestRef.id] = true;
                    localStorage.setItem('userVotes', JSON.stringify(userVotes));
                } catch (e) { console.error("Error add pedido:", e); }
            }
        }

        // --- NEW: FUNCTION TO LOAD TOP DOWNLOADS FOR CAROUSEL (TOP 14) ---
        function loadTopDownloads() {
            const topList = document.getElementById('top-downloads-list');
            if (!topList || allSoftware.length === 0) return;
            
            // Sort by downloads desc, take top 14
            const top = [...allSoftware].sort((a,b) => (b.downloads||0) - (a.downloads||0)).slice(0, 14);
            
            topList.innerHTML = '';
            top.forEach((item, idx) => {
                const el = document.createElement('div');
                // Styling for vertical card in carousel
                el.className = "min-w-[180px] w-[180px] sm:min-w-[200px] sm:w-[200px] bg-white p-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md cursor-pointer transition-all transform hover:-translate-y-1 snap-center flex flex-col relative";
                
                el.innerHTML = `
                    <div class="absolute top-2 left-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full z-10 shadow-sm">#${idx+1}</div>
                    <img src="${item.imageUrl}" class="w-full h-32 object-cover rounded-lg mb-2 bg-gray-100">
                    <h3 class="font-bold text-slate-800 text-sm leading-tight mb-1 line-clamp-2 h-10">${item.title}</h3>
                    <p class="text-xs text-blue-600 font-medium bg-blue-50 px-2 py-1 rounded-full mt-auto self-start">
                        üî• ${(item.downloads||0).toLocaleString()}
                    </p>
                `;
                
                el.addEventListener('click', (e) => {
                    handleTopDownloadClick(e, item.id);
                });
                topList.appendChild(el);
            });
        }

        function loadGeneralRequests() {
            const generalRequestsList = document.getElementById('general-requests-list');
            if (!generalRequestsList || !db) return; 
            generalRequestsList.innerHTML = '<p class="text-slate-500 text-sm p-4 text-center">Cargando pedidos...</p>';
            if (window.generalRequestsUnsubscribe) window.generalRequestsUnsubscribe();
            const q = query(collection(db, `artifacts/${appId}/public/data/general-requests`));
            window.generalRequestsUnsubscribe = onSnapshot(q, (snapshot) => {
                generalRequestsList.innerHTML = '';
                if (snapshot.empty) { generalRequestsList.innerHTML = '<p class="text-slate-500 text-sm p-4 text-center">A√∫n no hay pedidos. ¬°P√≠dele a la IA!</p>'; return; }
                const requests = [];
                snapshot.forEach(doc => { requests.push({ id: doc.id, ...doc.data() }); });
                requests.sort((a, b) => (b.votes || 0) - (a.votes || 0));
                requests.forEach(req => {
                    const voteClass = userVotes[req.id] ? 'vote-btn voted' : 'vote-btn';
                    const el = document.createElement('div');
                    el.className = 'request-board-item';
                    el.innerHTML = `
                        <div class="request-text">
                            <strong>${req.text}</strong>
                            <span>Pedido por: ${req.displayName || 'An√≥nimo'}</span>
                        </div>
                        <button class="${voteClass}" data-id="${req.id}">
                            ‚ñ≤ <span>${req.votes || 0}</span>
                        </button>
                    `;
                    generalRequestsList.appendChild(el);
                    el.querySelector('button').addEventListener('click', handleVote);
                });
            });
        }
        
        async function handleVote(e) {
            e.preventDefault(); 
            const btn = e.currentTarget;
            const id = btn.dataset.id;
            const user = auth.currentUser;
            if (!user) { await signInAnonymously(auth); }
            const ref = doc(db, `artifacts/${appId}/public/data/general-requests`, id);
            const isVoted = !!userVotes[id];
            try {
                await runTransaction(db, async (t) => {
                    const docSnap = await t.get(ref);
                    if(!docSnap.exists()) return;
                    const current = docSnap.data().votes || 0;
                    const newVotes = isVoted ? (current > 0 ? current - 1 : 0) : current + 1;
                    t.update(ref, { votes: newVotes });
                });
                if(isVoted) delete userVotes[id]; else userVotes[id] = true;
                localStorage.setItem('userVotes', JSON.stringify(userVotes));
            } catch(err) { console.error("Vote error", err); }
        }

    </script>
</body>
</html>